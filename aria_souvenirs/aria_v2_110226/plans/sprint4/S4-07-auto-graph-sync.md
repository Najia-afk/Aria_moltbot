# S4-07: Auto-Sync Skill Graph on Startup
**Epic:** E8 — Knowledge Graph | **Priority:** P1 | **Points:** 3 | **Phase:** 3

## Problem
The skill graph (S4-01) is generated by a manual script. When skills change (new skill added, skill removed, tool added), the graph becomes stale. It should auto-regenerate.

## Root Cause
No integration between the skill graph generator and the API startup or skill loading process.

## Fix

### Option A: Run on API startup (preferred)
**File: `src/api/main.py`**
Add to the startup event:
```python
@app.on_event("startup")
async def startup_event():
    # ... existing startup ...
    # Auto-sync skill graph
    from graph_sync import sync_skill_graph
    await sync_skill_graph()
```

### Option B: Cron job
Add to `aria_mind/cron_jobs.yaml`:
```yaml
- name: sync_skill_graph
  schedule: "0 */6 * * *"  # Every 6 hours
  action: python scripts/generate_skill_graph.py
```

### Better: Create an API endpoint
**File: `src/api/routers/knowledge.py`**
```python
@router.post("/knowledge-graph/sync-skills")
async def sync_skill_graph(db: AsyncSession = Depends(get_db)):
    """Regenerate skill graph from skill.json files. Idempotent."""
    from graph_sync import sync_skill_graph_db
    result = await sync_skill_graph_db(db)
    return result
```

Create `src/api/graph_sync.py` that does the same as the script but using SQLAlchemy directly (since it's in the API layer, this is correct per 5-layer rule).

## Constraints
| # | Constraint | Applies | Notes |
|---|-----------|---------|-------|
| 1 | 5-layer | ✅ | graph_sync.py lives in API layer, uses ORM |
| 2 | .env secrets | ❌ | No secrets |
| 3 | models.yaml | ❌ | No model names |
| 4 | Docker-first | ✅ | Runs on API startup |
| 5 | aria_memories | ❌ | DB writes |
| 6 | No soul mod | ❌ | No soul files |

## Dependencies
- **S4-01** (initial graph generation script — reference implementation)

## Verification
```bash
# 1. graph_sync.py exists:
ls src/api/graph_sync.py
# EXPECTED: exists

# 2. Sync endpoint works:
curl -s -X POST http://localhost:8000/api/knowledge-graph/sync-skills
# EXPECTED: {"synced": true, "entities": N, "relations": M}

# 3. Idempotent — run twice, same result:
count1=$(curl -s http://localhost:8000/api/knowledge-graph/entities?type=skill | python3 -c "import sys,json; print(len(json.load(sys.stdin).get('entities',[])))")
curl -s -X POST http://localhost:8000/api/knowledge-graph/sync-skills > /dev/null
count2=$(curl -s http://localhost:8000/api/knowledge-graph/entities?type=skill | python3 -c "import sys,json; print(len(json.load(sys.stdin).get('entities',[])))")
[ "$count1" = "$count2" ] && echo "Idempotent: $count1 == $count2" || echo "NOT idempotent: $count1 != $count2"
```

## Prompt for Agent
```
Create auto-sync for the skill knowledge graph.

FILES TO READ:
- scripts/generate_skill_graph.py (S4-01 — reference)
- src/api/main.py (startup event)
- src/api/routers/knowledge.py (add sync endpoint)
- aria_skills/*/skill.json (skill data source)

STEPS:
1. Create src/api/graph_sync.py (ORM-based graph sync)
2. Add POST /knowledge-graph/sync-skills endpoint
3. Call sync on API startup
4. Ensure idempotent (clear + recreate)
5. Run verification

CONSTRAINTS: API layer can use SQLAlchemy directly (correct layer). Idempotent.
```
