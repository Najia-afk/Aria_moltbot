name: tests

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:
  test-baseline:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run full test suite
        run: |
          pytest tests -ra --junitxml=test-results-baseline.xml

      - name: Generate API test coverage audit
        run: |
          python - << 'PY'
          import re
          from pathlib import Path

          root = Path('.')
          route_files = list((root / 'src' / 'api' / 'routers').glob('*.py')) + [root / 'src' / 'api' / 'main.py']

          routes = []
          for fp in route_files:
            if not fp.exists():
              continue
            text = fp.read_text(encoding='utf-8', errors='ignore')

            prefix_map = {}
            for m in re.finditer(r"(\w+)\s*=\s*APIRouter\((.*?)\)", text, re.S):
              var = m.group(1)
              args = m.group(2)
              pm = re.search(r"prefix\s*=\s*['\"]([^'\"]*)['\"]", args)
              prefix_map[var] = pm.group(1) if pm else ''

            for m in re.finditer(r"@(\w+)\.(get|post|put|patch|delete|websocket)\(\s*['\"]([^'\"]*)['\"]", text, re.I):
              var, method, path = m.group(1), m.group(2).upper(), m.group(3)
              prefix = prefix_map.get(var, '')
              full = (prefix + path) if path else (prefix or '/')
              if not full.startswith('/'):
                full = '/' + full
              routes.append({'file': str(fp).replace('\\', '/'), 'method': method, 'path': full})

            for m in re.finditer(r"@app\.(get|post|put|patch|delete|websocket)\(\s*['\"]([^'\"]+)['\"]", text, re.I):
              method, path = m.group(1).upper(), m.group(2)
              routes.append({'file': str(fp).replace('\\', '/'), 'method': method, 'path': path if path.startswith('/') else '/' + path})

          uniq = {}
          for r in routes:
            uniq[(r['method'], r['path'])] = r
          routes = sorted(uniq.values(), key=lambda x: (x['path'], x['method']))

          test_files = list((root / 'tests').rglob('test_*.py'))
          test_calls = []
          for tf in test_files:
            txt = tf.read_text(encoding='utf-8', errors='ignore')
            for m in re.finditer(r"\b(api|web)\.(get|post|put|patch|delete)\(\s*f?['\"]([^'\"]+)['\"]", txt):
              test_calls.append({'file': str(tf).replace('\\', '/'), 'method': m.group(2).upper(), 'path': m.group(3)})

          call_map = {}
          for c in test_calls:
            call_map.setdefault((c['method'], c['path']), []).append(c['file'])

          coverage = []
          for r in routes:
            method, path = r['method'], r['path']
            covered_by = set(call_map.get((method, path), []))
            rgx = re.compile('^' + re.sub(r"\\\{[^}]+\\\}", "[^/]+", re.escape(path)) + '$')
            for (m, p), files in call_map.items():
              if m == method and rgx.match(p):
                covered_by.update(files)
            if method == 'WEBSOCKET':
              for tf in test_files:
                txt = tf.read_text(encoding='utf-8', errors='ignore')
                if '/ws/chat/' in path and '/ws/chat/' in txt:
                  covered_by.add(str(tf).replace('\\', '/'))
            coverage.append({'method': method, 'path': path, 'covered': bool(covered_by)})

          total = len(coverage)
          covered = sum(1 for x in coverage if x['covered'])
          pct = round((covered / total * 100.0), 2) if total else 0

          out = root / 'docs' / 'TEST_COVERAGE_AUDIT.md'
          out.parent.mkdir(parents=True, exist_ok=True)
          out.write_text(
            "\n".join([
              '# API Test Coverage Audit',
              '',
              f'- Total routes: **{total}**',
              f'- Covered routes: **{covered}**',
              f'- Uncovered routes: **{total - covered}**',
              f'- Coverage: **{pct}%**',
            ]),
            encoding='utf-8',
          )
          print(f'Wrote {out}')
          PY

      - name: Upload coverage audit artifact
        uses: actions/upload-artifact@v4
        with:
          name: baseline-api-test-coverage-audit
          path: docs/TEST_COVERAGE_AUDIT.md
          if-no-files-found: error

      - name: Upload baseline JUnit report
        uses: actions/upload-artifact@v4
        with:
          name: baseline-junit-report
          path: test-results-baseline.xml
          if-no-files-found: error

  test-external-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      ARIA_TEST_API_URL: ${{ secrets.ARIA_TEST_API_URL }}
      ARIA_TEST_WEB_URL: ${{ secrets.ARIA_TEST_WEB_URL }}
      ARIA_ADMIN_TOKEN: ${{ secrets.ARIA_ADMIN_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Precheck external integration secrets
        id: precheck
        run: |
          if [ -n "${{ secrets.ARIA_TEST_API_URL }}" ]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "External integration secrets missing; skipping external integration job steps."
          fi

      - name: Setup Python
        if: steps.precheck.outputs.enabled == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        if: steps.precheck.outputs.enabled == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run external integration suite
        if: steps.precheck.outputs.enabled == 'true'
        run: |
          pytest tests -ra --junitxml=test-results-external.xml

      - name: Generate API test coverage audit
        if: steps.precheck.outputs.enabled == 'true'
        run: |
          python - << 'PY'
          from pathlib import Path
          out = Path('docs/TEST_COVERAGE_AUDIT.md')
          if not out.exists():
            out.parent.mkdir(parents=True, exist_ok=True)
            out.write_text('# API Test Coverage Audit\n\n- Generated in external integration job.\n', encoding='utf-8')
          print(f'Using {out}')
          PY

      - name: Upload coverage audit artifact
        if: steps.precheck.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: external-api-test-coverage-audit
          path: docs/TEST_COVERAGE_AUDIT.md
          if-no-files-found: error

      - name: Upload external JUnit report
        if: steps.precheck.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: external-junit-report
          path: test-results-external.xml
          if-no-files-found: error