# ─────────────────────────────────────────────────────────────────────────────
# Aria CI — unit, E2E & load tests  (S-30)
# ─────────────────────────────────────────────────────────────────────────────
name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ── Unit + integration tests ──────────────────────────────────────────────
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: aria
          POSTGRES_PASSWORD: aria_ci
          POSTGRES_DB: aria_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U aria"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    env:
      DATABASE_URL: postgresql+asyncpg://aria:aria_ci@localhost:5432/aria_test
      ARIA_ENV: test

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"

      - name: Run unit tests
        run: |
          pytest tests/ \
            --ignore=tests/e2e \
            --ignore=tests/load \
            -x -q \
            --tb=short \
            --timeout=60 \
            -v

  # ── End-to-end browser tests ──────────────────────────────────────────────
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"

      - name: Install Playwright browsers
        run: playwright install --with-deps chromium

      - name: Start services
        run: |
          cp stacks/brain/.env.example stacks/brain/.env
          docker compose -f stacks/brain/docker-compose.yml up -d
          # Wait for health endpoint
          for i in $(seq 1 30); do
            curl -sf http://localhost:5050/health && break
            echo "Waiting for services… ($i/30)"
            sleep 5
          done

      - name: Run E2E tests
        run: |
          pytest tests/e2e/ \
            -v \
            --timeout=120 \
            --tb=short

      - name: Run web/API path guardrail
        run: |
          python scripts/guardrail_web_api_path.py

      - name: Stop services
        if: always()
        run: docker compose -f stacks/brain/docker-compose.yml down -v

  # ── Load test (smoke, small scale) ────────────────────────────────────────
  load-smoke:
    name: Load Smoke Test
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Start services
        run: |
          cp stacks/brain/.env.example stacks/brain/.env
          docker compose -f stacks/brain/docker-compose.yml up -d
          for i in $(seq 1 30); do
            curl -sf http://localhost:5050/health && break
            sleep 5
          done

      - name: Run load smoke test (5 users, 30s)
        run: |
          USERS=5 RATE=1 DURATION=30s bash scripts/run-load-test.sh

      - name: Run web/API path guardrail
        run: |
          python scripts/guardrail_web_api_path.py

      - name: Upload load test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-report
          path: tests/load/report.html

      - name: Stop services
        if: always()
        run: docker compose -f stacks/brain/docker-compose.yml down -v
