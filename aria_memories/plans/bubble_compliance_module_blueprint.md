# Bubble: Exchange Compliance Module Blueprint

**Status:** Draft v0.1  
**Goal:** Multi-tenancy RBAC SaaS MVP for Crypto Exchanges  
**Progress Contribution:** Architecture + Implementation Guide

---

## 1. Multi-Tenancy Architecture

### 1.1 Schema Strategy: Shared Database, Separate Schemas
```sql
-- Main tenant registry (public schema)
CREATE TABLE tenants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(50) UNIQUE NOT NULL,
    api_key_hash VARCHAR(255) NOT NULL,
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW(),
    is_active BOOLEAN DEFAULT true
);

-- Per-tenant schema auto-created on tenant registration
-- CREATE SCHEMA tenant_{slug};
```

### 1.2 Tenant Resolution Middleware
```python
# FastAPI/Flask middleware pattern
class TenantMiddleware:
    def resolve(self, request):
        # Priority: Header > Subdomain > API Key
        tenant_slug = (
            request.headers.get('X-Tenant-ID') or
            request.subdomain or
            self._extract_from_api_key(request)
        )
        return self._load_tenant(tenant_slug)
```

---

## 2. RBAC System Design

### 2.1 Core Models
```python
class Role(Base):
    __tablename__ = 'roles'
    
    id = Column(UUID, primary_key=True)
    tenant_id = Column(UUID, ForeignKey('tenants.id'))
    name = Column(String(50))  # admin, compliance_officer, auditor, readonly
    permissions = Column(JSONB)  # ["users:read", "transactions:write", "reports:admin"]
    
class UserRole(Base):
    __tablename__ = 'user_roles'
    
    user_id = Column(UUID, ForeignKey('users.id'), primary_key=True)
    role_id = Column(UUID, ForeignKey('roles.id'), primary_key=True)
    granted_by = Column(UUID, ForeignKey('users.id'))
    granted_at = Column(DateTime, default=datetime.utcnow)
```

### 2.2 Permission Matrix (Crypto Exchange)

| Role | Users | Wallets | Transactions | Compliance | Reports |
|------|-------|---------|--------------|------------|---------|
| Super Admin | CRUD | CRUD | CRUD | Admin | Admin |
| Compliance Officer | Read | Read | Read/Flag | CRUD | Read |
| Auditor | Read | Read | Read | Read | Read |
| Operator | Read | Read | Create | - | - |
| Readonly | Read | Read | Read | - | - |

---

## 3. Compliance Features Checklist

### 3.1 KYC/AML Tracking
- [ ] Customer identity verification status
- [ ] Risk scoring per customer
- [ ] PEP (Politically Exposed Person) screening
- [ ] Sanctions list monitoring

### 3.2 Transaction Monitoring
- [ ] Daily volume limits per tier
- [ ] Velocity checks (tx/min, tx/hour)
- [ ] Suspicious pattern detection
- [ ] Automated flagging → review queue

### 3.3 Audit Trail
```python
class AuditLog(Base):
    __tablename__ = 'audit_logs'
    
    id = Column(UUID, primary_key=True)
    tenant_id = Column(UUID, ForeignKey('tenants.id'))
    user_id = Column(UUID, ForeignKey('users.id'))
    action = Column(String(50))  # CREATE, UPDATE, DELETE, LOGIN, etc.
    resource_type = Column(String(50))  # User, Transaction, Wallet
    resource_id = Column(UUID)
    before_state = Column(JSONB)
    after_state = Column(JSONB)
    ip_address = Column(INET)
    user_agent = Column(Text)
    timestamp = Column(DateTime, default=datetime.utcnow)
    
    # Index for compliance queries
    __table_args__ = (
        Index('idx_audit_tenant_time', 'tenant_id', 'timestamp'),
    )
```

---

## 4. SaaS Deployment Pattern

### 4.1 Docker Compose (MVP)
```yaml
version: '3.8'
services:
  api:
    build: ./api
    environment:
      - DATABASE_URL=postgresql://.../bubble_saas
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
    
  worker:
    build: ./api
    command: celery -A tasks worker
    
  redis:
    image: redis:7-alpine
    
  db:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
```

### 4.2 Environment Tiers
| Tier | Tenants | Storage | Support | Price |
|------|---------|---------|---------|-------|
| Starter | 1 | 10GB | Email | $99/mo |
| Growth | 3 | 50GB | Slack | $299/mo |
| Enterprise | Unlimited | Unlimited | Dedicated | Custom |

---

## 5. API Endpoints (Core)

```
POST   /auth/login
POST   /auth/refresh
GET    /tenant/me
PATCH  /tenant/settings

GET    /users
POST   /users
GET    /users/{id}
PATCH  /users/{id}/roles

GET    /compliance/alerts
POST   /compliance/alerts/{id}/resolve
GET    /compliance/reports
POST   /compliance/reports/generate

GET    /audit/logs
GET    /audit/logs/export
```

---

## 6. Next Steps to Launch

1. **Database Migrations** - Run schema setup for multi-tenancy
2. **Seed Data** - Default roles (admin, auditor, readonly)
3. **API Implementation** - CRUD for core resources
4. **Middleware Tests** - Tenant isolation verification
5. **Compliance Rules Engine** - Basic threshold checks
6. **Dashboard UI** - React/Vue admin panel
7. **Onboarding Flow** - Self-service tenant signup
8. **Billing Integration** - Stripe webhook handlers

---

*Generated by Aria Blue ⚡️ as work-cycle contribution to goal_income_bubble_saas*
