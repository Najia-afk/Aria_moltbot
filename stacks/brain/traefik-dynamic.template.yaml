# Traefik Dynamic Configuration - HTTP & HTTPS routes
tls:
  stores:
    default:
      defaultCertificate:
        certFile: /certs/cert.pem
        keyFile: /certs/key.pem
  certificates:
    - certFile: /certs/cert.pem
      keyFile: /certs/key.pem

http:
  routers:
    # HTTP Routers (fast LAN access)
    
    portal-http:
      rule: "PathPrefix(`/`)"
      priority: 1
      entryPoints:
        - web
      service: portal
      middlewares:
        - secure-headers

    # Traefik internal API - dashboard JS calls /api/overview, /api/http/*, etc.
    traefik-api-http:
      rule: "Path(`/api/overview`) || Path(`/api/entrypoints`) || Path(`/api/version`) || Path(`/api/rawdata`) || PathPrefix(`/api/http/`) || PathPrefix(`/api/tcp/`) || PathPrefix(`/api/udp/`)"
      priority: 110
      entryPoints:
        - web
      service: api@internal

    ws-http:
      rule: "PathPrefix(`/ws`)"
      priority: 100
      entryPoints:
        - web
      service: aria-api
      middlewares:
        - secure-headers-ws

    api-http:
      rule: "PathPrefix(`/api/`) || Path(`/api`)"
      priority: 100
      entryPoints:
        - web
      service: aria-api
      middlewares:
        - api-auth-inject
        - api-strip
        - secure-headers

    grafana-http:
      rule: "PathPrefix(`/grafana`)"
      priority: 80
      entryPoints:
        - web
      service: grafana
      middlewares:
        - secure-headers


    prometheus-http:
      rule: "PathPrefix(`/prometheus`)"
      priority: 80
      entryPoints:
        - web
      service: prometheus

    pgadmin-http:
      rule: "PathPrefix(`/pgadmin`)"
      priority: 80
      entryPoints:
        - web
      service: pgadmin

    ollama-http:
      rule: "PathPrefix(`/ollama`)"
      priority: 80
      entryPoints:
        - web
      service: ollama
      middlewares:
        - ollama-strip

    litellm-proxy-http:
      rule: "PathPrefix(`/litellm-proxy`)"
      priority: 80
      entryPoints:
        - web
      service: litellm
      middlewares:
        - litellm-proxy-strip

    traefik-dashboard-http:
      rule: "PathPrefix(`/traefik`)"
      priority: 70
      entryPoints:
        - web
      service: api@internal
      middlewares:
        - traefik-strip
        - traefik-auth

    # HTTPS Routers (secure access)
    
    portal:
      rule: "PathPrefix(`/`)"
      priority: 1
      entryPoints:
        - websecure
      service: portal
      middlewares:
        - secure-headers
      tls: {}

    # Traefik internal API - dashboard JS calls /api/overview, /api/http/*, etc.
    traefik-api:
      rule: "Path(`/api/overview`) || Path(`/api/entrypoints`) || Path(`/api/version`) || Path(`/api/rawdata`) || PathPrefix(`/api/http/`) || PathPrefix(`/api/tcp/`) || PathPrefix(`/api/udp/`)"
      priority: 110
      entryPoints:
        - websecure
      service: api@internal
      tls: {}

    ws:
      rule: "PathPrefix(`/ws`)"
      priority: 100
      entryPoints:
        - websecure
      service: aria-api
      middlewares:
        - secure-headers-ws
      tls: {}

    api:
      rule: "PathPrefix(`/api/`) || Path(`/api`)"
      priority: 100
      entryPoints:
        - websecure
      service: aria-api
      middlewares:
        - api-auth-inject
        - api-strip
        - secure-headers
      tls: {}

    grafana:
      rule: "PathPrefix(`/grafana`)"
      priority: 80
      entryPoints:
        - websecure
      service: grafana
      middlewares:
        - secure-headers
      tls: {}

    prometheus:
      rule: "PathPrefix(`/prometheus`)"
      priority: 80
      entryPoints:
        - websecure
      service: prometheus
      tls: {}

    pgadmin:
      rule: "PathPrefix(`/pgadmin`)"
      priority: 80
      entryPoints:
        - websecure
      service: pgadmin
      tls: {}

    ollama:
      rule: "PathPrefix(`/ollama`)"
      priority: 80
      entryPoints:
        - websecure
      service: ollama
      middlewares:
        - ollama-strip
      tls: {}

    litellm-proxy:
      rule: "PathPrefix(`/litellm-proxy`)"
      priority: 80
      entryPoints:
        - websecure
      service: litellm
      middlewares:
        - litellm-proxy-strip
      tls: {}

    traefik-dashboard:
      rule: "PathPrefix(`/traefik`)"
      priority: 70
      entryPoints:
        - websecure
      service: api@internal
      middlewares:
        - traefik-strip
        - traefik-auth
      tls: {}

  middlewares:
    api-auth-inject:
      headers:
        customRequestHeaders:
          X-API-Key: "${ARIA_API_KEY}"

    api-strip:
      stripPrefix:
        prefixes:
          - /api
    grafana-strip:
      stripPrefix:
        prefixes:
          - /grafana
    prometheus-strip:
      stripPrefix:
        prefixes:
          - /prometheus
    pgadmin-strip:
      stripPrefix:
        prefixes:
          - /pgadmin
    ollama-strip:
      stripPrefix:
        prefixes:
          - /ollama
    litellm-proxy-strip:
      stripPrefix:
        prefixes:
          - /litellm-proxy
    traefik-strip:
      stripPrefix:
        prefixes:
          - /traefik
    socketio-strip:
      stripPrefix:
        prefixes:
          - /socket.io

    # CORS Only (Safe for WebSockets)
    # S-109: Restricted CORS origins (no wildcard *)
    cors-only:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - "*"
        accessControlAllowOriginList: 
          - "http://localhost:5000"
          - "http://localhost:5050"
          - "http://aria-web:5000"
          - "https://${SERVICE_HOST}"
        accessControlMaxAge: 100
        addVaryHeader: true

    # Security Headers for Websockets (No Keep-Alive)
    # S-109: Restricted CORS origins
    secure-headers-ws:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - "*"
        accessControlAllowOriginList: 
          - "http://localhost:5000"
          - "http://localhost:5050"
          - "http://aria-web:5000"
          - "https://${SERVICE_HOST}"
        accessControlMaxAge: 100
        addVaryHeader: true
        contentTypeNosniff: true
        browserXssFilter: true

    # Security Headers for Standard HTTP (With Keep-Alive for stability)
    # S-109: Restricted CORS origins
    secure-headers:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - "*"
        accessControlAllowOriginList: 
          - "http://localhost:5000"
          - "http://localhost:5050"
          - "http://aria-web:5000"
          - "https://${SERVICE_HOST}"
        accessControlMaxAge: 100
        addVaryHeader: true
        contentTypeNosniff: true
        browserXssFilter: true
        # Helps with "Network Changed" / stalled connection issues
        customResponseHeaders:
          Connection: "keep-alive"
          Keep-Alive: "timeout=5, max=1000"

    # S-107: Basic auth for Traefik dashboard
    traefik-auth:
      basicAuth:
        users:
          - "${TRAEFIK_DASHBOARD_USER}:${TRAEFIK_DASHBOARD_PASSWORD_HASH}"

  services:
    portal:
      loadBalancer:
        servers:
          - url: "http://aria-web:5000"
    aria-api:
      loadBalancer:
        servers:
          - url: "http://aria-api:8000"
    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"
    prometheus:
      loadBalancer:
        servers:
          - url: "http://prometheus:9090"
    pgadmin:
      loadBalancer:
        servers:
          - url: "http://aria-pgadmin:80"
    ollama:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:11434"
    litellm:
      loadBalancer:
        servers:
          - url: "http://litellm:4000"
