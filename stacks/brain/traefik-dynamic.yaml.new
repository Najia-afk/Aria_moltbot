# Traefik Dynamic Configuration - HTTP & HTTPS routes
# Generic configuration for any deployment - uses SERVICE_HOST environment variable

tls:
  stores:
    default:
      defaultCertificate:
        certFile: /certs/cert.pem
        keyFile: /certs/key.pem
  certificates:
    - certFile: /certs/cert.pem
      keyFile: /certs/key.pem

http:
  routers:
    # ========================================
    # HTTP Routers (redirect to HTTPS in production)
    # ========================================
    
    # HTTP to HTTPS redirect (enable in production)
    # http-catchall:
    #   rule: "HostRegexp(`.*`)"
    #   entryPoints:
    #     - web
    #   middlewares:
    #     - redirect-to-https
    #   service: noop@internal

    # WebSocket at root - highest priority for WS upgrades
    clawdbot-ws-http:
      rule: "PathPrefix(`/`) && HeadersRegexp(`Connection`, `(?i)upgrade`) && HeadersRegexp(`Upgrade`, `(?i)websocket`)"
      priority: 100
      entryPoints:
        - web
      service: clawdbot
      middlewares:
        - websocket-headers

    # Main portal - lowest priority (catch-all)
    portal-http:
      rule: "PathPrefix(`/`)"
      priority: 1
      entryPoints:
        - web
      service: portal
      middlewares:
        - secure-headers
        - cors-all

    # API routes
    api-http:
      rule: "PathPrefix(`/api`)"
      priority: 90
      entryPoints:
        - web
      service: aria-api
      middlewares:
        - api-strip
        - secure-headers
        - cors-all

    # Clawdbot UI and WebSocket
    clawdbot-http:
      rule: "PathPrefix(`/clawdbot`)"
      priority: 85
      entryPoints:
        - web
      service: clawdbot
      middlewares:
        - websocket-headers
        - cors-all

    # Grafana
    grafana-http:
      rule: "PathPrefix(`/grafana`)"
      priority: 80
      entryPoints:
        - web
      service: grafana
      middlewares:
        - secure-headers

    # Prometheus
    prometheus-http:
      rule: "PathPrefix(`/prometheus`)"
      priority: 80
      entryPoints:
        - web
      service: prometheus

    # PgAdmin
    pgadmin-http:
      rule: "PathPrefix(`/pgadmin`)"
      priority: 80
      entryPoints:
        - web
      service: pgadmin

    # Ollama API proxy
    ollama-http:
      rule: "PathPrefix(`/ollama`)"
      priority: 80
      entryPoints:
        - web
      service: ollama
      middlewares:
        - ollama-strip

    # LiteLLM API proxy
    litellm-http:
      rule: "PathPrefix(`/litellm`)"
      priority: 80
      entryPoints:
        - web
      service: litellm
      middlewares:
        - litellm-strip

    # Traefik Dashboard
    traefik-dashboard-http:
      rule: "PathPrefix(`/traefik`)"
      priority: 70
      entryPoints:
        - web
      service: api@internal
      middlewares:
        - traefik-strip

    # ========================================
    # HTTPS Routers (Secure)
    # ========================================
    
    # WebSocket at root - highest priority for WS upgrades
    clawdbot-ws:
      rule: "PathPrefix(`/`) && HeadersRegexp(`Connection`, `(?i)upgrade`) && HeadersRegexp(`Upgrade`, `(?i)websocket`)"
      priority: 100
      entryPoints:
        - websecure
      service: clawdbot
      middlewares:
        - websocket-headers
      tls: {}

    # Main portal
    portal:
      rule: "PathPrefix(`/`)"
      priority: 1
      entryPoints:
        - websecure
      service: portal
      middlewares:
        - secure-headers
        - cors-all
      tls: {}

    # API
    api:
      rule: "PathPrefix(`/api`)"
      priority: 90
      entryPoints:
        - websecure
      service: aria-api
      middlewares:
        - api-strip
        - secure-headers
        - cors-all
      tls: {}

    # Clawdbot HTTPS
    clawdbot:
      rule: "PathPrefix(`/clawdbot`)"
      priority: 85
      entryPoints:
        - websecure
      service: clawdbot
      middlewares:
        - websocket-headers
        - cors-all
      tls: {}

    # Grafana
    grafana:
      rule: "PathPrefix(`/grafana`)"
      priority: 80
      entryPoints:
        - websecure
      service: grafana
      middlewares:
        - secure-headers
      tls: {}

    # Prometheus
    prometheus:
      rule: "PathPrefix(`/prometheus`)"
      priority: 80
      entryPoints:
        - websecure
      service: prometheus
      tls: {}

    # PgAdmin
    pgadmin:
      rule: "PathPrefix(`/pgadmin`)"
      priority: 80
      entryPoints:
        - websecure
      service: pgadmin
      tls: {}

    # Ollama
    ollama:
      rule: "PathPrefix(`/ollama`)"
      priority: 80
      entryPoints:
        - websecure
      service: ollama
      middlewares:
        - ollama-strip
      tls: {}

    # LiteLLM
    litellm:
      rule: "PathPrefix(`/litellm`)"
      priority: 80
      entryPoints:
        - websecure
      service: litellm
      middlewares:
        - litellm-strip
      tls: {}

    # Traefik Dashboard
    traefik-dashboard:
      rule: "PathPrefix(`/traefik`)"
      priority: 70
      entryPoints:
        - websecure
      service: api@internal
      middlewares:
        - traefik-strip
      tls: {}

  # ========================================
  # Middlewares
  # ========================================
  middlewares:
    # Strip prefixes
    api-strip:
      stripPrefix:
        prefixes:
          - /api

    ollama-strip:
      stripPrefix:
        prefixes:
          - /ollama

    litellm-strip:
      stripPrefix:
        prefixes:
          - /litellm

    traefik-strip:
      stripPrefix:
        prefixes:
          - /traefik

    # HTTP to HTTPS redirect
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true

    # WebSocket-friendly headers - critical for clawdbot
    websocket-headers:
      headers:
        # CORS for WebSocket
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
          - CONNECT
        accessControlAllowHeaders:
          - "*"
        accessControlAllowOriginList:
          - "*"
        accessControlMaxAge: 100
        addVaryHeader: true
        # Forward original protocol
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        # Don't interfere with WebSocket upgrade
        customResponseHeaders:
          X-Content-Type-Options: "nosniff"

    # CORS for all origins (needed for development/LAN access)
    cors-all:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
          - PATCH
        accessControlAllowHeaders:
          - "*"
        accessControlAllowOriginList:
          - "*"
        accessControlAllowCredentials: true
        accessControlMaxAge: 100
        addVaryHeader: true

    # Security headers for standard HTTP
    secure-headers:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - "*"
        accessControlAllowOriginList:
          - "*"
        accessControlMaxAge: 100
        addVaryHeader: true
        # Security headers
        contentTypeNosniff: true
        browserXssFilter: true
        frameDeny: false
        # Connection keep-alive
        customResponseHeaders:
          Connection: "keep-alive"
          Keep-Alive: "timeout=5, max=1000"

    # Rate limiting for API (optional - uncomment to enable)
    # rate-limit:
    #   rateLimit:
    #     average: 100
    #     burst: 50

  # ========================================
  # Services
  # ========================================
  services:
    portal:
      loadBalancer:
        servers:
          - url: "http://aria-web:5000"
        healthCheck:
          path: "/"
          interval: "30s"
          timeout: "3s"

    aria-api:
      loadBalancer:
        servers:
          - url: "http://aria-api:8000"
        healthCheck:
          path: "/health"
          interval: "30s"
          timeout: "3s"

    clawdbot:
      loadBalancer:
        servers:
          - url: "http://clawdbot:18789"
        # Sticky sessions for WebSocket
        sticky:
          cookie:
            name: clawdbot_session
            secure: true
            httpOnly: true

    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"

    prometheus:
      loadBalancer:
        servers:
          - url: "http://prometheus:9090"

    pgadmin:
      loadBalancer:
        servers:
          - url: "http://aria-pgadmin:80"

    # Ollama - uses DOCKER_HOST_IP from environment
    # Default: host.docker.internal:11434
    ollama:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:11434"

    litellm:
      loadBalancer:
        servers:
          - url: "http://litellm:4000"
