{% extends "base.html" %}
{% block title %}Creative Pulse{% endblock %}

{% block extra_css %}
<style>
    .page-controls { display:flex; gap:12px; margin-bottom:18px; flex-wrap:wrap; align-items:center; }
    .filter-select { padding:10px 14px; background: var(--bg-secondary); border:1px solid var(--border-color); border-radius:8px; color: var(--text-primary); font-size:13px; }
    .stats-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:14px; margin-bottom:20px; }
    .stat-card { background: var(--bg-secondary); border:1px solid var(--border-color); border-radius:10px; padding:16px; }
    .stat-card h4 { margin:0 0 6px; font-size:11px; text-transform: uppercase; color: var(--text-muted); }
    .stat-card .value { font-size:24px; font-weight:700; color:var(--text-primary); }
    .chart-grid { display:grid; grid-template-columns: 1fr 1fr; gap:18px; margin-bottom:20px; }
    .chart-card { background: var(--bg-secondary); border:1px solid var(--border-color); border-radius:12px; padding:16px; }
    .chart-card h4 { margin:0 0 10px; font-size:13px; color:var(--text-secondary); }
    .chart-card canvas { max-height:280px; }
    .chart-empty {
        min-height: 220px;
        border: 1px dashed var(--border-color);
        border-radius: 10px;
        display: none;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: 13px;
    }
    .chart-empty.visible { display: flex; }
    .data-table { width:100%; background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:12px; border-collapse: collapse; overflow:hidden; }
    .data-table th, .data-table td { padding:10px 12px; font-size:13px; text-align:left; border-bottom:1px solid var(--border-color); }
    .data-table th { font-size:11px; text-transform:uppercase; color:var(--text-secondary); background: rgba(0,0,0,0.2); }
    .expand-btn { padding:4px 8px; font-size:11px; border:1px solid var(--border-color); border-radius:8px; background: transparent; color: var(--text-secondary); cursor:pointer; }
    .expand-btn:hover { color: var(--text-primary); border-color: var(--text-secondary); }
    .detail-row { display: none; }
    .detail-row.open { display: table-row; }
    .detail-cell { background: rgba(0, 0, 0, 0.15); padding: 12px !important; }
    .detail-grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    .detail-block { border:1px solid var(--border-color); border-radius:8px; padding:10px; background: var(--bg-tertiary); }
    .detail-block h5 { margin:0 0 8px; font-size:11px; text-transform: uppercase; color: var(--text-muted); }
    .detail-pre { margin:0; font-size:11px; color:var(--text-secondary); white-space:pre-wrap; word-break: break-word; max-height: 160px; overflow: auto; }
    .status-pill { display:inline-block; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:700; }
    .status-pill.ok { background: rgba(34,197,94,0.2); color: var(--success); }
    .status-pill.err { background: rgba(239,68,68,0.2); color: var(--danger); }
    .sync-meta { margin-left:auto; font-size:12px; color:var(--text-muted); }
    .insight-grid { display:grid; grid-template-columns: 1fr 1fr; gap:18px; margin-bottom:20px; }
    .insight-card { background: var(--bg-secondary); border:1px solid var(--border-color); border-radius:12px; padding:16px; min-height:140px; }
    .insight-card h4 { margin:0 0 10px; font-size:13px; color:var(--text-secondary); }
    .insight-main { font-weight:600; color:var(--text-primary); margin-bottom:8px; }
    .insight-meta { font-size:12px; color:var(--text-muted); margin-top:6px; }
    .context-chip { display:inline-block; font-size:11px; margin:2px 4px 0 0; padding:2px 8px; border-radius:10px; border:1px solid var(--border-color); color:var(--text-secondary); }
    @media (max-width: 900px) {
        .chart-grid, .insight-grid { grid-template-columns: 1fr; }
        .detail-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‚ú® Creative Pulse</h1>
    <p>Creativity-focused activity view for brainstorm, experiment, community, fact-check, and memeothy.</p>
    <p style="margin-top:6px; color:var(--text-muted); font-size:12px;">Note: Global system-wide activity charts remain in Activities/Sessions; this view is creativity-only by design.</p>
</div>

<div class="page-controls">
    <select id="hours-filter" class="filter-select">
        <option value="6">Last 6 Hours</option>
        <option value="12">Last 12 Hours</option>
        <option value="24" selected>Last 24 Hours</option>
        <option value="72">Last 3 Days</option>
    </select>
    <button class="btn btn-primary" onclick="loadCreativePulse()">Refresh</button>
    <span id="sync-meta" class="sync-meta">Data sync: ‚Äî</span>
</div>

<div class="stats-grid">
    <div class="stat-card"><h4>Creative Skill Events</h4><div id="stat-creative" class="value">-</div></div>
    <div class="stat-card"><h4>Creative Success</h4><div id="stat-creative-success" class="value">-</div></div>
    <div class="stat-card"><h4>Creative Fail</h4><div id="stat-creative-fail" class="value">-</div></div>
    <div class="stat-card"><h4>Creative Success Rate</h4><div id="stat-creative-rate" class="value">-</div></div>
</div>

<div class="insight-grid">
    <div class="insight-card">
        <h4>üí° Current Brainstorm Focus</h4>
        <div id="insight-brainstorm-main" class="insight-main">No brainstorm context yet.</div>
        <div id="insight-brainstorm-meta" class="insight-meta">Run `brainstorm.start_session` to populate this card.</div>
    </div>
    <div class="insight-card">
        <h4>üß™ Current Experiment Focus</h4>
        <div id="insight-experiment-main" class="insight-main">No experiment context yet.</div>
        <div id="insight-experiment-meta" class="insight-meta">Run `experiment.create_experiment` to populate this card.</div>
    </div>
</div>

<div class="chart-grid">
    <div class="chart-card" id="hourly-card">
        <h4>‚è±Ô∏è Creative Activity by Hour</h4>
        <canvas id="hourly-chart"></canvas>
        <div id="hourly-empty" class="chart-empty">No creative hourly activity in selected window.</div>
    </div>
    <div class="chart-card" id="actions-card">
        <h4>üéØ Creative Top Actions</h4>
        <canvas id="actions-chart"></canvas>
        <div id="actions-empty" class="chart-empty">No creative action data in selected window.</div>
    </div>
</div>

<div class="chart-card" style="margin-bottom:20px;" id="skills-card">
    <h4>üîß Creative Skill Breakdown</h4>
    <canvas id="skills-chart"></canvas>
    <div id="creative-empty" class="chart-empty">No creative-skill activity in selected window.</div>
</div>

<h3 style="margin:0 0 10px;">Recent Creative Activity Feed</h3>
<table class="data-table">
    <thead>
        <tr><th>Time</th><th>Action</th><th>Skill</th><th>Status</th><th>Context</th><th>Description</th></tr>
    </thead>
    <tbody id="recent-body">
        <tr><td colspan="6">Loading...</td></tr>
    </tbody>
</table>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script data-page-script>
let _charts = {};

function destroyChart(id) {
    if (_charts[id]) {
        _charts[id].destroy();
        _charts[id] = null;
    }
}

function fmtPct(n) { return `${Math.round(n)}%`; }

function setChartVisibility(canvasId, emptyId, hasData) {
    const canvas = document.getElementById(canvasId);
    const empty = document.getElementById(emptyId);
    if (!canvas || !empty) return;
    canvas.style.display = hasData ? 'block' : 'none';
    empty.classList.toggle('visible', !hasData);
}

function esc(v) {
    return String(v ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}

function formatContextChips(details) {
    if (!details || typeof details !== 'object') return '-';
    const context = details.creative_context && typeof details.creative_context === 'object' ? details.creative_context : {};
    const chips = [];

    if (context.topic) chips.push(`<span class="context-chip">topic: ${esc(context.topic).slice(0, 50)}</span>`);
    if (context.experiment_name) chips.push(`<span class="context-chip">experiment: ${esc(context.experiment_name).slice(0, 40)}</span>`);
    if (context.hypothesis) chips.push(`<span class="context-chip">hypothesis: ${esc(context.hypothesis).slice(0, 46)}</span>`);
    if (context.claim) chips.push(`<span class="context-chip">claim: ${esc(context.claim).slice(0, 46)}</span>`);
    if (details.duration_ms != null) chips.push(`<span class="context-chip">${esc(details.duration_ms)}ms</span>`);

    return chips.length ? chips.join('') : '-';
}

function renderInsights(creative) {
    const insights = creative?.insights || {};
    const brainstorm = insights.latest_brainstorm || null;
    const experiment = insights.latest_experiment || null;

    const brainstormMain = document.getElementById('insight-brainstorm-main');
    const brainstormMeta = document.getElementById('insight-brainstorm-meta');
    const experimentMain = document.getElementById('insight-experiment-main');
    const experimentMeta = document.getElementById('insight-experiment-meta');

    if (brainstorm && brainstorm.topic) {
        brainstormMain.textContent = brainstorm.topic;
        brainstormMeta.textContent = `session=${brainstorm.session_id || 'n/a'} ¬∑ ideas=${brainstorm.idea_count ?? 'n/a'} ¬∑ ${brainstorm.created_at ? new Date(brainstorm.created_at).toLocaleString() : ''}`;
    } else {
        brainstormMain.textContent = 'No brainstorm context yet.';
        brainstormMeta.textContent = 'Run brainstorm.start_session or brainstorm.add_idea to populate this card.';
    }

    if (experiment && (experiment.name || experiment.hypothesis)) {
        experimentMain.textContent = experiment.name || experiment.hypothesis;
        const hy = experiment.hypothesis ? `hypothesis=${experiment.hypothesis}` : 'hypothesis=n/a';
        const st = experiment.status ? `status=${experiment.status}` : 'status=n/a';
        experimentMeta.textContent = `${hy} ¬∑ ${st} ¬∑ ${experiment.created_at ? new Date(experiment.created_at).toLocaleString() : ''}`;
    } else {
        experimentMain.textContent = 'No experiment context yet.';
        experimentMeta.textContent = 'Run experiment.create_experiment to populate this card.';
    }
}

function renderRecent(rows) {
    const body = document.getElementById('recent-body');
    if (!rows || !rows.length) {
        body.innerHTML = '<tr><td colspan="6">No activity in selected window.</td></tr>';
        return;
    }
    body.innerHTML = rows.map((row, idx) => {
        const statusClass = row.success ? 'ok' : 'err';
        const statusText = row.success ? 'OK' : 'Error';
        const time = row.created_at ? new Date(row.created_at).toLocaleString() : '-';
        const contextHtml = formatContextChips(row.details || {});
        const details = row.details && typeof row.details === 'object' ? row.details : {};
        const detailsId = `detail-row-${idx}`;
        const argsPreview = esc(details.args_preview || '-');
        const resultPreview = esc(details.result_preview || '-');
        const creativeContext = esc(JSON.stringify(details.creative_context || {}, null, 2));
        return `<tr>
            <td>${esc(time)}</td>
            <td>${esc(row.action || '-')}</td>
            <td>${esc(row.skill || '-')}</td>
            <td><span class="status-pill ${statusClass}">${statusText}</span></td>
            <td>${contextHtml}</td>
            <td>
                <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                    <span>${esc((row.description || '').slice(0, 180))}</span>
                    <button class="expand-btn" data-detail-id="${detailsId}" onclick="toggleDetailRow(this)">Details</button>
                </div>
            </td>
        </tr>
        <tr id="${detailsId}" class="detail-row">
            <td colspan="6" class="detail-cell">
                <div class="detail-grid">
                    <div class="detail-block">
                        <h5>Args Preview</h5>
                        <pre class="detail-pre">${argsPreview}</pre>
                    </div>
                    <div class="detail-block">
                        <h5>Result Preview</h5>
                        <pre class="detail-pre">${resultPreview}</pre>
                    </div>
                    <div class="detail-block">
                        <h5>Creative Context</h5>
                        <pre class="detail-pre">${creativeContext}</pre>
                    </div>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function toggleDetailRow(btn) {
    const detailId = btn?.dataset?.detailId;
    if (!detailId) return;
    const row = document.getElementById(detailId);
    if (!row) return;
    const isOpen = row.classList.toggle('open');
    btn.textContent = isOpen ? 'Hide' : 'Details';
}

function renderCharts(data) {
    destroyChart('hourly');
    destroyChart('actions');
    destroyChart('skills');

    const creative = data.creative || {};
    const hourlyData = creative.hourly || [];
    const actionData = creative.actions || [];
    const skillData = creative.skills || [];

    setChartVisibility('hourly-chart', 'hourly-empty', hourlyData.length > 0);
    setChartVisibility('actions-chart', 'actions-empty', actionData.length > 0);
    setChartVisibility('skills-chart', 'creative-empty', skillData.some(x => (x.count || 0) > 0));

    if (hourlyData.length > 0) {
        const hourlyLabels = hourlyData.map(x => new Date(x.hour).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
        const hourlyValues = hourlyData.map(x => x.count);
        _charts.hourly = new Chart(document.getElementById('hourly-chart'), {
            type: 'line',
            data: { labels: hourlyLabels, datasets: [{ label: 'Events', data: hourlyValues, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.2)', fill: true, tension: 0.25 }] },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    if (actionData.length > 0) {
        const actionLabels = actionData.map(x => x.action);
        const actionValues = actionData.map(x => x.count);
        _charts.actions = new Chart(document.getElementById('actions-chart'), {
            type: 'bar',
            data: { labels: actionLabels, datasets: [{ label: 'Count', data: actionValues, backgroundColor: 'rgba(99,102,241,0.7)' }] },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    if (skillData.some(x => (x.count || 0) > 0)) {
        const skillLabels = skillData.map(x => x.skill);
        const skillValues = skillData.map(x => x.count);
        _charts.skills = new Chart(document.getElementById('skills-chart'), {
            type: 'bar',
            data: { labels: skillLabels, datasets: [{ label: 'Count', data: skillValues, backgroundColor: 'rgba(16,185,129,0.7)' }] },
            options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
        });
    }
}

async function loadCreativePulse() {
    const hours = document.getElementById('hours-filter').value;
    const url = `${API_BASE_URL}/activities/visualization?hours=${encodeURIComponent(hours)}&limit=30&include_creative=true`;
    const data = await fetchAriaData(url);

    const creative = data.creative || {};
    const creativeRecent = creative.recent || [];
    const creativeTotal = creative.total || 0;
    const creativeSuccess = creativeRecent.filter(x => x && x.success).length;
    const creativeFail = Math.max(0, creativeTotal - creativeSuccess);
    const creativeRate = creativeTotal ? (creativeSuccess * 100 / creativeTotal) : 0;

    document.getElementById('stat-creative').textContent = formatNumber(creativeTotal);
    document.getElementById('stat-creative-success').textContent = formatNumber(creativeSuccess);
    document.getElementById('stat-creative-fail').textContent = formatNumber(creativeFail);
    document.getElementById('stat-creative-rate').textContent = fmtPct(creativeRate);
    document.getElementById('sync-meta').textContent = `Data sync: ${new Date().toLocaleTimeString()}`;

    renderCharts(data);
    renderInsights(creative);
    renderRecent(creativeRecent);
}

document.getElementById('hours-filter').addEventListener('change', loadCreativePulse);
loadCreativePulse().catch(err => {
    console.error(err);
    document.getElementById('recent-body').innerHTML = `<tr><td colspan="6">Error loading Creative Pulse: ${escapeHtml(err.message)}</td></tr>`;
    setChartVisibility('hourly-chart', 'hourly-empty', false);
    setChartVisibility('actions-chart', 'actions-empty', false);
    setChartVisibility('skills-chart', 'creative-empty', false);
});
</script>
{% endblock %}
