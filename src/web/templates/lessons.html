{% extends "base.html" %}
{% block title %}Lessons Learned{% endblock %}
{% block content %}
<div class="page-header">
    <h1>ðŸ“š Lessons Learned Dashboard</h1>
    <p class="subtitle">Error patterns, skill-level diagnostics, and resolution effectiveness</p>
</div>

<div id="statCards" class="stat-row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;margin-bottom:1.5rem;">
    <div class="stat-card"><div class="stat-value" id="totalLessons">â€”</div><div class="stat-label">Total Lessons</div></div>
    <div class="stat-card"><div class="stat-value" id="avgEff">â€”</div><div class="stat-label">Avg Effectiveness</div></div>
    <div class="stat-card"><div class="stat-value" id="totalOcc">â€”</div><div class="stat-label">Total Occurrences</div></div>
    <div class="stat-card"><div class="stat-value" id="skillCount">â€”</div><div class="stat-label">Skills Tracked</div></div>
</div>

<div style="display:grid;grid-template-columns:1fr 320px;gap:1.25rem;margin-bottom:1.25rem;">
    <div class="card">
        <div class="card-header">
            <h3>Error Pattern Network</h3>
            <div style="display:flex;gap:0.5rem;align-items:center;">
                <span class="legend-dot" style="background:#3b82f6;display:inline-block;width:10px;height:10px;border-radius:2px;"></span><span style="font-size:0.78rem;color:var(--text-muted);">Skill</span>
                <span class="legend-dot" style="background:#f59e0b;display:inline-block;width:10px;height:10px;border-radius:50%;"></span><span style="font-size:0.78rem;color:var(--text-muted);">Lesson</span>
                <span class="legend-dot" style="background:#ef4444;display:inline-block;width:10px;height:10px;border-radius:3px;transform:rotate(45deg)"></span><span style="font-size:0.78rem;color:var(--text-muted);">Error Type</span>
            </div>
        </div>
        <div class="card-body">
            <div id="graphContainer" style="height:420px;background:var(--bg-secondary);border-radius:8px;"></div>
        </div>
    </div>
    <div>
        <div class="card" style="margin-bottom:1rem;">
            <div class="card-header"><h3>Effectiveness Distribution</h3></div>
            <div class="card-body" style="height:210px;"><canvas id="effChart"></canvas></div>
        </div>
        <div class="card">
            <div class="card-header"><h3>Node Inspector</h3></div>
            <div class="card-body" id="nodeInspector" style="font-size:0.83rem;color:var(--text-muted);min-height:100px;"><em>Click a node</em></div>
        </div>
    </div>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;">
    <div class="card">
        <div class="card-header"><h3>Top Error Patterns</h3></div>
        <div class="card-body" style="max-height:320px;overflow-y:auto;">
            <table class="table table-sm" id="patternsTable">
                <thead><tr><th>Pattern</th><th>Skill</th><th>Occ.</th><th>Eff.</th></tr></thead>
                <tbody id="patternsBody"></tbody>
            </table>
        </div>
    </div>
    <div class="card">
        <div class="card-header"><h3>Skill Breakdown</h3></div>
        <div class="card-body" style="max-height:320px;overflow-y:auto;">
            <table class="table table-sm" id="skillTable">
                <thead><tr><th>Skill</th><th>Lessons</th><th>Occurrences</th><th>Avg Eff.</th></tr></thead>
                <tbody id="skillBody"></tbody>
            </table>
        </div>
    </div>
</div>

<style>
.stat-card { background:var(--card-bg); border:1px solid var(--border-color); border-radius:10px; padding:1.25rem; text-align:center; }
.stat-value { font-size:1.8rem; font-weight:700; color:var(--accent-primary); }
.stat-label { font-size:0.82rem; color:var(--text-muted); margin-top:0.25rem; }
.eff-bar { height:6px; background:var(--bg-elevated); border-radius:3px; display:inline-block; width:60px; vertical-align:middle; overflow:hidden; }
.eff-fill { height:100%; border-radius:3px; }
</style>

<script src="/static/js/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
const API = window.API_BASE || '/api';
let network = null;

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function effColor(e) { return e >= 0.7 ? '#10b981' : e >= 0.4 ? '#f59e0b' : '#ef4444'; }

async function loadData() {
    const res = await fetch(`${API}/lessons/dashboard`);
    const d = await res.json();
    const stats = d.stats || {};
    document.getElementById('totalLessons').textContent = stats.total_lessons || 0;
    document.getElementById('avgEff').textContent = ((stats.avg_effectiveness || 0) * 100).toFixed(0) + '%';
    document.getElementById('totalOcc').textContent = stats.total_occurrences || 0;
    document.getElementById('skillCount').textContent = Object.keys(d.skill_breakdown || {}).length;

    renderGraph(d.graph || {nodes:[], edges:[]});
    renderEffChart(d.effectiveness_distribution || {});
    renderPatterns(d.top_patterns || []);
    renderSkills(d.skill_breakdown || {});
}

function renderGraph(graph) {
    const nodeMap = {};
    const visNodes = (graph.nodes || []).map(n => {
        nodeMap[n.id] = n;
        if (n.type === 'skill') return { id: n.id, label: n.label, shape: 'box', color: { background: '#1e3a8a', border: '#3b82f6' }, font: { color: '#fff', size: 11 }, size: 16 };
        if (n.type === 'lesson') {
            const sz = Math.max(8, Math.min(25, 8 + (n.occurrences || 0) * 1.5));
            return { id: n.id, label: n.label, shape: 'dot', size: sz, color: { background: '#92400e', border: '#f59e0b' }, font: { color: '#fff', size: 10 } };
        }
        return { id: n.id, label: n.label, shape: 'triangle', color: { background: '#991b1b', border: '#ef4444' }, font: { color: '#fff', size: 10 }, size: 12 };
    });
    const visEdges = (graph.edges || []).map((e, i) => ({
        id: i, from: e.from, to: e.to,
        color: e.type === 'produces' ? { color: '#f59e0b' } : { color: '#ef4444' },
        width: 1, arrows: { to: { enabled: true, scaleFactor: 0.5 } },
        dashes: e.type === 'classified_as',
    }));

    const container = document.getElementById('graphContainer');
    const nodes = new vis.DataSet(visNodes);
    const edges = new vis.DataSet(visEdges);
    network = new vis.Network(container, { nodes, edges }, {
        physics: { solver: 'forceAtlas2Based', forceAtlas2Based: { gravitationalConstant: -40, centralGravity: 0.005, springLength: 120, springConstant: 0.06 }, stabilization: { iterations: 100 } },
        interaction: { hover: true, tooltipDelay: 150 },
        nodes: { borderWidth: 1.5 },
        edges: { smooth: { type: 'cubicBezier' } },
    });
    network.on('click', params => {
        if (!params.nodes.length) return;
        const n = nodeMap[params.nodes[0]];
        if (!n) return;
        let html = '';
        if (n.type === 'lesson') {
            html = `<div style="margin-bottom:.4rem;font-weight:600;">${esc(n.label)}</div>
                <div style="margin-bottom:.3rem;font-size:.78rem;"><span style="color:var(--text-muted);">Occurrences:</span> ${n.occurrences}</div>
                <div style="margin-bottom:.3rem;font-size:.78rem;"><span style="color:var(--text-muted);">Effectiveness:</span> ${((n.effectiveness||0)*100).toFixed(0)}%</div>
                <div style="font-size:.78rem;color:var(--text-muted);">Resolution:</div>
                <div style="font-size:.8rem;margin-top:.2rem;">${esc(n.resolution||'â€”')}</div>`;
        } else {
            html = `<div style="font-weight:600;">${esc(n.label)}</div><div style="font-size:.78rem;color:var(--text-muted);">Type: ${n.type}</div>`;
        }
        document.getElementById('nodeInspector').innerHTML = html;
    });
}

function renderEffChart(dist) {
    const labels = Object.keys(dist);
    const counts = labels.map(k => dist[k]);
    const colors = ['#ef4444','#f59e0b','#f59e0b','#10b981','#10b981'];
    const ctx = document.getElementById('effChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Lessons', data: counts, backgroundColor: colors.slice(0, labels.length), borderRadius: 4 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#64748b', font: { size: 10 } } }, y: { beginAtZero: true, ticks: { color: '#64748b' } } } }
    });
}

function renderPatterns(patterns) {
    document.getElementById('patternsBody').innerHTML = patterns.map(p => {
        const effPct = Math.round((p.effectiveness||0)*100);
        return `<tr>
            <td style="font-size:.82rem;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(p.pattern)}">${esc(p.pattern||'â€”')}</td>
            <td style="font-size:.78rem;color:var(--text-muted);">${esc(p.skill||'â€”')}</td>
            <td style="font-weight:600;">${p.occurrences||0}</td>
            <td><span class="eff-bar"><span class="eff-fill" style="width:${effPct}%;background:${effColor(p.effectiveness||0)};"></span></span> ${effPct}%</td>
        </tr>`;
    }).join('');
}

function renderSkills(skills) {
    const rows = Object.entries(skills).sort((a,b) => b[1].total_occ - a[1].total_occ);
    document.getElementById('skillBody').innerHTML = rows.map(([s, d]) => {
        const effPct = Math.round((d.avg_eff||0)*100);
        return `<tr>
            <td style="font-size:.82rem;">${esc(s)}</td>
            <td style="color:var(--accent-primary);font-weight:600;">${d.count}</td>
            <td style="color:var(--text-muted);">${d.total_occ}</td>
            <td><span class="eff-bar"><span class="eff-fill" style="width:${effPct}%;background:${effColor(d.avg_eff||0)};"></span></span> ${effPct}%</td>
        </tr>`;
    }).join('');
}

loadData();
</script>
{% endblock %}
