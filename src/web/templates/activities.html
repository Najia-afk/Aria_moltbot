{% extends "base.html" %}
{% block title %}Activities{% endblock %}

{% block extra_css %}
<style>
    .page-controls { display: flex; gap: 12px; margin-bottom: 18px; flex-wrap: wrap; align-items: center; }
    .search-box {
        flex: 1;
        min-width: 220px;
        padding: 10px 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 13px;
    }
    .search-box:focus { outline: none; border-color: var(--accent-blue); }
    .filter-select {
        padding: 10px 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        cursor: pointer;
        font-size: 13px;
    }
    .sync-meta { margin-left: auto; font-size: 12px; color: var(--text-muted); }

    .data-table {
        width: 100%;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        border-collapse: collapse;
        overflow: hidden;
    }
    .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
    .data-table th {
        background: rgba(0,0,0,0.2);
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }
    .sortable-head { cursor: pointer; user-select: none; }
    .sortable-head .sort-indicator { margin-left: 6px; color: var(--text-muted); }
    .sort-note { font-size: 11px; color: var(--text-muted); margin-top: 8px; }
    .data-table tr:hover { background: rgba(0,212,255,0.04); }
    .data-table tr:last-child td { border-bottom: none; }

    .status-pill { display:inline-block; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:700; }
    .status-pill.ok { background: rgba(34,197,94,0.2); color: var(--success); }
    .status-pill.err { background: rgba(239,68,68,0.2); color: var(--danger); }
    .status-pill.unk { background: rgba(100,100,100,0.2); color: var(--text-muted); }

    .time-col { white-space: nowrap; color: var(--text-secondary); font-size: 12px; }
    .desc-col { max-width: 640px; word-break: break-word; }
    .empty-state { text-align: center; padding: 26px 16px; color: var(--text-secondary); }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>⚡ Activities</h1>
    <p>Real-time activity feed for Aria execution events</p>
</div>

<div class="page-controls">
    <input type="text" class="search-box" id="search-input" placeholder="Search action / skill / description...">
    <select class="filter-select" id="status-filter">
        <option value="">All Status</option>
        <option value="ok">OK</option>
        <option value="error">Error</option>
    </select>
    <span class="sync-meta" id="sync-meta">Data sync: —</span>
    <button class="btn btn-primary" onclick="loadActivities()">Refresh</button>
</div>

<div id="activities-container">
    <table class="data-table" id="activities-table">
        <thead>
            <tr>
                <th class="sortable-head" data-sort-key="created_at">Time<span class="sort-indicator">↕</span></th>
                <th class="sortable-head" data-sort-key="action">Action<span class="sort-indicator">↕</span></th>
                <th class="sortable-head" data-sort-key="skill">Skill<span class="sort-indicator">↕</span></th>
                <th class="sortable-head" data-sort-key="status">Status<span class="sort-indicator">↕</span></th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody id="activities-body">
            <tr><td colspan="5" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
    <div class="sort-note">Sorting applies to current page only (pagination/limit still controls DB reads).</div>
    <div id="activities-pagination"></div>
</div>
{% endblock %}

{% block extra_js %}
<script data-page-script>
    let allActivities = [];
    let activitiesPager;
    let activeSortKey = 'created_at';
    let activeSortDir = 'desc';

    function esc(v) {
        return String(v ?? '')
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
    }

    function loadActivities(page = 1, limit = 25) {
        document.getElementById('activities-body').innerHTML = '<tr><td colspan="5" class="empty-state">Loading...</td></tr>';

        fetch(`${window.ARIA_API_BASE_URL}/activities?limit=${limit}&page=${page}`)
            .then(r => r.json())
            .then(data => {
                allActivities = data.items || data;
                applyFiltersAndSort();
                if (activitiesPager && data.pages) activitiesPager.update(data);
                document.getElementById('sync-meta').textContent = `Data sync: ${new Date().toLocaleTimeString()}`;
            })
            .catch(e => {
                document.getElementById('activities-body').innerHTML = `
                    <tr><td colspan="5" class="empty-state">
                        <div>Could not load activities</div>
                        <div style="font-size:12px;margin-top:10px">${esc(e.message)}</div>
                    </td></tr>`;
            });
    }

    function compareValues(a, b, key) {
        if (key === 'created_at') {
            const av = a.created_at ? new Date(a.created_at).getTime() : 0;
            const bv = b.created_at ? new Date(b.created_at).getTime() : 0;
            return av - bv;
        }
        if (key === 'status') {
            const aStatus = (a.status || (a.success ? 'ok' : 'error') || 'unknown').toLowerCase();
            const bStatus = (b.status || (b.success ? 'ok' : 'error') || 'unknown').toLowerCase();
            return aStatus.localeCompare(bStatus);
        }
        const av = String(a[key] || a.type || '').toLowerCase();
        const bv = String(b[key] || b.type || '').toLowerCase();
        return av.localeCompare(bv);
    }

    function sortActivities(data) {
        const cloned = [...data];
        cloned.sort((a, b) => {
            const cmp = compareValues(a, b, activeSortKey);
            return activeSortDir === 'asc' ? cmp : -cmp;
        });
        return cloned;
    }

    function updateSortIndicators() {
        document.querySelectorAll('.sortable-head').forEach(head => {
            const key = head.dataset.sortKey;
            const indicator = head.querySelector('.sort-indicator');
            if (!indicator) return;
            if (key !== activeSortKey) {
                indicator.textContent = '↕';
            } else {
                indicator.textContent = activeSortDir === 'asc' ? '↑' : '↓';
            }
        });
    }

    function renderActivities(data) {
        if (!data || data.length === 0) {
            document.getElementById('activities-body').innerHTML = `
                <tr><td colspan="5" class="empty-state">
                    <div>No activities found</div>
                    <div style="font-size:12px;margin-top:8px">No events in this filter window.</div>
                </td></tr>`;
            return;
        }

        let html = '';
        data.forEach(a => {
            const timeText = a.created_at ? new Date(a.created_at).toLocaleString() : '-';
            const action = a.action || a.type || '-';
            const skill = a.skill || '-';
            const statusRaw = (a.status || (a.success ? 'ok' : 'error') || 'unknown').toLowerCase();
            const statusLabel = statusRaw === 'ok' ? 'OK' : (statusRaw === 'error' ? 'Error' : 'Unknown');
            const statusClass = statusRaw === 'ok' ? 'ok' : (statusRaw === 'error' ? 'err' : 'unk');
            let description = a.description || '';
            if (!description && a.details) {
                try { description = typeof a.details === 'string' ? a.details : JSON.stringify(a.details); }
                catch { description = String(a.details); }
            }
            html += `<tr>
                <td class="time-col">${esc(timeText)}</td>
                <td>${esc(action)}</td>
                <td>${esc(skill)}</td>
                <td><span class="status-pill ${statusClass}">${statusLabel}</span></td>
                <td class="desc-col">${esc(description || '-')}</td>
            </tr>`;
        });
        document.getElementById('activities-body').innerHTML = html;
    }

    function applyFiltersAndSort() {
        const search = document.getElementById('search-input').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;

        let filtered = allActivities;

        if (search) {
            filtered = filtered.filter(a =>
                (a.description && String(a.description).toLowerCase().includes(search)) ||
                (a.action && String(a.action).toLowerCase().includes(search)) ||
                (a.skill && String(a.skill).toLowerCase().includes(search))
            );
        }

        if (statusFilter) {
            filtered = filtered.filter(a => (a.status || (a.success ? 'ok' : 'error')) === statusFilter);
        }

        const sorted = sortActivities(filtered);
        updateSortIndicators();
        renderActivities(sorted);
    }

    document.getElementById('search-input').addEventListener('input', applyFiltersAndSort);
    document.getElementById('status-filter').addEventListener('change', applyFiltersAndSort);
    document.querySelectorAll('.sortable-head').forEach(head => {
        head.addEventListener('click', () => {
            const key = head.dataset.sortKey;
            if (activeSortKey === key) {
                activeSortDir = activeSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                activeSortKey = key;
                activeSortDir = key === 'created_at' ? 'desc' : 'asc';
            }
            applyFiltersAndSort();
        });
    });

    activitiesPager = new AriaPagination('activities-pagination', {
        onPageChange: (page, limit) => loadActivities(page, limit),
        limit: 25
    });
    updateSortIndicators();
    loadActivities();
</script>
{% endblock %}
