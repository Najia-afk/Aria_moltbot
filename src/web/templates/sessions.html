{% extends "base.html" %}
{% block title %}Agent Sessions{% endblock %}

{% block extra_css %}
<style>
    .page-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .filter-select { padding: 10px 14px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-size: 13px; }
    .search-box { flex: 1; min-width: 200px; padding: 10px 14px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 13px; }
    .search-box:focus { outline: none; border-color: var(--accent-blue); }
    .inline-toggle { display: inline-flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 12px; user-select: none; }
    .inline-toggle input { accent-color: var(--accent-primary); }
    .sync-meta { color: var(--text-muted); font-size: 12px; margin-left: auto; }
    .sync-meta.fresh { color: var(--success); }
    .sync-meta.stale { color: #f59e0b; }
    .sync-meta.error { color: var(--danger); }

    /* Tabs */
    .tabs { display: flex; gap: 0; margin-bottom: 25px; border-bottom: 2px solid var(--border-color); }
    .tab-btn { padding: 12px 24px; background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; color: var(--text-secondary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
    .tab-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.03); }
    .tab-btn.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }
    .tab-btn .badge { font-size: 11px; padding: 2px 7px; border-radius: 10px; background: rgba(124,58,237,0.15); color: #a855f7; font-weight: 700; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .stat-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; padding: 18px; }
    .stat-card h4 { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.03em; }
    .stat-card .value { font-size: 22px; font-weight: 700; color: var(--text-primary); }
    .stat-card.blue .value { color: var(--accent-blue); }
    .stat-card.green .value { color: var(--success); }
    .stat-card.purple .value { color: #a855f7; }
    .stat-card.orange .value { color: #f59e0b; }
    .stat-card.red .value { color: var(--danger); }
    .stats-sub { font-size: 11px; color: var(--text-muted); margin-top: 3px; }

    /* Charts */
    .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
    .chart-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; }
    .chart-card h4 { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; }
    .chart-card canvas { max-height: 250px; }

    /* Tables */
    .section-title { font-size: 15px; font-weight: 600; margin: 20px 0 12px; display: flex; align-items: center; gap: 8px; }
    .data-table { width: 100%; background: var(--bg-secondary); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); }
    .data-table th, .data-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 13px; }
    .data-table th { background: rgba(0,0,0,0.2); font-weight: 600; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; }
    .data-table tr:hover { background: rgba(0,212,255,0.04); }
    .data-table tr:last-child td { border-bottom: none; }

    /* Badges */
    .status-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .status-badge.active { background: rgba(34,197,94,0.2); color: var(--success); }
    .status-badge.completed { background: rgba(59,130,246,0.2); color: #3b82f6; }
    .status-badge.ended { background: rgba(100,100,100,0.2); color: var(--text-muted); }
    .status-badge.error { background: rgba(239,68,68,0.2); color: var(--danger); }
    .agent-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: rgba(124,58,237,0.15); border-radius: 10px; font-size: 11px; font-weight: 600; color: #a855f7; }
    .type-badge { display: inline-block; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 600; background: rgba(0,212,255,0.15); color: var(--accent-blue); }
    .empty-state { text-align: center; padding: 50px 20px; color: var(--text-secondary); }

    @media (max-width: 768px) { .charts-row { grid-template-columns: 1fr; } .tabs { overflow-x: auto; } .tab-btn { padding: 10px 16px; font-size: 13px; white-space: nowrap; } }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ðŸ’¬ Agent Sessions</h1>
    <p>Monitor Aria's activity sessions, agents & usage</p>
</div>

<div class="page-controls">
    <select class="filter-select" id="status-filter">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="completed">Completed</option>
        <option value="error">Error</option>
    </select>
    <select class="filter-select" id="agent-filter">
        <option value="">All Agents</option>
    </select>
    <select class="filter-select" id="channel-filter">
        <option value="">All Channels</option>
        <option value="webchat">webchat</option>
        <option value="whatsapp">whatsapp</option>
        <option value="heartbeat">heartbeat</option>
    </select>
    <label class="inline-toggle" title="Show OpenClaw cron sessions in the dashboard">
        <input type="checkbox" id="cron-toggle" checked>
        Show cron sessions
    </label>
    <span class="sync-meta" id="sync-meta">Data sync: â€”</span>
    <input type="text" class="search-box" id="search-input" placeholder="Search by session or agent...">
    <button class="btn btn-primary" onclick="loadSessionDashboard()">Refresh</button>
</div>

<!-- Tabs -->
<div class="tabs">
    <button class="tab-btn active" data-tab="overview">
        ðŸ“Š Overview <span class="badge" id="tab-badge-total">-</span>
    </button>
    <button class="tab-btn" data-tab="agents">
        ðŸ¤– By Agent <span class="badge" id="tab-badge-agents">-</span>
    </button>
    <button class="tab-btn" data-tab="recent">
        ðŸ“‹ Recent <span class="badge" id="tab-badge-recent">-</span>
    </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 1: OVERVIEW
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel active" id="panel-overview">
    <div class="stats-grid">
        <div class="stat-card green">
            <h4>Active Sessions</h4>
            <div class="value" id="stat-active">-</div>
        </div>
        <div class="stat-card blue">
            <h4>Total Sessions</h4>
            <div class="value" id="stat-total">-</div>
            <div class="stats-sub" id="stat-total-sub"></div>
        </div>
        <div class="stat-card purple">
            <h4>Total Tokens</h4>
            <div class="value" id="stat-tokens">-</div>
            <div class="stats-sub" id="stat-tokens-sub"></div>
        </div>
        <div class="stat-card orange">
            <h4>Total Cost</h4>
            <div class="value" id="stat-cost">-</div>
        </div>
        <div class="stat-card red">
            <h4>Errors</h4>
            <div class="value" id="stat-errors">-</div>
            <div class="stats-sub" id="stat-errors-sub"></div>
        </div>
    </div>

    <div class="charts-row">
        <div class="chart-card">
            <h4>ðŸ“Š 24h Activity by Agent</h4>
            <canvas id="chart-status"></canvas>
        </div>
        <div class="chart-card">
            <h4>ðŸ“ˆ Session Types</h4>
            <canvas id="chart-types"></canvas>
        </div>
    </div>

    <h3 class="section-title">ðŸ¤– Agent Summary</h3>
    <table class="data-table">
        <thead>
            <tr><th>Agent</th><th>Sessions</th><th>Tokens</th><th>Cost</th></tr>
        </thead>
        <tbody id="overview-agents-body">
            <tr><td colspan="4" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 2: BY AGENT
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel" id="panel-agents">
    <div class="charts-row">
        <div class="chart-card">
            <h4>ðŸ“Š Sessions per Agent</h4>
            <canvas id="chart-agent-sessions"></canvas>
        </div>
        <div class="chart-card">
            <h4>ðŸ’° Tokens per Agent</h4>
            <canvas id="chart-agent-tokens"></canvas>
        </div>
    </div>

    <h3 class="section-title">ðŸ¤– Agent Breakdown</h3>
    <table class="data-table">
        <thead>
            <tr><th>Agent</th><th>Sessions</th><th>Tokens</th><th>Cost</th><th>Share</th></tr>
        </thead>
        <tbody id="agent-breakdown-body">
            <tr><td colspan="5" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 3: RECENT SESSIONS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel" id="panel-recent">
    <table class="data-table">
        <thead>
            <tr>
                <th>Session ID</th>
                <th>Agent</th>
                <th>Label</th>
                <th>Channel</th>
                <th>Type</th>
                <th>Status</th>
                <th>Tokens</th>
                <th>Cost</th>
                <th>Started</th>
                <th>Duration</th>
            </tr>
        </thead>
        <tbody id="sessions-body">
            <tr><td colspan="8" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
    <div id="sessions-pagination"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/chart-helpers.js"></script>
<script data-page-script>
// â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _stats = null;
let _sessions = [];
let _hourly = [];
let _charts = {};
let sessionsPager;

function includeCronEvents() {
    const el = document.getElementById('cron-toggle');
    return Boolean(el && el.checked);
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
    });
});

// â”€â”€ Duration helper (session-specific) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDuration(startStr, endStr) {
    if (!startStr) return '-';
    const start = new Date(startStr);
    const end = endStr ? new Date(endStr) : new Date();
    const diffMs = end - start;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours > 0) return `${diffHours}h ${diffMins % 60}m`;
    if (diffMins > 0) return `${diffMins}m`;
    return `${Math.floor(diffMs / 1000)}s`;
}

// â”€â”€ Load Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSessionStats() {
    try {
        const includeCron = includeCronEvents();
        const channel = document.getElementById('channel-filter').value;
        const status = document.getElementById('status-filter').value;
        const agent = document.getElementById('agent-filter').value;
        let url = `${API_BASE_URL}/sessions/stats?include_cron_events=${includeCron ? 'true' : 'false'}`;
        if (channel) url += `&source_channel=${encodeURIComponent(channel)}`;
        if (status) url += `&status=${encodeURIComponent(status)}`;
        if (agent) url += `&agent_id=${encodeURIComponent(agent)}`;
        _stats = await fetchAriaData(url);
        renderSessionOverview();
        renderAgentTab();
            populateAgentFilter();
    } catch (e) {
        console.error('Stats error:', e);
        showErrorState('#overview-agents-body',
            'Could not load session stats â€” ' + e.message, loadSessionStats);
        document.querySelectorAll('.stat-card .value').forEach(el => { if (el.textContent === '-') el.textContent = 'â€”'; });
    }
}

// â”€â”€ Load Sessions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSessions(page = 1, limit = 50) {
    const status = document.getElementById('status-filter').value;
    const agent = document.getElementById('agent-filter').value;
    const channel = document.getElementById('channel-filter').value;
    const includeCron = includeCronEvents();
    let url = `${API_BASE_URL}/sessions?limit=${limit}&page=${page}`;
    if (status) url += `&status=${status}`;
    if (agent) url += `&agent_id=${encodeURIComponent(agent)}`;
    if (channel) url += `&source_channel=${encodeURIComponent(channel)}`;
    url += `&include_cron_events=${includeCron ? 'true' : 'false'}`;
    try {
        const data = await fetchAriaData(url);
        _sessions = data.items || data.sessions || [];
        updateSyncMeta();
        renderRecent();
        if (sessionsPager && data.pages) sessionsPager.update(data);
    } catch (e) {
        console.error('Sessions error:', e);
        showErrorState('#sessions-body',
            'Could not load sessions â€” ' + e.message, () => loadSessions(page, limit));
        const target = document.getElementById('sync-meta');
        if (target) {
            target.classList.remove('fresh', 'stale');
            target.classList.add('error');
            target.textContent = 'Data sync: unavailable';
        }
    }
}

function updateSyncMeta() {
    const target = document.getElementById('sync-meta');
    if (!target) return;
    target.classList.remove('fresh', 'stale', 'error');
    let latest = null;
    for (const row of _sessions || []) {
        const ts = row?.metadata?.synced_at;
        if (!ts) continue;
        const dt = new Date(ts);
        if (!Number.isNaN(dt.getTime()) && (!latest || dt > latest)) {
            latest = dt;
        }
    }
    if (!latest) {
        target.textContent = `Data sync: â€” Â· rows ${(_sessions || []).length}`;
        return;
    }
    const ageMs = Date.now() - latest.getTime();
    const freshWindowMs = 60 * 1000;
    if (ageMs <= freshWindowMs) {
        target.classList.add('fresh');
    } else {
        target.classList.add('stale');
    }
    target.textContent = `Data sync: ${latest.toLocaleString()} Â· rows ${(_sessions || []).length}`;
}

async function loadHourlySeries(hours = 24) {
    try {
        const includeCron = includeCronEvents();
        const channel = document.getElementById('channel-filter').value;
        const status = document.getElementById('status-filter').value;
        const agent = document.getElementById('agent-filter').value;
        let url = `${API_BASE_URL}/sessions/hourly?hours=${hours}&include_cron_events=${includeCron ? 'true' : 'false'}`;
        if (channel) url += `&source_channel=${encodeURIComponent(channel)}`;
        if (status) url += `&status=${encodeURIComponent(status)}`;
        if (agent) url += `&agent_id=${encodeURIComponent(agent)}`;
        const data = await fetchAriaData(url);
        _hourly = data.items || [];
        renderHourlyChart();
    } catch (e) {
        console.error('Hourly series error:', e);
    }
}

function populateAgentFilter() {
    if (!_stats) return;
    const select = document.getElementById('agent-filter');
    const current = select.value;
    const agents = (_stats.by_agent || []).map(a => a.agent_id).filter(Boolean);

    select.innerHTML = '<option value="">All Agents</option>' +
        agents.map(agent => `<option value="${agent}">${agent}</option>`).join('');

    if (current && agents.includes(current)) {
        select.value = current;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSessionOverview() {
    if (!_stats) return;
    const s = _stats;
    const lit = s.litellm || {};
    const sources = s.sources || {};
    const skillSrc = sources.skills || {};
    const litSrc = sources.litellm || {};

    // Tab badges
    document.getElementById('tab-badge-total').textContent = formatNumber(s.total_sessions);
    document.getElementById('tab-badge-agents').textContent = (s.by_agent || []).length;

    // Stats cards
    document.getElementById('stat-active').textContent = s.active_sessions || 0;
    document.getElementById('stat-total').textContent = formatNumber(s.total_sessions);
    document.getElementById('stat-total-sub').textContent =
        'DB sessions (auto-synced from OpenClaw + runtime events)';
    document.getElementById('stat-tokens').textContent = formatNumber(s.total_tokens);
    document.getElementById('stat-tokens-sub').textContent =
        `Skills DB: ${formatNumber(skillSrc.tokens || 0)} | LiteLLM DB: ${formatNumber(litSrc.tokens || lit.tokens || 0)}`;
    document.getElementById('stat-cost').textContent = formatCost(s.total_cost);

    // Error count from by_status
    const byStatus = s.by_status || [];
    const errorCount = byStatus.find(x => x.status === 'error')?.count || 0;
    const total = s.total_sessions || 1;
    const errorRate = (errorCount / total * 100).toFixed(1);
    document.getElementById('stat-errors').textContent = errorCount;
    document.getElementById('stat-errors-sub').textContent = `${errorRate}% error rate`;

    // â”€â”€ Chart: 24h Activity by Agent (stacked bar) â”€â”€
    // Rendered from loadSessions â†’ renderHourlyChart() below

    // â”€â”€ Chart: Session Types (bar) â”€â”€
    const byType = s.by_type || [];
    if (byType.length > 0) {
        ARIAChartHelpers.renderChart(_charts, 'chart-types', 'bar', {
            labels: byType.map(x => x.type || 'unknown'),
            datasets: [{
                label: 'Sessions',
                data: byType.map(x => x.count),
                backgroundColor: '#a855f7',
                borderRadius: 6,
            }]
        });
    }

    // â”€â”€ Agent Summary table â”€â”€
    const agents = s.by_agent || [];
    const body = document.getElementById('overview-agents-body');
    if (agents.length > 0) {
        body.innerHTML = agents.map(a => `
            <tr>
                <td><span class="agent-badge">ðŸ¤– ${a.agent_id}</span></td>
                <td>${formatNumber(a.sessions)}</td>
                <td>${formatNumber(a.tokens)}</td>
                <td>${formatCost(a.cost)}</td>
            </tr>
        `).join('');
    } else {
        body.innerHTML = '<tr><td colspan="4" class="empty-state">No agent data</td></tr>';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BY AGENT TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAgentTab() {
    if (!_stats) return;
    const agents = _stats.by_agent || [];
    const totalSessions = _stats.total_sessions || 1;

    // Chart: Sessions per agent
    ARIAChartHelpers.renderChart(_charts, 'chart-agent-sessions', 'bar', {
        labels: agents.map(a => a.agent_id),
        datasets: [{
            label: 'Sessions',
            data: agents.map(a => a.sessions),
            backgroundColor: '#3b82f6',
            borderRadius: 6,
        }]
    }, { indexAxis: 'y' });

    // Chart: Tokens per agent
    ARIAChartHelpers.renderChart(_charts, 'chart-agent-tokens', 'bar', {
        labels: agents.map(a => a.agent_id),
        datasets: [{
            label: 'Tokens',
            data: agents.map(a => a.tokens),
            backgroundColor: '#a855f7',
            borderRadius: 6,
        }]
    }, { indexAxis: 'y' });

    // Agent breakdown table with share %
    const body = document.getElementById('agent-breakdown-body');
    if (agents.length > 0) {
        body.innerHTML = agents.map(a => {
            const share = (a.sessions / totalSessions * 100).toFixed(1);
            return `
            <tr>
                <td><span class="agent-badge">ðŸ¤– ${a.agent_id}</span></td>
                <td>${formatNumber(a.sessions)}</td>
                <td>${formatNumber(a.tokens)}</td>
                <td>${formatCost(a.cost)}</td>
                <td>
                    <div style="display:flex;align-items:center;gap:8px">
                        <div style="flex:1;height:6px;background:var(--border-color);border-radius:3px;max-width:100px">
                            <div style="height:100%;width:${share}%;background:#3b82f6;border-radius:3px"></div>
                        </div>
                        <span style="font-size:12px;color:var(--text-muted)">${share}%</span>
                    </div>
                </td>
            </tr>`;
        }).join('');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECENT SESSIONS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRecent() {
    const search = document.getElementById('search-input').value.toLowerCase();
    let filtered = _sessions;
    if (search) {
        filtered = filtered.filter(s =>
            s.agent_id.toLowerCase().includes(search) ||
            s.id.toLowerCase().includes(search)
        );
    }
    document.getElementById('tab-badge-recent').textContent = filtered.length;

    const body = document.getElementById('sessions-body');
    if (filtered.length > 0) {
        body.innerHTML = filtered.map(s => `
            <tr>
                <td><code style="font-size:11px">${s.id.slice(0,8)}...</code></td>
                <td><span class="agent-badge">ðŸ¤– ${s.agent_id}</span></td>
                <td>${(s.metadata?.openclaw_session?.label || s.metadata?.label || '-')}</td>
                <td>${(s.source_channel || s.metadata?.openclaw_source_channel || s.metadata?.openclaw_session?.channel || '-')}</td>
                <td><span class="type-badge">${s.session_type}</span></td>
                <td><span class="status-badge ${s.status}">${s.status}</span></td>
                <td>${s.tokens_used ? formatNumber(s.tokens_used) : '-'}</td>
                <td>${s.cost_usd ? formatCost(s.cost_usd) : '-'}</td>
                <td>${formatDate(s.started_at)}</td>
                <td>${fmtDuration(s.started_at, s.ended_at)}</td>
            </tr>
        `).join('');
    } else {
        body.innerHTML = '<tr><td colspan="10" class="empty-state">No sessions found</td></tr>';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 24H HOURLY CHART BY AGENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHourlyChart() {
    if (!_hourly || _hourly.length === 0) return;
    const now = new Date();
    const currentUtcHour = new Date(Date.UTC(
        now.getUTCFullYear(),
        now.getUTCMonth(),
        now.getUTCDate(),
        now.getUTCHours(),
        0,
        0,
        0
    ));
    const agents = [...new Set(_hourly.map(row => row.agent_id).filter(Boolean))];
    const agentColors = ['#3b82f6','#22c55e','#a855f7','#f59e0b','#ef4444','#ec4899','#06b6d4','#84cc16'];

    // Build 24 UTC hourly buckets from now backwards
    const hours = [];
    for (let i = 23; i >= 0; i--) {
        const h = new Date(currentUtcHour.getTime() - i * 3600000);
        hours.push({
            key: h.toISOString().slice(0, 13),
            label: `${String(h.getUTCHours()).padStart(2, '0')}:00`,
        });
    }

    const counts = new Map();
    _hourly.forEach(row => {
        if (!row || !row.hour || !row.agent_id) return;
        const key = `${new Date(row.hour).toISOString().slice(0, 13)}|${row.agent_id}`;
        counts.set(key, Number(row.count || 0));
    });

    const datasets = agents.map((agent, idx) => ({
        label: agent,
        data: hours.map(h => counts.get(`${h.key}|${agent}`) || 0),
        backgroundColor: agentColors[idx % agentColors.length],
        borderRadius: 3,
    }));
    ARIAChartHelpers.renderChart(_charts, 'chart-status', 'bar', { labels: hours.map(h => h.label), datasets }, { stacked: true, legendDisplay: true });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSessionDashboard() {
    await AriaModels.init();
    loadSessionStats();
    loadSessions();
    loadHourlySeries(24);
}

document.getElementById('status-filter').addEventListener('change', () => loadSessionDashboard());
document.getElementById('agent-filter').addEventListener('change', () => loadSessionDashboard());
document.getElementById('channel-filter').addEventListener('change', () => loadSessionDashboard());
document.getElementById('search-input').addEventListener('input', renderRecent);
document.getElementById('cron-toggle').addEventListener('change', () => loadSessionDashboard());

sessionsPager = new AriaPagination('sessions-pagination', {
    onPageChange: (page, limit) => loadSessions(page, limit),
    limit: 50
});
loadSessionDashboard();
setInterval(loadSessionDashboard, 30000);
</script>
{% endblock %}
