{% extends "base.html" %}
{% block title %}Soul & Identity{% endblock %}

{% block extra_css %}
<style>
    .soul-layout { display: grid; grid-template-columns: 280px 1fr; gap: 25px; min-height: 70vh; }
    .soul-sidebar { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; height: fit-content; max-height: calc(100vh - 130px); overflow-y: auto; position: sticky; top: 100px; }
    .soul-sidebar h3 { font-size: 13px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.02em; }
    .soul-nav-item { display: block; padding: 10px 14px; border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-size: 13px; cursor: pointer; transition: all 0.15s; border: none; background: none; width: 100%; text-align: left; }
    .soul-nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .soul-nav-item.active { background: rgba(99,102,241,0.15); color: var(--accent-primary); font-weight: 600; }
    .soul-content { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 30px; }
    .soul-content h1 { font-size: 24px; margin-bottom: 16px; }
    .soul-content h2 { font-size: 20px; margin-top: 24px; margin-bottom: 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
    .soul-content h3 { font-size: 16px; margin-top: 20px; margin-bottom: 8px; }
    .soul-content p { color: var(--text-secondary); line-height: 1.7; margin-bottom: 12px; }
    .soul-content code { background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; font-size: 13px; }
    .soul-content pre { background: var(--bg-tertiary); padding: 16px; border-radius: 8px; overflow-x: auto; margin: 12px 0; }
    .soul-content pre code { background: none; padding: 0; }
    .soul-content ul, .soul-content ol { color: var(--text-secondary); padding-left: 24px; margin-bottom: 12px; }
    .soul-content blockquote { border-left: 3px solid var(--accent-primary); padding-left: 16px; color: var(--text-muted); margin: 12px 0; }
    .soul-content table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    .soul-content th, .soul-content td { padding: 8px 12px; border: 1px solid var(--border-color); text-align: left; font-size: 13px; }
    .soul-content th { background: var(--bg-tertiary); font-weight: 600; }
    .read-only-badge { display: inline-block; padding: 4px 12px; background: rgba(245,158,11,0.15); color: #f59e0b; border-radius: 8px; font-size: 11px; font-weight: 600; margin-bottom: 20px; }
    /* File browser */
    .file-section { margin-top: 16px; }
    .file-section-header { display: flex; align-items: center; gap: 8px; padding: 11px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-secondary); background: none; border: none; width: 100%; text-align: left; transition: all 0.15s; }
    .file-section-header:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .file-section-header .chevron { transition: transform 0.2s; font-size: 10px; }
    .file-section-header.open .chevron { transform: rotate(90deg); }
    .file-tree { display: none; padding-left: 8px; max-height: 320px; overflow-y: auto; }
    .file-tree.open { display: block; }
    .file-tree-item { display: flex; align-items: center; gap: 6px; padding: 7px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; color: var(--text-muted); border: none; background: none; width: 100%; text-align: left; transition: all 0.15s; }
    .file-tree-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .file-tree-item.active { background: rgba(99,102,241,0.15); color: var(--accent-primary); }
    .file-tree-item .icon { font-size: 11px; width: 16px; text-align: center; }
    .file-tree-dir { display: flex; align-items: center; gap: 4px; font-weight: 600; color: var(--text-secondary); padding: 5px 10px 3px; font-size: 12px; margin-top: 2px; cursor: pointer; border-radius: 6px; border: none; background: none; width: 100%; text-align: left; transition: all 0.15s; }
    .file-tree-dir:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .file-tree-dir .dir-chevron { font-size: 8px; transition: transform 0.15s; width: 10px; }
    .file-tree-dir.collapsed .dir-chevron { transform: rotate(0deg); }
    .file-tree-dir.expanded .dir-chevron { transform: rotate(90deg); }
    .dir-children { display: none; }
    .file-meta { font-size: 10px; color: var(--text-muted); margin-left: auto; }
    .sidebar-divider { border-top: 1px solid var(--border-color); margin: 12px 0; }
    @media (max-width: 768px) {
        .soul-layout { grid-template-columns: 1fr; gap: 14px; }
        .soul-sidebar { position: static; max-height: none; }
        .file-section-header { font-size: 14px; padding: 12px; }
        .file-tree { max-height: 220px; }
        .soul-content { padding: 18px; }
    }
</style>
{% endblock %}

{% block content %}
<h1>âœ¨ Soul & Identity</h1>
<span class="read-only-badge">ğŸ”’ Read-Only â€” Identity files cannot be modified</span>
<div class="soul-layout">
    <div class="soul-sidebar">
        <h3>Workspace Roots</h3>

        <div class="file-section">
            <button id="section-memories" class="file-section-header" onclick="toggleSection('memories', this)">
                <span class="chevron">â–¶</span> ğŸ’¾ aria_memories
            </button>
            <div class="file-tree" id="tree-memories"></div>
        </div>

        <div class="file-section">
            <button id="section-souvenirs" class="file-section-header" onclick="toggleSection('souvenirs', this)">
                <span class="chevron">â–¶</span> ğŸ aria_souvenirs
            </button>
            <div class="file-tree" id="tree-souvenirs"></div>
        </div>

        <div class="file-section">
            <button id="section-mind" class="file-section-header" onclick="toggleSection('mind', this)">
                <span class="chevron">â–¶</span> ğŸ§  aria_mind
            </button>
            <div class="file-tree" id="tree-mind"></div>
        </div>

        <div class="file-section">
            <button id="section-agents" class="file-section-header" onclick="toggleSection('agents', this)">
                <span class="chevron">â–¶</span> ğŸ¤– aria_agents
            </button>
            <div class="file-tree" id="tree-agents"></div>
        </div>
    </div>
    <div class="soul-content" id="soul-content">
        <div style="text-align:center;padding:40px;color:var(--text-muted);">Loading...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// â”€â”€ File browser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _treeCache = {};
const RENDERABLE_EXTS = ['.md','.txt','.yaml','.yml','.json','.py','.sh','.toml','.cfg','.ini','.log','.csv','.html','.css','.js'];

function jsStringEscape(value) {
    return String(value).replace(/\\/g, '\\\\').replace(/'/g, "\\'");
}

function clearActiveFile() {
    document.querySelectorAll('.file-tree-item').forEach(b => b.classList.remove('active'));
}

function toggleSection(kind, headerBtn) {
    const tree = document.getElementById(`tree-${kind}`);
    const isOpen = tree.classList.contains('open');
    tree.classList.toggle('open');
    headerBtn.classList.toggle('open');
    if (!isOpen && !_treeCache[kind]) {
        loadTree(kind);
    }
}

async function loadTree(kind) {
    const tree = document.getElementById(`tree-${kind}`);
    tree.innerHTML = '<div style="padding:8px 10px;color:var(--text-muted);font-size:12px;">Loadingâ€¦</div>';
    try {
        const res = await fetch(`${API_BASE_URL}/admin/files/${kind}`);
        if (!res.ok) throw new Error(`${res.status}`);
        const items = await res.json();
        _treeCache[kind] = items;
        renderTree(kind, items);
    } catch (err) {
        tree.innerHTML = `<div style="padding:8px 10px;color:var(--danger);font-size:12px;">Error: ${escapeHtml(err.message)}</div>`;
    }
}

function renderTree(kind, items) {
    const tree = document.getElementById(`tree-${kind}`);
    const rootNode = { dirs: new Map(), files: [] };

    for (const item of items) {
        const parts = item.path.split('/').filter(Boolean);
        let node = rootNode;

        for (let index = 0; index < parts.length - 1; index++) {
            const part = parts[index];
            if (!node.dirs.has(part)) {
                node.dirs.set(part, { dirs: new Map(), files: [] });
            }
            node = node.dirs.get(part);
        }

        const leafName = parts[parts.length - 1];
        if (item.type === 'dir') {
            if (!node.dirs.has(leafName)) {
                node.dirs.set(leafName, { dirs: new Map(), files: [] });
            }
        } else {
            node.files.push(item);
        }
    }

    const html = renderTreeNode(kind, rootNode, 0, 'root');
    tree.innerHTML = html || '<div style="padding:8px 10px;color:var(--text-muted);font-size:12px;">No files</div>';
}

function renderTreeNode(kind, node, depth, pathKey) {
    let html = '';
    const indent = depth * 12;

    const sortedDirs = Array.from(node.dirs.keys()).sort((a, b) => a.localeCompare(b));
    for (const dirName of sortedDirs) {
        const child = node.dirs.get(dirName);
        const dirId = `dir-${kind}-${pathKey}-${dirName}`.replace(/[^a-zA-Z0-9_-]/g, '-');
        html += `<button class="file-tree-dir collapsed" style="padding-left:${10 + indent}px" onclick="toggleDir('${jsStringEscape(dirId)}')">`
            + `<span class="dir-chevron">â–¶</span> ğŸ“ ${escapeHtml(dirName)}</button>`;
        html += `<div id="${dirId}" class="dir-children">`;
        html += renderTreeNode(kind, child, depth + 1, `${pathKey}/${dirName}`);
        html += '</div>';
    }

    const sortedFiles = [...node.files].sort((a, b) => a.path.localeCompare(b.path));
    for (const item of sortedFiles) {
        const name = item.path.split('/').pop();
        const ext = '.' + name.split('.').pop().toLowerCase();
        const canOpen = RENDERABLE_EXTS.includes(ext);
        const sizeStr = item.size > 1024 ? `${(item.size / 1024).toFixed(1)}k` : `${item.size}b`;
        const icon = ext === '.md' ? 'ğŸ“„' : ext === '.py' ? 'ğŸ' : ext === '.yaml' || ext === '.yml' ? 'âš™ï¸' : ext === '.json' ? 'ğŸ“‹' : 'ğŸ“';
        if (canOpen) {
            html += `<button class="file-tree-item" style="padding-left:${10 + indent}px" onclick="loadFile('${jsStringEscape(kind)}','${jsStringEscape(item.path)}',this)">`
                + `<span class="icon">${icon}</span>${escapeHtml(name)}<span class="file-meta">${sizeStr}</span></button>`;
        } else {
            html += `<div class="file-tree-item" style="padding-left:${10 + indent}px;opacity:0.5;cursor:default;">`
                + `<span class="icon">${icon}</span>${escapeHtml(name)}<span class="file-meta">${sizeStr}</span></div>`;
        }
    }

    return html;
}

function toggleDir(dirId) {
    const el = document.getElementById(dirId);
    const btn = el?.previousElementSibling;
    if (!el || !btn) return;
    const hidden = el.style.display === 'none';
    el.style.display = hidden ? 'block' : 'none';
    btn.classList.toggle('expanded', hidden);
    btn.classList.toggle('collapsed', !hidden);
}

async function loadFile(kind, path, btn) {
    clearActiveFile();
    if (btn) btn.classList.add('active');
    const content = document.getElementById('soul-content');
    content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Loading...</div>';
    try {
        const res = await fetch(`${API_BASE_URL}/admin/files/${kind}/${encodeURIComponent(path)}`);
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const data = await res.json();
        const ext = path.split('.').pop().toLowerCase();
        if (ext === 'md') {
            content.innerHTML = marked.parse(data.content);
        } else if (['yaml','yml','json','py','sh','toml','cfg','ini','log','csv','html','css','js','txt'].includes(ext)) {
            content.innerHTML = `<h2 style="font-size:14px;color:var(--text-muted);margin-bottom:12px;">ğŸ“‚ ${escapeHtml(kind)}/${escapeHtml(data.path)}</h2><pre><code>${escapeHtml(data.content)}</code></pre>`;
        } else {
            content.innerHTML = `<p>${escapeHtml(data.content)}</p>`;
        }
    } catch (err) {
        content.innerHTML = `<p style="color:var(--danger);">Failed to load ${escapeHtml(path)}: ${escapeHtml(err.message)}</p>`;
    }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function initSoulView() {
    const mindHeader = document.getElementById('section-mind');
    if (mindHeader) {
        toggleSection('mind', mindHeader);
    }
    await loadFile('mind', 'SOUL.md');
})();
</script>
{% endblock %}
