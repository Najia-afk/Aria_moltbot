{% extends "base.html" %}
{% block title %}Soul & Identity{% endblock %}

{% block extra_css %}
<style>
    .soul-layout { display: grid; grid-template-columns: 240px 1fr; gap: 25px; min-height: 70vh; }
    .soul-sidebar { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; height: fit-content; position: sticky; top: 100px; }
    .soul-sidebar h3 { font-size: 13px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; }
    .soul-nav-item { display: block; padding: 10px 14px; border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-size: 13px; cursor: pointer; transition: all 0.15s; border: none; background: none; width: 100%; text-align: left; }
    .soul-nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .soul-nav-item.active { background: rgba(99,102,241,0.15); color: var(--accent-primary); font-weight: 600; }
    .soul-content { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 30px; }
    .soul-content h1 { font-size: 24px; margin-bottom: 16px; }
    .soul-content h2 { font-size: 20px; margin-top: 24px; margin-bottom: 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
    .soul-content h3 { font-size: 16px; margin-top: 20px; margin-bottom: 8px; }
    .soul-content p { color: var(--text-secondary); line-height: 1.7; margin-bottom: 12px; }
    .soul-content code { background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; font-size: 13px; }
    .soul-content pre { background: var(--bg-tertiary); padding: 16px; border-radius: 8px; overflow-x: auto; margin: 12px 0; }
    .soul-content pre code { background: none; padding: 0; }
    .soul-content ul, .soul-content ol { color: var(--text-secondary); padding-left: 24px; margin-bottom: 12px; }
    .soul-content blockquote { border-left: 3px solid var(--accent-primary); padding-left: 16px; color: var(--text-muted); margin: 12px 0; }
    .soul-content table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    .soul-content th, .soul-content td { padding: 8px 12px; border: 1px solid var(--border-color); text-align: left; font-size: 13px; }
    .soul-content th { background: var(--bg-tertiary); font-weight: 600; }
    .read-only-badge { display: inline-block; padding: 4px 12px; background: rgba(245,158,11,0.15); color: #f59e0b; border-radius: 8px; font-size: 11px; font-weight: 600; margin-bottom: 20px; }
    /* File browser */
    .file-section { margin-top: 16px; }
    .file-section-header { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-secondary); background: none; border: none; width: 100%; text-align: left; transition: all 0.15s; }
    .file-section-header:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .file-section-header .chevron { transition: transform 0.2s; font-size: 10px; }
    .file-section-header.open .chevron { transform: rotate(90deg); }
    .file-tree { display: none; padding-left: 8px; max-height: 300px; overflow-y: auto; }
    .file-tree.open { display: block; }
    .file-tree-item { display: flex; align-items: center; gap: 6px; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; color: var(--text-muted); border: none; background: none; width: 100%; text-align: left; transition: all 0.15s; }
    .file-tree-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .file-tree-item.active { background: rgba(99,102,241,0.15); color: var(--accent-primary); }
    .file-tree-item .icon { font-size: 11px; width: 16px; text-align: center; }
    .file-tree-dir { display: flex; align-items: center; gap: 4px; font-weight: 600; color: var(--text-secondary); padding: 5px 10px 3px; font-size: 12px; margin-top: 2px; cursor: pointer; border-radius: 6px; border: none; background: none; width: 100%; text-align: left; transition: all 0.15s; }
    .file-tree-dir:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .file-tree-dir .dir-chevron { font-size: 8px; transition: transform 0.15s; width: 10px; }
    .file-tree-dir.collapsed .dir-chevron { transform: rotate(0deg); }
    .file-tree-dir.expanded .dir-chevron { transform: rotate(90deg); }
    .file-meta { font-size: 10px; color: var(--text-muted); margin-left: auto; }
    .sidebar-divider { border-top: 1px solid var(--border-color); margin: 12px 0; }
    @media (max-width: 768px) { .soul-layout { grid-template-columns: 1fr; } .soul-sidebar { position: static; } }
</style>
{% endblock %}

{% block content %}
<h1>âœ¨ Soul & Identity</h1>
<span class="read-only-badge">ğŸ”’ Read-Only â€” Identity files cannot be modified</span>
<div class="soul-layout">
    <div class="soul-sidebar">
        <h3>Soul Documents</h3>
        <button class="soul-nav-item active" onclick="loadDoc('SOUL.md', this)">âœ¨ Soul</button>
        <button class="soul-nav-item" onclick="loadDoc('IDENTITY.md', this)">ğŸªª Identity</button>
        <button class="soul-nav-item" onclick="loadDoc('GOALS.md', this)">ğŸ¯ Goals</button>
        <button class="soul-nav-item" onclick="loadDoc('SECURITY.md', this)">ğŸ›¡ï¸ Security</button>
        <button class="soul-nav-item" onclick="loadDoc('HEARTBEAT.md', this)">ğŸ’“ Heartbeat</button>
        <button class="soul-nav-item" onclick="loadDoc('MEMORY.md', this)">ğŸ’¾ Memory</button>
        <button class="soul-nav-item" onclick="loadDoc('SKILLS.md', this)">ğŸ”§ Skills</button>
        <button class="soul-nav-item" onclick="loadDoc('TOOLS.md', this)">ğŸ› ï¸ Tools</button>
        <button class="soul-nav-item" onclick="loadDoc('USER.md', this)">ğŸ‘¤ User</button>
        <button class="soul-nav-item" onclick="loadDoc('AWAKENING.md', this)">ğŸŒ… Awakening</button>
        <button class="soul-nav-item" onclick="loadDoc('ORCHESTRATION.md', this)">ğŸ¼ Orchestration</button>
        <button class="soul-nav-item" onclick="loadDoc('AGENTS.md', this)">ğŸ¤– Agents</button>
        <button class="soul-nav-item" onclick="loadDoc('BOOTSTRAP.md', this)">ğŸš€ Bootstrap</button>

        <div class="sidebar-divider"></div>

        <!-- aria_mind file browser -->
        <div class="file-section">
            <button class="file-section-header" onclick="toggleSection('mind', this)">
                <span class="chevron">â–¶</span> ğŸ§  aria_mind
            </button>
            <div class="file-tree" id="tree-mind"></div>
        </div>

        <!-- aria_memories file browser -->
        <div class="file-section">
            <button class="file-section-header" onclick="toggleSection('memories', this)">
                <span class="chevron">â–¶</span> ğŸ’¾ aria_memories
            </button>
            <div class="file-tree" id="tree-memories"></div>
        </div>
    </div>
    <div class="soul-content" id="soul-content">
        <div style="text-align:center;padding:40px;color:var(--text-muted);">Loading...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// â”€â”€ Soul document loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDoc(filename, btn) {
    document.querySelectorAll('.soul-nav-item').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.file-tree-item').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    const content = document.getElementById('soul-content');
    content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Loading...</div>';
    try {
        const res = await fetch(`${API_BASE_URL}/soul/${encodeURIComponent(filename)}`);
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const data = await res.json();
        content.innerHTML = marked.parse(data.content);
    } catch (err) {
        content.innerHTML = `<p style="color:var(--danger);">Failed to load ${filename}: ${err.message}</p>`;
    }
}

// â”€â”€ File browser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _treeCache = {};

function toggleSection(kind, headerBtn) {
    const tree = document.getElementById(`tree-${kind}`);
    const isOpen = tree.classList.contains('open');
    tree.classList.toggle('open');
    headerBtn.classList.toggle('open');
    if (!isOpen && !_treeCache[kind]) loadTree(kind);
}

async function loadTree(kind) {
    const tree = document.getElementById(`tree-${kind}`);
    tree.innerHTML = '<div style="padding:8px 10px;color:var(--text-muted);font-size:12px;">Loadingâ€¦</div>';
    try {
        const res = await fetch(`${API_BASE_URL}/admin/files/${kind}`);
        if (!res.ok) throw new Error(`${res.status}`);
        const items = await res.json();
        _treeCache[kind] = items;
        renderTree(kind, items);
    } catch (err) {
        tree.innerHTML = `<div style="padding:8px 10px;color:var(--danger);font-size:12px;">Error: ${err.message}</div>`;
    }
}

function renderTree(kind, items) {
    const tree = document.getElementById(`tree-${kind}`);
    const renderableExts = ['.md','.txt','.yaml','.yml','.json','.py','.sh','.toml','.cfg','.ini','.log','.csv','.html','.css','.js'];
    let html = '';
    for (const item of items) {
        const depth = item.path.split('/').length - 1;
        const indent = depth * 12;
        if (item.type === 'dir') {
            const dirName = item.path.split('/').pop();
            const dirId = `dir-${kind}-${item.path.replace(/[\/\s]/g, '-')}`;
            html += `<button class="file-tree-dir expanded" style="padding-left:${10 + indent}px" onclick="toggleDir('${dirId}')">
                <span class="dir-chevron">â–¶</span> ğŸ“ ${dirName}
            </button>`;
            html += `<div id="${dirId}" class="dir-children">`;
        } else {
            const name = item.path.split('/').pop();
            const ext = '.' + name.split('.').pop().toLowerCase();
            const canOpen = renderableExts.includes(ext);
            const sizeStr = item.size > 1024 ? `${(item.size/1024).toFixed(1)}k` : `${item.size}b`;
            const icon = ext === '.md' ? 'ğŸ“„' : ext === '.py' ? 'ğŸ' : ext === '.yaml' || ext === '.yml' ? 'âš™ï¸' : ext === '.json' ? 'ğŸ“‹' : 'ğŸ“';
            if (canOpen) {
                html += `<button class="file-tree-item" style="padding-left:${10 + indent}px" onclick="loadFile('${kind}','${item.path}',this)">
                    <span class="icon">${icon}</span>${name}<span class="file-meta">${sizeStr}</span>
                </button>`;
            } else {
                html += `<div class="file-tree-item" style="padding-left:${10 + indent}px;opacity:0.5;cursor:default;">
                    <span class="icon">${icon}</span>${name}<span class="file-meta">${sizeStr}</span>
                </div>`;
            }
        }
    }
    // Close any open dir-children divs
    const openDirs = (html.match(/<div id="dir-/g) || []).length;
    const closedDirs = (html.match(/<\/div>/g) || []).length;
    for (let i = 0; i < openDirs - closedDirs; i++) html += '</div>';
    tree.innerHTML = html || '<div style="padding:8px 10px;color:var(--text-muted);font-size:12px;">No files</div>';
}

function toggleDir(dirId) {
    const el = document.getElementById(dirId);
    const btn = el?.previousElementSibling;
    if (!el || !btn) return;
    const hidden = el.style.display === 'none';
    el.style.display = hidden ? 'block' : 'none';
    btn.classList.toggle('expanded', hidden);
    btn.classList.toggle('collapsed', !hidden);
}

async function loadFile(kind, path, btn) {
    document.querySelectorAll('.soul-nav-item').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.file-tree-item').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    const content = document.getElementById('soul-content');
    content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Loading...</div>';
    try {
        const res = await fetch(`${API_BASE_URL}/admin/files/${kind}/${encodeURIComponent(path)}`);
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const data = await res.json();
        const ext = path.split('.').pop().toLowerCase();
        if (ext === 'md') {
            content.innerHTML = marked.parse(data.content);
        } else if (['yaml','yml','json','py','sh','toml','cfg','ini','log','csv','html','css','js','txt'].includes(ext)) {
            content.innerHTML = `<h2 style="font-size:14px;color:var(--text-muted);margin-bottom:12px;">ğŸ“‚ ${kind}/${data.path}</h2><pre><code>${escapeHtml(data.content)}</code></pre>`;
        } else {
            content.innerHTML = `<p>${data.content}</p>`;
        }
    } catch (err) {
        content.innerHTML = `<p style="color:var(--danger);">Failed to load ${path}: ${err.message}</p>`;
    }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadDoc('SOUL.md', document.querySelector('.soul-nav-item'));
</script>
{% endblock %}
