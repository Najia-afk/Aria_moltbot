{% extends "base.html" %}
{% block title %}Performance{% endblock %}

{% block extra_css %}
<style>
    .page-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }

    /* Tabs */
    .tabs { display: flex; gap: 0; margin-bottom: 25px; border-bottom: 2px solid var(--border-color); }
    .tab-btn { padding: 12px 24px; background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; color: var(--text-secondary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
    .tab-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.03); }
    .tab-btn.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }
    .tab-btn .badge { font-size: 11px; padding: 2px 7px; border-radius: 10px; background: rgba(124,58,237,0.15); color: #a855f7; font-weight: 700; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .stat-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; padding: 18px; }
    .stat-card h4 { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.03em; }
    .stat-card .value { font-size: 22px; font-weight: 700; color: var(--text-primary); }
    .stat-card.blue .value { color: var(--accent-blue); }
    .stat-card.green .value { color: var(--success); }
    .stat-card.purple .value { color: #a855f7; }
    .stat-card.orange .value { color: #f59e0b; }

    /* Charts */
    .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
    .chart-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; }
    .chart-card h4 { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; }
    .chart-card canvas { max-height: 250px; }

    /* Performance Cards */
    .section-title { font-size: 15px; font-weight: 600; margin: 20px 0 12px; display: flex; align-items: center; gap: 8px; }
    .performance-list { display: grid; gap: 12px; }
    .performance-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; }
    .performance-card-header { padding: 12px 16px; background: rgba(0,0,0,0.15); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .performance-period { font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px; }
    .performance-date { font-size: 11px; color: var(--text-muted); }
    .performance-card-body { padding: 14px 16px; }
    .performance-section { margin-bottom: 10px; }
    .performance-section:last-child { margin-bottom: 0; }
    .performance-section h4 { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .performance-section-content { padding: 8px 12px; background: var(--bg-primary); border-radius: 8px; font-size: 13px; line-height: 1.6; white-space: pre-wrap; }
    .performance-section-content.success { border-left: 3px solid #22c55e; }
    .performance-section-content.failure { border-left: 3px solid #ef4444; }
    .performance-section-content.improvement { border-left: 3px solid #f59e0b; }

    /* Task Cards */
    .task-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; padding: 14px 16px; margin-bottom: 10px; }
    .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
    .task-title { font-weight: 600; font-size: 14px; }
    .task-status { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
    .task-status.pending { background: rgba(245,158,11,0.2); color: #f59e0b; }
    .task-status.in_progress { background: rgba(59,130,246,0.2); color: #3b82f6; }
    .task-status.completed { background: rgba(34,197,94,0.2); color: #22c55e; }
    .task-meta { font-size: 12px; color: var(--text-muted); display: flex; gap: 12px; flex-wrap: wrap; }

    .empty-state { text-align: center; padding: 50px 20px; color: var(--text-secondary); background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; }

    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; width: 100%; max-width: 600px; margin: 1rem; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 13px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); font-size: 13px; }
    .form-group textarea { min-height: 80px; resize: vertical; }

    .btn-add { padding: 8px 16px; background: var(--accent-primary); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; }

    @media (max-width: 768px) { .charts-row { grid-template-columns: 1fr; } .tabs { overflow-x: auto; } .tab-btn { padding: 10px 16px; font-size: 13px; white-space: nowrap; } }
</style>
{% endblock %}

{% block content %}
<div class="page-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
    <div>
        <h1>ğŸ“Š Performance & Tasks</h1>
        <p>Track reviews, tasks & performance analytics</p>
    </div>
    <button class="btn-add" onclick="showAddReviewModal()">â• Add Review</button>
</div>

<div class="stats-grid">
    <div class="stat-card blue">
        <h4>Reviews</h4>
        <div class="value" id="review-count">-</div>
    </div>
    <div class="stat-card orange">
        <h4>Pending Tasks</h4>
        <div class="value" id="pending-tasks">-</div>
    </div>
    <div class="stat-card purple">
        <h4>In Progress</h4>
        <div class="value" id="inprogress-tasks">-</div>
    </div>
    <div class="stat-card green">
        <h4>Completed Tasks</h4>
        <div class="value" id="completed-tasks">-</div>
    </div>
</div>

<!-- Tabs -->
<div class="tabs">
    <button class="tab-btn active" data-tab="reviews">
        ğŸ“Š Reviews <span class="badge" id="tab-badge-reviews">-</span>
    </button>
    <button class="tab-btn" data-tab="tasks">
        ğŸ“‹ Tasks <span class="badge" id="tab-badge-tasks">-</span>
    </button>
</div>

<!-- â•â•â• REVIEWS TAB â•â•â• -->
<div class="tab-panel active" id="panel-reviews">
    <div class="charts-row">
        <div class="chart-card">
            <h4>ğŸ“Š Reviews by Period</h4>
            <canvas id="chart-review-periods"></canvas>
        </div>
        <div class="chart-card">
            <h4>ğŸ“ˆ Task Status Distribution</h4>
            <canvas id="chart-task-status"></canvas>
        </div>
    </div>
    <h3 class="section-title">ğŸ“ Performance Reviews</h3>
    <div class="performance-list" id="reviews-list">
        <div class="empty-state">Loading performance reviews...</div>
    </div>
</div>

<!-- â•â•â• TASKS TAB â•â•â• -->
<div class="tab-panel" id="panel-tasks">
    <div class="performance-list" id="tasks-list">
        <div class="empty-state">Loading tasks...</div>
    </div>
</div>

<!-- Add Review Modal -->
<div class="modal" id="add-review-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>â• Add Performance Review</h3>
            <button class="modal-close" onclick="closeModal('add-review-modal')">&times;</button>
        </div>
        <form onsubmit="addReview(event)">
            <div class="form-group">
                <label>Review Period</label>
                <select id="review-period">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                </select>
            </div>
            <div class="form-group">
                <label>âœ… Successes</label>
                <textarea id="review-successes" placeholder="What went well? List accomplishments..."></textarea>
            </div>
            <div class="form-group">
                <label>âŒ Failures / Challenges</label>
                <textarea id="review-failures" placeholder="What didn't work? What obstacles were encountered?"></textarea>
            </div>
            <div class="form-group">
                <label>ğŸ’¡ Improvements / Learnings</label>
                <textarea id="review-improvements" placeholder="What can be improved? Key learnings?"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%">Save Review</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/chart-helpers.js"></script>
<script data-page-script>
// â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _reviews = [];
let _tasks = [];
let _charts = {};

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
    });
});

// â”€â”€ Load Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPerformance() {
    try {
        const [reviewsRes, tasksRes] = await Promise.all([
            fetch(`${API_BASE_URL}/performance`),
            fetch(`${API_BASE_URL}/tasks`)
        ]);
        const reviewsData = await reviewsRes.json();
        const tasksData = await tasksRes.json();

        _reviews = reviewsData.logs || [];
        _tasks = tasksData.tasks || [];

        // Stats
        const pending = _tasks.filter(t => t.status === 'pending').length;
        const inProgress = _tasks.filter(t => t.status === 'in_progress').length;
        const completed = _tasks.filter(t => t.status === 'completed').length;

        document.getElementById('review-count').textContent = _reviews.length;
        document.getElementById('pending-tasks').textContent = pending;
        document.getElementById('inprogress-tasks').textContent = inProgress;
        document.getElementById('completed-tasks').textContent = completed;
        document.getElementById('tab-badge-reviews').textContent = _reviews.length;
        document.getElementById('tab-badge-tasks').textContent = _tasks.length;

        renderReviews();
        renderTasks();
        renderCharts(pending, inProgress, completed);
    } catch (e) {
        console.error('Failed to load performance data:', e);
    }
}

// â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCharts(pending, inProgress, completed) {
    // Review by period type
    const periodCounts = {};
    _reviews.forEach(r => {
        const p = r.review_period || 'unknown';
        periodCounts[p] = (periodCounts[p] || 0) + 1;
    });
    const periodLabels = Object.keys(periodCounts);
    if (periodLabels.length > 0) {
        ARIAChartHelpers.renderChart(_charts, 'chart-review-periods', 'bar', {
            labels: periodLabels,
            datasets: [{
                label: 'Reviews',
                data: Object.values(periodCounts),
                backgroundColor: ['#3b82f6', '#a855f7', '#f59e0b', '#22c55e'],
                borderRadius: 6,
            }]
        });
    }

    // Task status doughnut
    const taskData = [pending, inProgress, completed].some(v => v > 0)
        ? [pending, inProgress, completed] : [0, 0, 0];
    ARIAChartHelpers.renderChart(_charts, 'chart-task-status', 'doughnut', {
        labels: ['Pending', 'In Progress', 'Completed'],
        datasets: [{
            data: taskData,
            backgroundColor: ['#f59e0b', '#3b82f6', '#22c55e'],
            borderWidth: 0,
        }]
    });
}

// â”€â”€ Render Reviews â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReviews() {
    const container = document.getElementById('reviews-list');
    if (_reviews.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No performance reviews yet</h3><p>Start tracking by adding the first review!</p></div>';
        return;
    }
    container.innerHTML = _reviews.map(review => `
        <div class="performance-card">
            <div class="performance-card-header">
                <span class="performance-period">ğŸ“… ${review.review_period} Review</span>
                <span class="performance-date">${formatDate(review.created_at)}</span>
            </div>
            <div class="performance-card-body">
                ${review.successes ? `<div class="performance-section"><h4>âœ… Successes</h4><div class="performance-section-content success">${escapeHtml(review.successes)}</div></div>` : ''}
                ${review.failures ? `<div class="performance-section"><h4>âŒ Failures / Challenges</h4><div class="performance-section-content failure">${escapeHtml(review.failures)}</div></div>` : ''}
                ${review.improvements ? `<div class="performance-section"><h4>ğŸ’¡ Improvements</h4><div class="performance-section-content improvement">${escapeHtml(review.improvements)}</div></div>` : ''}
            </div>
        </div>
    `).join('');
}

// â”€â”€ Render Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTasks() {
    const container = document.getElementById('tasks-list');
    if (_tasks.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No complex tasks</h3><p>Complex tasks assigned to Aria will appear here.</p></div>';
        return;
    }
    container.innerHTML = _tasks.map(task => `
        <div class="task-card">
            <div class="task-header">
                <span class="task-title">${escapeHtml(task.description)}</span>
                <span class="task-status ${task.status}">${task.status}</span>
            </div>
            <div class="task-meta">
                <span>ğŸ·ï¸ ${task.task_type}</span>
                <span>ğŸ¤– ${task.agent_type}</span>
                <span>âš¡ ${task.priority}</span>
                <span>ğŸ“… ${formatDate(task.created_at)}</span>
            </div>
            ${task.result ? `<div style="margin-top:6px;padding:8px 12px;background:var(--bg-primary);border-radius:8px;font-size:13px">ğŸ“ ${escapeHtml(task.result)}</div>` : ''}
        </div>
    `).join('');
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAddReviewModal() { document.getElementById('add-review-modal').classList.add('active'); }

async function addReview(event) {
    event.preventDefault();
    const review_period = document.getElementById('review-period').value;
    const successes = document.getElementById('review-successes').value;
    const failures = document.getElementById('review-failures').value;
    const improvements = document.getElementById('review-improvements').value;
    try {
        const response = await fetch(`${API_BASE_URL}/performance`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ review_period, successes, failures, improvements })
        });
        if (response.ok) {
            closeModal('add-review-modal');
            document.getElementById('review-successes').value = '';
            document.getElementById('review-failures').value = '';
            document.getElementById('review-improvements').value = '';
            loadPerformance();
        }
    } catch (e) { console.error('Failed to add review:', e); }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initPerformancePage() {
    await AriaModels.init();
    loadPerformance();
}
initPerformancePage();
</script>
{% endblock %}
