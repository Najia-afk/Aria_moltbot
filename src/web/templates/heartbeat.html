{% extends "base.html" %}
{% block title %}Heartbeat - Aria Blue{% endblock %}

{% block page_title %}üíì Heartbeat{% endblock %}
{% block page_subtitle %}Scheduled jobs and system pulse{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="openAddJobModal()">
    ‚ûï Add Job
</button>
<button class="btn btn-secondary" onclick="syncJobs()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M23 4v6h-6M1 20v-6h6M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
    </svg>
    Sync Jobs
</button>
<button class="btn btn-primary" onclick="triggerTick()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="5 3 19 12 5 21 5 3"/>
    </svg>
    Manual Tick
</button>
{% endblock %}

{% block content %}
<!-- Heartbeat Status Overview -->
<div class="heartbeat-hero">
    <div class="pulse-indicator" id="pulseIndicator">
        <div class="pulse-ring"></div>
        <div class="pulse-core">üíì</div>
    </div>
    <div class="heartbeat-status">
        <h2 id="heartbeatStatus">Checking...</h2>
        <p id="lastTickTime">Last tick: --</p>
    </div>
</div>

<!-- Stats Overview -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üîÑ</div>
        <div class="stat-info">
            <span class="stat-value" id="totalJobs">12</span>
            <span class="stat-label">Scheduled Jobs</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-info">
            <span class="stat-value" id="successfulRuns">-</span>
            <span class="stat-label">Successful (24h)</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-info">
            <span class="stat-value" id="failedRuns">-</span>
            <span class="stat-label">Failed (24h)</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">‚è∞</div>
        <div class="stat-info">
            <span class="stat-value" id="nextJob">-</span>
            <span class="stat-label">Next Job In</span>
        </div>
    </div>
</div>

<!-- Scheduled Jobs Grid -->
<section class="section">
    <div class="section-header">
        <h2>‚è∞ Scheduled Jobs</h2>
        <p>Aria's recurring tasks and their schedules</p>
    </div>
    <div class="jobs-grid" id="jobsGrid">
        <!-- Jobs will be rendered here -->
    </div>
</section>

<!-- Recent Executions -->
<section class="section">
    <div class="section-header">
        <h2>üìã Recent Executions</h2>
        <div class="section-actions">
            <select id="logLimit" onchange="filterLogs()" style="margin-right: 8px;">
                <option value="20" selected>Last 20</option>
                <option value="50">Last 50</option>
                <option value="100">Last 100</option>
            </select>
            <select id="logFilter" onchange="filterLogs()">
                <option value="all">All Jobs</option>
                <option value="work_cycle">Work Cycle</option>
                <option value="hourly_goal_check">Hourly Goal Check</option>
                <option value="six_hour_review">Six Hour Review</option>
                <option value="moltbook_post">Moltbook Post</option>
                <option value="subagent_delegation">Sub-agent Delegation</option>
                <option value="daily_reflection">Daily Reflection</option>
                <option value="morning_checkin">Morning Check-in</option>
                <option value="weekly_summary">Weekly Summary</option>
                <option value="social_presence">Social Presence</option>
                <option value="db_maintenance">DB Maintenance</option>
                <option value="subagent_management">Sub-agent Management</option>
                <option value="health_check">Health Check</option>
            </select>
        </div>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Job Name</th>
                    <th>Status</th>
                    <th>Details</th>
                    <th>Executed At</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody id="logsTable">
                <tr><td colspan="5" class="loading"><div class="spinner"></div></td></tr>
            </tbody>
        </table>
    </div>
</section>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<!-- Add / Edit Job Modal -->
<div id="cronJobModal" class="cron-modal-overlay" onclick="if(event.target===this)closeJobModal()">
<div class="cron-modal-card" style="max-width:640px;max-height:90vh;overflow-y:auto;">
    <div class="cron-modal-header">
        <h3 id="cronModalTitle">Add Cron Job</h3>
        <button class="cron-btn-icon" onclick="closeJobModal()">&times;</button>
    </div>
    <form id="cronJobForm" onsubmit="return saveCronJob(event)">
        <div class="cron-form-grid">
            <div class="cron-form-group">
                <label for="jId">Job ID</label>
                <input id="jId" name="id" maxlength="100" placeholder="auto-generated if blank" class="cron-form-input" autocomplete="off">
            </div>
            <div class="cron-form-group">
                <label for="jName">Name *</label>
                <input id="jName" name="name" required maxlength="200" placeholder="work_cycle" class="cron-form-input">
            </div>
            <div class="cron-form-group">
                <label for="jSchedule">Schedule (cron) *</label>
                <input id="jSchedule" name="schedule" required maxlength="100" placeholder="*/5 * * * *" class="cron-form-input" style="font-family:var(--font-mono);">
            </div>
            <div class="cron-form-group">
                <label for="jAgent">Agent ID</label>
                <input id="jAgent" name="agent_id" maxlength="100" value="aria" class="cron-form-input">
            </div>
            <div class="cron-form-group">
                <label for="jType">Payload Type</label>
                <select id="jType" name="payload_type" class="cron-form-input">
                    <option value="prompt">Prompt</option>
                    <option value="skill">Skill</option>
                    <option value="pipeline">Pipeline</option>
                </select>
            </div>
            <div class="cron-form-group">
                <label for="jSession">Session Mode</label>
                <select id="jSession" name="session_mode" class="cron-form-input">
                    <option value="isolated">Isolated</option>
                    <option value="shared">Shared</option>
                    <option value="persistent">Persistent</option>
                </select>
            </div>
            <div class="cron-form-group" style="grid-column:1/-1;">
                <label for="jPayload">Payload *</label>
                <textarea id="jPayload" name="payload" required rows="3" class="cron-form-input" style="resize:vertical;font-family:var(--font-mono);font-size:12px;"
                          placeholder="Describe the task for this cron job..."></textarea>
            </div>
            <div class="cron-form-group">
                <label for="jMaxDuration">Max Duration (sec)</label>
                <input id="jMaxDuration" name="max_duration_seconds" type="number" min="10" max="3600" value="300" class="cron-form-input">
            </div>
            <div class="cron-form-group">
                <label for="jRetry">Retry Count</label>
                <input id="jRetry" name="retry_count" type="number" min="0" max="5" value="0" class="cron-form-input">
            </div>
            <div class="cron-form-group" style="grid-column:1/-1;">
                <label style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="jEnabled" name="enabled" checked> ‚úÖ Enabled
                </label>
            </div>
        </div>
        <div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="closeJobModal()">Cancel</button>
            <button type="submit" class="btn btn-primary btn-sm">üíæ Save</button>
        </div>
    </form>
</div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Heartbeat Hero */
.heartbeat-hero {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xl);
    padding: var(--space-2xl);
    background: linear-gradient(180deg, var(--bg-tertiary) 0%, transparent 100%);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-xl);
}

.pulse-indicator {
    position: relative;
    width: 100px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.pulse-ring {
    position: absolute;
    inset: 0;
    border: 3px solid var(--accent-primary);
    border-radius: 50%;
    animation: pulse-ring 2s ease-out infinite;
}

.pulse-ring::before {
    content: '';
    position: absolute;
    inset: -10px;
    border: 2px solid var(--accent-primary);
    border-radius: 50%;
    opacity: 0.5;
    animation: pulse-ring 2s ease-out infinite 0.5s;
}

@keyframes pulse-ring {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    100% {
        transform: scale(1.5);
        opacity: 0;
    }
}

.pulse-core {
    font-size: 3rem;
    animation: pulse-beat 1s ease-in-out infinite;
}

@keyframes pulse-beat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.pulse-indicator.offline .pulse-ring,
.pulse-indicator.offline .pulse-ring::before {
    border-color: var(--danger);
    animation: none;
}

.pulse-indicator.offline .pulse-core {
    animation: none;
    opacity: 0.5;
}

.heartbeat-status {
    text-align: left;
}

.heartbeat-status h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.heartbeat-status p {
    color: var(--text-muted);
    font-size: 0.9rem;
}

/* Section */
.section {
    margin-bottom: var(--space-xl);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
    gap: var(--space-md);
}

.section-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
}

.section-header p {
    color: var(--text-muted);
    font-size: 0.9rem;
    width: 100%;
}

.section-actions select {
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.85rem;
    cursor: pointer;
}

/* Jobs Grid */
.jobs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-lg);
}

/* Job Card */
.job-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    transition: all var(--transition-base);
    position: relative;
    overflow: hidden;
}

.job-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent-gradient);
    transform: scaleX(0);
    transition: transform var(--transition-base);
}

.job-card:hover {
    border-color: var(--border-accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.job-card:hover::before {
    transform: scaleX(1);
}

.job-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
}

.job-icon {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    font-size: 1.5rem;
    flex-shrink: 0;
}

.job-info {
    flex: 1;
}

.job-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.job-schedule {
    font-size: 0.8rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
}

.job-status {
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-full);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.job-status.active {
    background: var(--success-bg);
    color: var(--success);
}

.job-status.idle {
    background: var(--info-bg);
    color: var(--info);
}

.job-status.error {
    background: var(--danger-bg);
    color: var(--danger);
}

.job-description {
    color: var(--text-secondary);
    font-size: 0.85rem;
    line-height: 1.5;
    margin-bottom: var(--space-md);
}

.job-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-subtle);
    font-size: 0.8rem;
}

.job-meta-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.job-meta-label {
    color: var(--text-dim);
    font-size: 0.7rem;
    text-transform: uppercase;
}

.job-meta-value {
    color: var(--text-secondary);
}

.job-meta-value.next {
    color: var(--accent-primary);
    font-weight: 600;
}

/* Table Styles */
.table-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.log-status {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
}

.log-status.success {
    background: var(--success-bg);
    color: var(--success);
}

.log-status.error {
    background: var(--danger-bg);
    color: var(--danger);
}

.log-status.running {
    background: var(--info-bg);
    color: var(--info);
}

.log-details {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--text-muted);
    font-size: 0.85rem;
}

/* Toast */
.toast {
    position: fixed;
    bottom: var(--space-xl);
    right: var(--space-xl);
    padding: var(--space-md) var(--space-lg);
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: 0.9rem;
    box-shadow: var(--shadow-xl);
    transform: translateY(100px);
    opacity: 0;
    transition: all var(--transition-base);
    z-index: var(--z-tooltip);
}

.toast.show {
    transform: translateY(0);
    opacity: 1;
}

.toast.success {
    border-color: var(--success);
}

.toast.error {
    border-color: var(--danger);
}

/* Cron Job Modal */
.cron-modal-overlay {
    position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,.6);
    display: none; align-items: center; justify-content: center; padding: 16px;
}
.cron-modal-overlay.active {
    display: flex;
}
.cron-modal-card {
    background: var(--bg-secondary, #1e1e2e); border: 1px solid var(--border-subtle, #333);
    border-radius: 12px; padding: 24px; width: 100%;
}
.cron-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.cron-modal-header h3 { margin: 0; font-size: 18px; color: var(--text-primary, #fff); }
.cron-btn-icon { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--text-secondary); }
.cron-btn-icon:hover { color: var(--text-primary); }
.cron-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.cron-form-group label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; }
.cron-form-input {
    width: 100%; padding: 7px 10px; border: 1px solid var(--border-subtle, #444);
    border-radius: 6px; background: var(--bg-tertiary, #111); color: var(--text-primary, #fff);
    font-size: 13px; box-sizing: border-box;
}
.cron-form-input:focus { outline: none; border-color: var(--accent-primary, #7c3aed); }

/* Job Card Actions */
.job-card-actions {
    display: flex; gap: 6px; margin-top: 10px; padding-top: 10px;
    border-top: 1px solid var(--border-subtle, #333);
}
.job-card.disabled { opacity: .55; }

/* Loading */
.loading {
    text-align: center;
    padding: var(--space-xl);
    color: var(--text-muted);
}

@media (max-width: 640px) {
    .heartbeat-hero {
        flex-direction: column;
        text-align: center;
    }
    
    .heartbeat-status {
        text-align: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script data-page-script>
// Scheduled Jobs - fetched from API
let scheduledJobs = [];
let allLogs = [];

// Utility: relative time formatting
function formatRelativeTime(date) {
    if (!date || isNaN(date.getTime())) return '-';
    const now = new Date();
    const diffMs = now - date;
    const absDiff = Math.abs(diffMs);
    const isFuture = diffMs < 0;

    const seconds = Math.floor(absDiff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    let text;
    if (seconds < 60) text = `${seconds}s`;
    else if (minutes < 60) text = `${minutes}m`;
    else if (hours < 24) text = `${hours}h ${minutes % 60}m`;
    else text = `${days}d ${hours % 24}h`;

    return isFuture ? `in ${text}` : `${text} ago`;
}

// Icon mapping for job names
const jobIcons = {
    'work_cycle': '‚ö°',
    'hourly_goal_check': 'üéØ',
    'six_hour_review': 'üìä',
    'moltbook_post': 'ü¶û',
    'subagent_delegation': 'ü§ñ',
    'daily_reflection': 'üåô',
    'morning_checkin': '‚òÄÔ∏è',
    'weekly_summary': 'üìà',
    'social_presence': 'üí¨',
    'db_maintenance': 'üóÑÔ∏è',
    'subagent_management': 'üîç',
    'health_check': 'üè•'
};

// Human-readable frequency from cron expression
function cronToFrequency(expr) {
    const patterns = {
        '*/1 * * * *': 'Every minute',
        '*/5 * * * *': 'Every 5 minutes',
        '*/15 * * * *': 'Every 15 minutes',
        '*/30 * * * *': 'Every 30 minutes',
        '0 * * * *': 'Every hour',
        '0 */2 * * *': 'Every 2 hours',
        '0 */4 * * *': 'Every 4 hours',
        '0 */6 * * *': 'Every 6 hours',
        '0 */12 * * *': 'Every 12 hours',
        '0 0 * * *': 'Daily at midnight',
        '0 3 * * *': 'Daily at 3 AM',
        '0 8 * * *': 'Daily at 8 AM',
        '0 23 * * *': 'Daily at 11 PM',
        '0 18 * * 0': 'Sunday 6 PM',
        '0 0 * * 0': 'Weekly (Sunday)',
        '0 0 1 * *': 'Monthly'
    };
    return patterns[expr] || expr;
}

async function loadHeartbeatData() {
    await Promise.all([
        loadScheduledJobs(),
        loadScheduleStatus()
        // Note: loadHeartbeatLogs() removed - logs now populated from jobs/live data
    ]);
}

const API_BASE = window.ARIA_API_BASE_URL || '/api';

function escapeHtml(str) {
    if (!str) return '';
    const d = document.createElement('div');
    d.textContent = String(str);
    return d.innerHTML;
}

async function loadScheduledJobs() {
    try {
        // Try live endpoint first (direct from cron_jobs.yaml), fallback to DB
        let response = await fetch(`${API_BASE}/jobs/live`);
        let data = await response.json();
        let jobs = Array.isArray(data?.jobs) ? data.jobs : (Array.isArray(data) ? data : []);
        
        // If live has no jobs, try synced DB version
        if (jobs.length === 0 && !data?.error) {
            response = await fetch(`${API_BASE}/jobs`);
            data = await response.json();
            jobs = Array.isArray(data?.jobs) ? data.jobs : (Array.isArray(data) ? data : []);
        }
        
        if (jobs.length > 0) {
            scheduledJobs = jobs.map(job => ({
                id: job.id,
                name: job.name,
                icon: jobIcons[job.name] || 'üìã',
                schedule: job.schedule_expr,
                description: job.payload_text ? job.payload_text.substring(0, 100) + '...' : 'No description',
                frequency: cronToFrequency(job.schedule_expr),
                enabled: job.enabled,
                lastRun: job.last_run_at,
                nextRun: job.next_run_at,
                lastStatus: job.last_status,
                lastDurationMs: job.last_duration_ms
            }));
            document.getElementById('totalJobs').textContent = scheduledJobs.length;
            
            // Calculate successful/failed stats from job data (last 24h)
            const now = new Date();
            const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            let successful = 0;
            let failed = 0;
            
            for (const job of scheduledJobs) {
                if (job.lastRun) {
                    const lastRunDate = new Date(job.lastRun);
                    if (lastRunDate >= oneDayAgo) {
                        if (job.lastStatus === 'ok') {
                            successful++;
                        } else if (job.lastStatus === 'error') {
                            failed++;
                        }
                    }
                }
            }
            
            document.getElementById('successfulRuns').textContent = successful;
            document.getElementById('failedRuns').textContent = failed;
            
            // Populate allLogs from job data for Recent Executions table
            allLogs = scheduledJobs
                .filter(job => job.lastRun)
                .map(job => ({
                    job_name: job.name,
                    status: job.lastStatus === 'ok' ? 'success' : job.lastStatus,
                    executed_at: job.lastRun,
                    details: `Schedule: ${job.schedule}`,
                    duration: job.lastDurationMs
                }));
            
            filterLogs();
        } else {
            // No jobs found anywhere
            scheduledJobs = [];
            document.getElementById('totalJobs').textContent = '0';
            document.getElementById('successfulRuns').textContent = '0';
            document.getElementById('failedRuns').textContent = '0';
        }
        
        renderJobsGrid();
    } catch (error) {
        console.error('Failed to load jobs:', error);
        document.getElementById('jobsGrid').innerHTML = `
            <div class="empty-state">
                <p>‚ö†Ô∏è Failed to load jobs from API</p>
                <button class="btn btn-primary" onclick="syncJobs()">Sync Jobs</button>
            </div>
        `;
    }
}

async function syncJobs() {
    try {
        showToast('Syncing jobs...', 'info');
        const response = await fetch(`${API_BASE}/jobs/sync`, { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            showToast(`‚úÖ Synced ${data.synced} jobs`, 'success');
            await loadScheduledJobs();
        } else {
            showToast(`‚ùå Sync failed: ${data.detail}`, 'error');
        }
    } catch (error) {
        showToast(`‚ùå Sync error: ${error.message}`, 'error');
    }
}

async function loadScheduleStatus() {
    try {
        const response = await fetch(`${API_BASE}/schedule`);
        const data = await response.json();
        
        document.getElementById('heartbeatStatus').textContent = 'System Active';
        document.getElementById('pulseIndicator').classList.remove('offline');
        
        if (data.last_tick) {
            const lastTick = new Date(data.last_tick);
            document.getElementById('lastTickTime').textContent = `Last tick: ${formatRelativeTime(lastTick)}`;
        }
        
        // Use new columns from schedule_tick if available
        if (data.jobs_total !== undefined && data.jobs_total !== null) {
            document.getElementById('totalJobs').textContent = data.jobs_total;
        }
        if (data.jobs_successful !== undefined && data.jobs_successful !== null) {
            document.getElementById('successfulRuns').textContent = data.jobs_successful;
        }
        if (data.jobs_failed !== undefined && data.jobs_failed !== null) {
            document.getElementById('failedRuns').textContent = data.jobs_failed;
        }
        if (data.next_job_at) {
            const nextJobTime = new Date(data.next_job_at);
            document.getElementById('nextJob').textContent = formatRelativeTime(nextJobTime);
        }
    } catch (error) {
        document.getElementById('heartbeatStatus').textContent = 'System Offline';
        document.getElementById('pulseIndicator').classList.add('offline');
        document.getElementById('lastTickTime').textContent = 'Unable to reach scheduler';
    }
}

async function loadHeartbeatLogs() {
    try {
        const response = await fetch(`${API_BASE}/records?table=heartbeat_log&limit=100`);
        const data = await response.json();
        allLogs = data.records || data || [];
        
        updateLogStats();
        filterLogs();
    } catch (error) {
        document.getElementById('logsTable').innerHTML = `
            <tr><td colspan="5" class="empty-state">Error loading logs: ${error.message}</td></tr>
        `;
    }
}

function updateLogStats() {
    const now = new Date();
    const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    const recentLogs = allLogs.filter(log => {
        const logTime = new Date(log.executed_at || log.created_at);
        return logTime >= oneDayAgo;
    });
    
    const successful = recentLogs.filter(log => log.status === 'success' || log.status === 'completed').length;
    const failed = recentLogs.filter(log => log.status === 'error' || log.status === 'failed').length;
    
    document.getElementById('successfulRuns').textContent = successful;
    document.getElementById('failedRuns').textContent = failed;
    
    // Calculate next job (simplified - based on work_cycle every 5 min)
    const minutes = now.getMinutes();
    const nextTickMin = Math.ceil(minutes / 5) * 5 - minutes;
    document.getElementById('nextJob').textContent = nextTickMin === 0 ? 'Now' : `${nextTickMin}m`;
}

function renderJobsGrid() {
    const container = document.getElementById('jobsGrid');
    
    if (scheduledJobs.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                <h3>üìã No Scheduled Jobs Found</h3>
                <p>Jobs haven't been synced yet.</p>
                <button class="btn btn-primary" onclick="syncJobs()" style="margin-top: 1rem;">
                    üîÑ Sync Jobs
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = scheduledJobs.map(job => {
        // Use real data from API
        const lastRun = job.lastRun ? formatRelativeTime(new Date(job.lastRun)) : 'Never';
        const nextRun = job.nextRun ? formatRelativeTime(new Date(job.nextRun)) : 'Unknown';
        const status = !job.enabled ? 'disabled' : 
                       job.lastStatus === 'error' ? 'error' : 
                       job.lastStatus === 'ok' ? 'active' : 'idle';
        const statusLabel = !job.enabled ? 'Disabled' : 
                           job.lastStatus === 'ok' ? 'Active' : 
                           job.lastStatus || 'Idle';
        const escapedId = escapeHtml(job.id || job.name);
        
        return `
            <div class="job-card ${!job.enabled ? 'disabled' : ''}">
                <div class="job-header">
                    <div class="job-icon">${job.icon}</div>
                    <div class="job-info">
                        <div class="job-name">${escapeHtml(job.name)}</div>
                        <div class="job-schedule">${escapeHtml(job.schedule)}</div>
                    </div>
                    <span class="job-status ${status}">${statusLabel}</span>
                </div>
                <p class="job-description">${escapeHtml(job.description)}</p>
                <div class="job-meta">
                    <div class="job-meta-item">
                        <span class="job-meta-label">Frequency</span>
                        <span class="job-meta-value">${job.frequency}</span>
                    </div>
                    <div class="job-meta-item">
                        <span class="job-meta-label">Last Run</span>
                        <span class="job-meta-value">${lastRun}</span>
                    </div>
                    <div class="job-meta-item">
                        <span class="job-meta-label">Next Run</span>
                        <span class="job-meta-value">${nextRun}</span>
                    </div>
                    ${job.lastDurationMs ? `
                    <div class="job-meta-item">
                        <span class="job-meta-label">Duration</span>
                        <span class="job-meta-value">${formatDuration(job.lastDurationMs)}</span>
                    </div>
                    ` : ''}
                </div>
                <div class="job-card-actions">
                    <button class="btn btn-secondary btn-sm" onclick="openEditJobModal('${escapedId}')" style="font-size:12px;">‚úèÔ∏è Edit</button>
                    <button class="btn btn-secondary btn-sm" onclick="triggerSingleJob('${escapedId}')" style="font-size:12px;">‚ñ∂Ô∏è Run</button>
                    <button class="btn btn-secondary btn-sm" onclick="toggleJobEnabled('${escapedId}', ${!job.enabled})" style="font-size:12px;">
                        ${job.enabled ? 'üö´ Disable' : '‚úÖ Enable'}
                    </button>
                    <button class="btn btn-secondary btn-sm" style="font-size:12px;color:var(--danger,#ef4444);" onclick="deleteCronJob('${escapedId}')">üóëÔ∏è</button>
                </div>
            </div>
        `;
    }).join('');
}

function filterLogs() {
    const filter = document.getElementById('logFilter').value;
    const limit = parseInt(document.getElementById('logLimit').value) || 20;
    const tbody = document.getElementById('logsTable');
    
    let filtered = allLogs;
    if (filter !== 'all') {
        filtered = allLogs.filter(log => log.job_name === filter);
    }
    
    // Sort by execution time descending
    filtered.sort((a, b) => {
        const timeA = new Date(a.executed_at || a.created_at);
        const timeB = new Date(b.executed_at || b.created_at);
        return timeB - timeA;
    });
    
    // Limit to selected number
    filtered = filtered.slice(0, limit);
    
    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="5" class="empty-state">No execution logs found</td></tr>
        `;
        return;
    }
    
    tbody.innerHTML = filtered.map(log => {
        const executedAt = log.executed_at || log.created_at;
        const status = log.status || 'unknown';
        const statusClass = status === 'success' || status === 'completed' ? 'success' : 
                           status === 'error' || status === 'failed' ? 'error' : 'running';
        
        // Get icon and name, fallback to job_name if not found in scheduledJobs
        const jobInfo = scheduledJobs.find(j => j.id === log.job_name || j.name === log.job_name);
        const icon = jobInfo?.icon || jobIcons[log.job_name] || 'üìã';
        const displayName = jobInfo?.name || log.job_name || 'Unknown Job';
        
        return `
            <tr>
                <td>
                    <span style="margin-right: 8px;">${icon}</span>
                    ${displayName}
                </td>
                <td><span class="log-status ${statusClass}">${status}</span></td>
                <td class="log-details" title="${escapeHtml(log.details || '')}">${escapeHtml(log.details || '-')}</td>
                <td>${executedAt ? formatRelativeTime(new Date(executedAt)) : '-'}</td>
                <td>${log.duration ? formatDuration(log.duration) : '-'}</td>
            </tr>
        `;
    }).join('');
}

async function triggerTick() {
    try {
        const response = await fetch(`${API_BASE}/schedule/tick`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showToast('‚ö° Manual tick triggered!', 'success');
            // Reload data after a short delay
            setTimeout(loadHeartbeatData, 2000);
        } else {
            throw new Error('Failed to trigger tick');
        }
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

function formatDuration(ms) {
    if (!ms) return '-';
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    if (hours > 0) return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
    if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
    return `${seconds}s`;
}

// ‚îÄ‚îÄ Cron Job CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let editingJobId = null;

function openAddJobModal() {
    editingJobId = null;
    document.getElementById('cronModalTitle').textContent = '‚ûï Add Cron Job';
    document.getElementById('cronJobForm').reset();
    document.getElementById('jId').value = '';
    document.getElementById('jId').disabled = false;
    document.getElementById('jEnabled').checked = true;
    document.getElementById('cronJobModal').classList.add('active');
}

function openEditJobModal(jobId) {
    const job = scheduledJobs.find(j => (j.id || j.name) === jobId);
    if (!job) { showToast('Job not found', 'error'); return; }
    editingJobId = job.id || job.name;
    document.getElementById('cronModalTitle').textContent = '‚úèÔ∏è Edit Cron Job';
    document.getElementById('jId').value = editingJobId;
    document.getElementById('jId').disabled = true;
    document.getElementById('jName').value = job.name || '';
    document.getElementById('jSchedule').value = job.schedule || '';
    document.getElementById('jAgent').value = job.agent_id || 'main';
    document.getElementById('jType').value = job.payload_type || 'prompt';
    document.getElementById('jSession').value = job.session_mode || 'isolated';
    document.getElementById('jPayload').value = job.payload || '';
    document.getElementById('jMaxDuration').value = job.max_duration_seconds || 300;
    document.getElementById('jRetry').value = job.retry_count || 0;
    document.getElementById('jEnabled').checked = job.enabled !== false;
    document.getElementById('cronJobModal').classList.add('active');
}

function closeJobModal() {
    document.getElementById('cronJobModal').classList.remove('active');
    editingJobId = null;
}

async function saveCronJob(e) {
    e.preventDefault();
    const body = {
        name: document.getElementById('jName').value.trim(),
        schedule: document.getElementById('jSchedule').value.trim(),
        agent_id: document.getElementById('jAgent').value.trim() || 'main',
        payload_type: document.getElementById('jType').value,
        session_mode: document.getElementById('jSession').value,
        payload: document.getElementById('jPayload').value.trim(),
        max_duration_seconds: parseInt(document.getElementById('jMaxDuration').value) || 300,
        retry_count: parseInt(document.getElementById('jRetry').value) || 0,
        enabled: document.getElementById('jEnabled').checked,
    };
    if (!body.name || !body.schedule || !body.payload) {
        showToast('Name, schedule and payload are required', 'error'); return;
    }

    try {
        let url, method;
        if (editingJobId) {
            url = `${API_BASE}/engine/cron/${encodeURIComponent(editingJobId)}`;
            method = 'PUT';
        } else {
            url = `${API_BASE}/engine/cron`;
            method = 'POST';
            const jId = document.getElementById('jId').value.trim();
            if (jId) body.id = jId;
        }
        const resp = await fetch(url, {
            method, headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || `HTTP ${resp.status}`);
        }
        showToast(editingJobId ? '‚úÖ Job updated' : '‚úÖ Job created', 'success');
        closeJobModal();
        setTimeout(loadHeartbeatData, 1000);
    } catch (err) {
        showToast(`Error: ${err.message}`, 'error');
    }
}

async function deleteCronJob(jobId) {
    if (!confirm(`Delete cron job "${jobId}"?`)) return;
    try {
        const resp = await fetch(`${API_BASE}/engine/cron/${encodeURIComponent(jobId)}`, { method: 'DELETE' });
        if (!resp.ok && resp.status !== 204) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || `HTTP ${resp.status}`);
        }
        showToast('üóëÔ∏è Job deleted', 'success');
        setTimeout(loadHeartbeatData, 1000);
    } catch (err) {
        showToast(`Error: ${err.message}`, 'error');
    }
}

async function toggleJobEnabled(jobId, newEnabled) {
    try {
        const resp = await fetch(`${API_BASE}/engine/cron/${encodeURIComponent(jobId)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: newEnabled }),
        });
        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || `HTTP ${resp.status}`);
        }
        showToast(newEnabled ? '‚úÖ Job enabled' : 'üö´ Job disabled', 'success');
        setTimeout(loadHeartbeatData, 1000);
    } catch (err) {
        showToast(`Error: ${err.message}`, 'error');
    }
}

async function triggerSingleJob(jobId) {
    try {
        const resp = await fetch(`${API_BASE}/engine/cron/${encodeURIComponent(jobId)}/trigger`, { method: 'POST' });
        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || `HTTP ${resp.status}`);
        }
        showToast('‚ñ∂Ô∏è Job triggered', 'success');
        setTimeout(loadHeartbeatData, 2000);
    } catch (err) {
        showToast(`Error: ${err.message}`, 'error');
    }
}

// Auto-refresh every 60 seconds
setInterval(loadHeartbeatData, 60000);

// Initialize
document.addEventListener('DOMContentLoaded', () => loadHeartbeatData());
</script>
{% endblock %}
