{% extends "base.html" %}
{% block title %}Heartbeat - Aria Blue{% endblock %}

{% block page_title %}üíì Heartbeat{% endblock %}
{% block page_subtitle %}Scheduled jobs and system pulse{% endblock %}

{% block header_actions %}
<button class="btn btn-secondary" onclick="syncJobs()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M23 4v6h-6M1 20v-6h6M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
    </svg>
    Sync Jobs
</button>
<button class="btn btn-primary" onclick="triggerTick()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="5 3 19 12 5 21 5 3"/>
    </svg>
    Manual Tick
</button>
{% endblock %}

{% block content %}
<!-- Heartbeat Status Overview -->
<div class="heartbeat-hero">
    <div class="pulse-indicator" id="pulseIndicator">
        <div class="pulse-ring"></div>
        <div class="pulse-core">üíì</div>
    </div>
    <div class="heartbeat-status">
        <h2 id="heartbeatStatus">Checking...</h2>
        <p id="lastTickTime">Last tick: --</p>
    </div>
</div>

<!-- Stats Overview -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üîÑ</div>
        <div class="stat-info">
            <span class="stat-value" id="totalJobs">12</span>
            <span class="stat-label">Scheduled Jobs</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-info">
            <span class="stat-value" id="successfulRuns">-</span>
            <span class="stat-label">Successful (24h)</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-info">
            <span class="stat-value" id="failedRuns">-</span>
            <span class="stat-label">Failed (24h)</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">‚è∞</div>
        <div class="stat-info">
            <span class="stat-value" id="nextJob">-</span>
            <span class="stat-label">Next Job In</span>
        </div>
    </div>
</div>

<!-- Scheduled Jobs Grid -->
<section class="section">
    <div class="section-header">
        <h2>‚è∞ Scheduled Jobs</h2>
        <p>Aria's recurring tasks and their schedules</p>
    </div>
    <div class="jobs-grid" id="jobsGrid">
        <!-- Jobs will be rendered here -->
    </div>
</section>

<!-- Recent Executions -->
<section class="section">
    <div class="section-header">
        <h2>üìã Recent Executions</h2>
        <div class="section-actions">
            <select id="logLimit" onchange="filterLogs()" style="margin-right: 8px;">
                <option value="20" selected>Last 20</option>
                <option value="50">Last 50</option>
                <option value="100">Last 100</option>
            </select>
            <select id="logFilter" onchange="filterLogs()">
                <option value="all">All Jobs</option>
                <option value="work_cycle">Work Cycle</option>
                <option value="hourly_goal_check">Hourly Goal Check</option>
                <option value="six_hour_review">Six Hour Review</option>
                <option value="moltbook_post">Moltbook Post</option>
                <option value="subagent_delegation">Sub-agent Delegation</option>
                <option value="daily_reflection">Daily Reflection</option>
                <option value="morning_checkin">Morning Check-in</option>
                <option value="weekly_summary">Weekly Summary</option>
                <option value="social_presence">Social Presence</option>
                <option value="db_maintenance">DB Maintenance</option>
                <option value="subagent_management">Sub-agent Management</option>
                <option value="health_check">Health Check</option>
            </select>
        </div>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Job Name</th>
                    <th>Status</th>
                    <th>Details</th>
                    <th>Executed At</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody id="logsTable">
                <tr><td colspan="5" class="loading"><div class="spinner"></div></td></tr>
            </tbody>
        </table>
    </div>
</section>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>
{% endblock %}

{% block extra_css %}
<style>
/* Heartbeat Hero */
.heartbeat-hero {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xl);
    padding: var(--space-2xl);
    background: linear-gradient(180deg, var(--bg-tertiary) 0%, transparent 100%);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-xl);
}

.pulse-indicator {
    position: relative;
    width: 100px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.pulse-ring {
    position: absolute;
    inset: 0;
    border: 3px solid var(--accent-primary);
    border-radius: 50%;
    animation: pulse-ring 2s ease-out infinite;
}

.pulse-ring::before {
    content: '';
    position: absolute;
    inset: -10px;
    border: 2px solid var(--accent-primary);
    border-radius: 50%;
    opacity: 0.5;
    animation: pulse-ring 2s ease-out infinite 0.5s;
}

@keyframes pulse-ring {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    100% {
        transform: scale(1.5);
        opacity: 0;
    }
}

.pulse-core {
    font-size: 3rem;
    animation: pulse-beat 1s ease-in-out infinite;
}

@keyframes pulse-beat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.pulse-indicator.offline .pulse-ring,
.pulse-indicator.offline .pulse-ring::before {
    border-color: var(--danger);
    animation: none;
}

.pulse-indicator.offline .pulse-core {
    animation: none;
    opacity: 0.5;
}

.heartbeat-status {
    text-align: left;
}

.heartbeat-status h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.heartbeat-status p {
    color: var(--text-muted);
    font-size: 0.9rem;
}

/* Section */
.section {
    margin-bottom: var(--space-xl);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
    gap: var(--space-md);
}

.section-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
}

.section-header p {
    color: var(--text-muted);
    font-size: 0.9rem;
    width: 100%;
}

.section-actions select {
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.85rem;
    cursor: pointer;
}

/* Jobs Grid */
.jobs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-lg);
}

/* Job Card */
.job-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    transition: all var(--transition-base);
    position: relative;
    overflow: hidden;
}

.job-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent-gradient);
    transform: scaleX(0);
    transition: transform var(--transition-base);
}

.job-card:hover {
    border-color: var(--border-accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.job-card:hover::before {
    transform: scaleX(1);
}

.job-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
}

.job-icon {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    font-size: 1.5rem;
    flex-shrink: 0;
}

.job-info {
    flex: 1;
}

.job-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.job-schedule {
    font-size: 0.8rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
}

.job-status {
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-full);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.job-status.active {
    background: var(--success-bg);
    color: var(--success);
}

.job-status.idle {
    background: var(--info-bg);
    color: var(--info);
}

.job-status.error {
    background: var(--danger-bg);
    color: var(--danger);
}

.job-description {
    color: var(--text-secondary);
    font-size: 0.85rem;
    line-height: 1.5;
    margin-bottom: var(--space-md);
}

.job-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-subtle);
    font-size: 0.8rem;
}

.job-meta-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.job-meta-label {
    color: var(--text-dim);
    font-size: 0.7rem;
    text-transform: uppercase;
}

.job-meta-value {
    color: var(--text-secondary);
}

.job-meta-value.next {
    color: var(--accent-primary);
    font-weight: 600;
}

/* Table Styles */
.table-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.log-status {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
}

.log-status.success {
    background: var(--success-bg);
    color: var(--success);
}

.log-status.error {
    background: var(--danger-bg);
    color: var(--danger);
}

.log-status.running {
    background: var(--info-bg);
    color: var(--info);
}

.log-details {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--text-muted);
    font-size: 0.85rem;
}

/* Toast */
.toast {
    position: fixed;
    bottom: var(--space-xl);
    right: var(--space-xl);
    padding: var(--space-md) var(--space-lg);
    background: var(--bg-elevated);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-size: 0.9rem;
    box-shadow: var(--shadow-xl);
    transform: translateY(100px);
    opacity: 0;
    transition: all var(--transition-base);
    z-index: var(--z-tooltip);
}

.toast.show {
    transform: translateY(0);
    opacity: 1;
}

.toast.success {
    border-color: var(--success);
}

.toast.error {
    border-color: var(--danger);
}

/* Loading */
.loading {
    text-align: center;
    padding: var(--space-xl);
    color: var(--text-muted);
}

@media (max-width: 640px) {
    .heartbeat-hero {
        flex-direction: column;
        text-align: center;
    }
    
    .heartbeat-status {
        text-align: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script data-page-script>
// Scheduled Jobs - fetched from API (synced from OpenClaw)
let scheduledJobs = [];
let allLogs = [];

// Icon mapping for job names
const jobIcons = {
    'work_cycle': '‚ö°',
    'hourly_goal_check': 'üéØ',
    'six_hour_review': 'üìä',
    'moltbook_post': 'ü¶û',
    'subagent_delegation': 'ü§ñ',
    'daily_reflection': 'üåô',
    'morning_checkin': '‚òÄÔ∏è',
    'weekly_summary': 'üìà',
    'social_presence': 'üí¨',
    'db_maintenance': 'üóÑÔ∏è',
    'subagent_management': 'üîç',
    'health_check': 'üè•'
};

// Human-readable frequency from cron expression
function cronToFrequency(expr) {
    const patterns = {
        '*/1 * * * *': 'Every minute',
        '*/5 * * * *': 'Every 5 minutes',
        '*/15 * * * *': 'Every 15 minutes',
        '*/30 * * * *': 'Every 30 minutes',
        '0 * * * *': 'Every hour',
        '0 */2 * * *': 'Every 2 hours',
        '0 */4 * * *': 'Every 4 hours',
        '0 */6 * * *': 'Every 6 hours',
        '0 */12 * * *': 'Every 12 hours',
        '0 0 * * *': 'Daily at midnight',
        '0 3 * * *': 'Daily at 3 AM',
        '0 8 * * *': 'Daily at 8 AM',
        '0 23 * * *': 'Daily at 11 PM',
        '0 18 * * 0': 'Sunday 6 PM',
        '0 0 * * 0': 'Weekly (Sunday)',
        '0 0 1 * *': 'Monthly'
    };
    return patterns[expr] || expr;
}

async function loadHeartbeatData() {
    await Promise.all([
        loadScheduledJobs(),
        loadScheduleStatus()
        // Note: loadHeartbeatLogs() removed - logs now populated from jobs/live data
    ]);
}

const API_BASE = window.ARIA_API_BASE_URL || '/api';

async function loadScheduledJobs() {
    try {
        // Try live endpoint first (direct from OpenClaw file), fallback to DB
        let response = await fetch(`${API_BASE}/jobs/live`);
        let data = await response.json();
        let jobs = Array.isArray(data?.jobs) ? data.jobs : (Array.isArray(data) ? data : []);
        
        // If live has no jobs, try synced DB version
        if (jobs.length === 0 && !data?.error) {
            response = await fetch(`${API_BASE}/jobs`);
            data = await response.json();
            jobs = Array.isArray(data?.jobs) ? data.jobs : (Array.isArray(data) ? data : []);
        }
        
        if (jobs.length > 0) {
            scheduledJobs = jobs.map(job => ({
                id: job.id,
                name: job.name,
                icon: jobIcons[job.name] || 'üìã',
                schedule: job.schedule_expr,
                description: job.payload_text ? job.payload_text.substring(0, 100) + '...' : 'No description',
                frequency: cronToFrequency(job.schedule_expr),
                enabled: job.enabled,
                lastRun: job.last_run_at,
                nextRun: job.next_run_at,
                lastStatus: job.last_status,
                lastDurationMs: job.last_duration_ms
            }));
            document.getElementById('totalJobs').textContent = scheduledJobs.length;
            
            // Calculate successful/failed stats from job data (last 24h)
            const now = new Date();
            const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            let successful = 0;
            let failed = 0;
            
            for (const job of scheduledJobs) {
                if (job.lastRun) {
                    const lastRunDate = new Date(job.lastRun);
                    if (lastRunDate >= oneDayAgo) {
                        if (job.lastStatus === 'ok') {
                            successful++;
                        } else if (job.lastStatus === 'error') {
                            failed++;
                        }
                    }
                }
            }
            
            document.getElementById('successfulRuns').textContent = successful;
            document.getElementById('failedRuns').textContent = failed;
            
            // Populate allLogs from job data for Recent Executions table
            allLogs = scheduledJobs
                .filter(job => job.lastRun)
                .map(job => ({
                    job_name: job.name,
                    status: job.lastStatus === 'ok' ? 'success' : job.lastStatus,
                    executed_at: job.lastRun,
                    details: `Schedule: ${job.schedule}`,
                    duration: job.lastDurationMs
                }));
            
            filterLogs();
        } else {
            // No jobs found anywhere
            scheduledJobs = [];
            document.getElementById('totalJobs').textContent = '0';
            document.getElementById('successfulRuns').textContent = '0';
            document.getElementById('failedRuns').textContent = '0';
        }
        
        renderJobsGrid();
    } catch (error) {
        console.error('Failed to load jobs:', error);
        document.getElementById('jobsGrid').innerHTML = `
            <div class="empty-state">
                <p>‚ö†Ô∏è Failed to load jobs from API</p>
                <button class="btn btn-primary" onclick="syncJobs()">Sync from OpenClaw</button>
            </div>
        `;
    }
}

async function syncJobs() {
    try {
        showToast('Syncing jobs from OpenClaw...', 'info');
        const response = await fetch(`${API_BASE}/jobs/sync`, { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            showToast(`‚úÖ Synced ${data.synced} jobs from OpenClaw`, 'success');
            await loadScheduledJobs();
        } else {
            showToast(`‚ùå Sync failed: ${data.detail}`, 'error');
        }
    } catch (error) {
        showToast(`‚ùå Sync error: ${error.message}`, 'error');
    }
}

async function loadScheduleStatus() {
    try {
        const response = await fetch(`${API_BASE}/schedule`);
        const data = await response.json();
        
        document.getElementById('heartbeatStatus').textContent = 'System Active';
        document.getElementById('pulseIndicator').classList.remove('offline');
        
        if (data.last_tick) {
            const lastTick = new Date(data.last_tick);
            document.getElementById('lastTickTime').textContent = `Last tick: ${formatRelativeTime(lastTick)}`;
        }
        
        // Use new columns from schedule_tick if available
        if (data.jobs_total !== undefined && data.jobs_total !== null) {
            document.getElementById('totalJobs').textContent = data.jobs_total;
        }
        if (data.jobs_successful !== undefined && data.jobs_successful !== null) {
            document.getElementById('successfulRuns').textContent = data.jobs_successful;
        }
        if (data.jobs_failed !== undefined && data.jobs_failed !== null) {
            document.getElementById('failedRuns').textContent = data.jobs_failed;
        }
        if (data.next_job_at) {
            const nextJobTime = new Date(data.next_job_at);
            document.getElementById('nextJob').textContent = formatRelativeTime(nextJobTime);
        }
    } catch (error) {
        document.getElementById('heartbeatStatus').textContent = 'System Offline';
        document.getElementById('pulseIndicator').classList.add('offline');
        document.getElementById('lastTickTime').textContent = 'Unable to reach scheduler';
    }
}

async function loadHeartbeatLogs() {
    try {
        const response = await fetch(`${API_BASE}/records?table=heartbeat_log&limit=100`);
        const data = await response.json();
        allLogs = data.records || data || [];
        
        updateLogStats();
        filterLogs();
    } catch (error) {
        document.getElementById('logsTable').innerHTML = `
            <tr><td colspan="5" class="empty-state">Error loading logs: ${error.message}</td></tr>
        `;
    }
}

function updateLogStats() {
    const now = new Date();
    const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    const recentLogs = allLogs.filter(log => {
        const logTime = new Date(log.executed_at || log.created_at);
        return logTime >= oneDayAgo;
    });
    
    const successful = recentLogs.filter(log => log.status === 'success' || log.status === 'completed').length;
    const failed = recentLogs.filter(log => log.status === 'error' || log.status === 'failed').length;
    
    document.getElementById('successfulRuns').textContent = successful;
    document.getElementById('failedRuns').textContent = failed;
    
    // Calculate next job (simplified - based on work_cycle every 5 min)
    const minutes = now.getMinutes();
    const nextTickMin = Math.ceil(minutes / 5) * 5 - minutes;
    document.getElementById('nextJob').textContent = nextTickMin === 0 ? 'Now' : `${nextTickMin}m`;
}

function renderJobsGrid() {
    const container = document.getElementById('jobsGrid');
    
    if (scheduledJobs.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                <h3>üìã No Scheduled Jobs Found</h3>
                <p>Jobs haven't been synced from OpenClaw yet.</p>
                <button class="btn btn-primary" onclick="syncJobs()" style="margin-top: 1rem;">
                    üîÑ Sync Jobs from OpenClaw
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = scheduledJobs.map(job => {
        // Use real data from API
        const lastRun = job.lastRun ? formatRelativeTime(new Date(job.lastRun)) : 'Never';
        const nextRun = job.nextRun ? formatRelativeTime(new Date(job.nextRun)) : 'Unknown';
        const status = !job.enabled ? 'disabled' : 
                       job.lastStatus === 'error' ? 'error' : 
                       job.lastStatus === 'ok' ? 'active' : 'idle';
        const statusLabel = !job.enabled ? 'Disabled' : 
                           job.lastStatus === 'ok' ? 'Active' : 
                           job.lastStatus || 'Idle';
        
        return `
            <div class="job-card ${!job.enabled ? 'disabled' : ''}">
                <div class="job-header">
                    <div class="job-icon">${job.icon}</div>
                    <div class="job-info">
                        <div class="job-name">${job.name}</div>
                        <div class="job-schedule">${job.schedule}</div>
                    </div>
                    <span class="job-status ${status}">${statusLabel}</span>
                </div>
                <p class="job-description">${job.description}</p>
                <div class="job-meta">
                    <div class="job-meta-item">
                        <span class="job-meta-label">Frequency</span>
                        <span class="job-meta-value">${job.frequency}</span>
                    </div>
                    <div class="job-meta-item">
                        <span class="job-meta-label">Last Run</span>
                        <span class="job-meta-value">${lastRun}</span>
                    </div>
                    <div class="job-meta-item">
                        <span class="job-meta-label">Next Run</span>
                        <span class="job-meta-value">${nextRun}</span>
                    </div>
                    ${job.lastDurationMs ? `
                    <div class="job-meta-item">
                        <span class="job-meta-label">Duration</span>
                        <span class="job-meta-value">${formatDuration(job.lastDurationMs)}</span>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function filterLogs() {
    const filter = document.getElementById('logFilter').value;
    const limit = parseInt(document.getElementById('logLimit').value) || 20;
    const tbody = document.getElementById('logsTable');
    
    let filtered = allLogs;
    if (filter !== 'all') {
        filtered = allLogs.filter(log => log.job_name === filter);
    }
    
    // Sort by execution time descending
    filtered.sort((a, b) => {
        const timeA = new Date(a.executed_at || a.created_at);
        const timeB = new Date(b.executed_at || b.created_at);
        return timeB - timeA;
    });
    
    // Limit to selected number
    filtered = filtered.slice(0, limit);
    
    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="5" class="empty-state">No execution logs found</td></tr>
        `;
        return;
    }
    
    tbody.innerHTML = filtered.map(log => {
        const executedAt = log.executed_at || log.created_at;
        const status = log.status || 'unknown';
        const statusClass = status === 'success' || status === 'completed' ? 'success' : 
                           status === 'error' || status === 'failed' ? 'error' : 'running';
        
        // Get icon and name, fallback to job_name if not found in scheduledJobs
        const jobInfo = scheduledJobs.find(j => j.id === log.job_name || j.name === log.job_name);
        const icon = jobInfo?.icon || jobIcons[log.job_name] || 'üìã';
        const displayName = jobInfo?.name || log.job_name || 'Unknown Job';
        
        return `
            <tr>
                <td>
                    <span style="margin-right: 8px;">${icon}</span>
                    ${displayName}
                </td>
                <td><span class="log-status ${statusClass}">${status}</span></td>
                <td class="log-details" title="${escapeHtml(log.details || '')}">${escapeHtml(log.details || '-')}</td>
                <td>${executedAt ? formatRelativeTime(new Date(executedAt)) : '-'}</td>
                <td>${log.duration ? formatDuration(log.duration) : '-'}</td>
            </tr>
        `;
    }).join('');
}

async function triggerTick() {
    try {
        const response = await fetch(`${API_BASE}/schedule/tick`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showToast('‚ö° Manual tick triggered!', 'success');
            // Reload data after a short delay
            setTimeout(loadHeartbeatData, 2000);
        } else {
            throw new Error('Failed to trigger tick');
        }
    } catch (error) {
        showToast(`Error: ${error.message}`, 'error');
    }
}

function formatDuration(ms) {
    if (!ms) return '-';
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    if (hours > 0) return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
    if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
    return `${seconds}s`;
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Auto-refresh every 60 seconds
setInterval(loadHeartbeatData, 60000);

// Initialize
document.addEventListener('DOMContentLoaded', loadHeartbeatData);
</script>
{% endblock %}
