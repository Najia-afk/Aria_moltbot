{% extends "base.html" %}
{% block title %}Skill Stats{% endblock %}

{% block extra_css %}
<style>
    .page-controls {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
    }
    .filter-select,
    .task-input {
        padding: 10px 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 13px;
    }
    .task-input {
        min-width: 280px;
        flex: 1;
    }

    .tabs {
        display: flex;
        gap: 0;
        margin-bottom: 22px;
        border-bottom: 2px solid var(--border-color);
        overflow-x: auto;
    }
    .tab-btn {
        padding: 12px 20px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .tab-btn.active {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 15px;
        margin-bottom: 22px;
    }
    .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 16px;
    }
    .stat-card h4 {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-bottom: 6px;
    }
    .stat-card .value {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
    }
    .stat-card.blue .value { color: var(--accent-blue); }
    .stat-card.green .value { color: var(--success); }
    .stat-card.orange .value { color: #f59e0b; }
    .stat-card.purple .value { color: #a855f7; }

    .charts-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
    }
    .chart-card,
    .content-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 18px;
    }
    .chart-card h4,
    .content-card h4 {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 12px;
    }
    .chart-card canvas { max-height: 280px; }

    .data-table {
        width: 100%;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        border-collapse: collapse;
    }
    .data-table th,
    .data-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border-color);
        font-size: 13px;
        text-align: left;
    }
    .data-table th {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        background: rgba(0,0,0,0.2);
    }
    .data-table tr:last-child td { border-bottom: none; }

    .status-badge {
        display: inline-block;
        font-size: 11px;
        border-radius: 10px;
        padding: 2px 8px;
        font-weight: 700;
    }
    .status-badge.ok { background: rgba(34,197,94,0.2); color: var(--success); }
    .status-badge.fail { background: rgba(239,68,68,0.2); color: var(--danger); }

    .story-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 520px;
        overflow: auto;
    }
    .story-item {
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: rgba(255,255,255,0.02);
        padding: 10px 12px;
    }
    .story-time {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 4px;
    }
    .story-text {
        font-size: 13px;
        color: var(--text-primary);
        line-height: 1.4;
    }

    .candidate-card {
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 10px 12px;
        margin-bottom: 8px;
        background: rgba(255,255,255,0.02);
    }
    .candidate-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .candidate-table th,
    .candidate-table td {
        border-bottom: 1px solid var(--border-color);
        padding: 8px 6px;
        text-align: left;
    }
    .candidate-table th {
        color: var(--text-muted);
        font-size: 11px;
        text-transform: uppercase;
    }
    .certainty-pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 700;
        background: rgba(59,130,246,0.2);
        color: #60a5fa;
    }
    #path-decision-graph {
        height: 360px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: rgba(255,255,255,0.01);
    }

    .empty-state {
        text-align: center;
        color: var(--text-muted);
        padding: 28px;
    }

    @media (max-width: 900px) {
        .charts-row { grid-template-columns: 1fr; }
        .task-input { min-width: 100%; }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‚ö° Skill Stats</h1>
    <p>Beautiful observability for Aria skill usage, execution timing, path finding, and graph interrogation flow.</p>
</div>

<div class="page-controls">
    <select class="filter-select" id="hours-filter">
        <option value="24">Last 24 Hours</option>
        <option value="72">Last 3 Days</option>
        <option value="168">Last Week</option>
        <option value="720">Last Month</option>
    </select>
    <button class="btn btn-primary" onclick="loadSkillStatsDashboard()">Refresh</button>
</div>

<div class="tabs">
    <button class="tab-btn active" data-tab="overview">üìä Overview</button>
    <button class="tab-btn" data-tab="usage">‚è±Ô∏è Usage Time</button>
    <button class="tab-btn" data-tab="pathfind">üß≠ Path Find</button>
    <button class="tab-btn" data-tab="story">üß† Interrogation Story</button>
    <button class="tab-btn" data-tab="advanced">üìà Advanced</button>
</div>

<div class="tab-panel active" id="panel-overview">
    <div class="stats-grid">
        <div class="stat-card blue"><h4>Total Invocations</h4><div class="value" id="stat-total">-</div></div>
        <div class="stat-card green"><h4>Success Rate</h4><div class="value" id="stat-success">-</div></div>
        <div class="stat-card orange"><h4>Avg Latency</h4><div class="value" id="stat-latency">-</div></div>
        <div class="stat-card purple"><h4>Total Tokens</h4><div class="value" id="stat-tokens">-</div></div>
        <div class="stat-card"><h4>Unique Skills</h4><div class="value" id="stat-skills">-</div></div>
        <div class="stat-card"><h4>Unique Tools</h4><div class="value" id="stat-tools">-</div></div>
    </div>

    <div class="charts-row">
        <div class="chart-card">
            <h4>üìà Calls per Skill</h4>
            <canvas id="chart-skill-calls"></canvas>
        </div>
        <div class="chart-card">
            <h4>üîß Calls per Tool</h4>
            <canvas id="chart-tool-calls"></canvas>
        </div>
    </div>

    <h4 style="margin:0 0 10px 0;">Top Skill Performance</h4>
    <table class="data-table">
        <thead>
            <tr><th>Skill</th><th>Calls</th><th>Avg Latency</th><th>Error Rate</th><th>Tokens</th></tr>
        </thead>
        <tbody id="top-skills-body">
            <tr><td colspan="5" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
</div>

<div class="tab-panel" id="panel-usage">
    <div class="charts-row">
        <div class="chart-card">
            <h4>üìâ Invocation Volume Over Time</h4>
            <canvas id="chart-volume-time"></canvas>
        </div>
        <div class="chart-card">
            <h4>‚ö° Average Latency Over Time</h4>
            <canvas id="chart-latency-time"></canvas>
        </div>
    </div>

    <h4 style="margin:0 0 10px 0;">Recent Skill Executions</h4>
    <table class="data-table">
        <thead>
            <tr><th>Skill</th><th>Tool</th><th>Model</th><th>Duration</th><th>Status</th><th>Time</th></tr>
        </thead>
        <tbody id="recent-invocations-body">
            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
</div>

<div class="tab-panel" id="panel-pathfind">
    <div class="page-controls" style="margin-bottom: 14px;">
        <input id="task-query" class="task-input" placeholder="Describe the task you want Aria to solve, e.g. 'analyze market sentiment and summarize risks'">
        <button class="btn btn-primary" onclick="runPathFind()">Find Skill Path</button>
    </div>

    <div class="charts-row">
        <div class="content-card">
            <h4>üéØ Best Skills for Task</h4>
            <div id="path-candidates" class="empty-state">Run path find to see candidate skills.</div>
        </div>
        <div class="content-card">
            <h4>üï∏Ô∏è Graph Traversal Around Top Match</h4>
            <div id="path-graph-summary" class="empty-state">Traversal summary appears here after path find.</div>
        </div>
    </div>

    <div class="content-card">
        <h4>üß© Aria Decision Path (Ask ‚Üí Propositions ‚Üí Graph Pattern ‚Üí Choice)</h4>
        <div id="path-decision-graph"></div>
    </div>
</div>

<div class="tab-panel" id="panel-story">
    <div class="content-card">
        <h4>üß© How Aria Interrogated Skills, Tools, and Graph</h4>
        <div id="story-list" class="story-list">
            <div class="empty-state">Loading interrogation story...</div>
        </div>
    </div>
</div>

<div class="tab-panel" id="panel-advanced">
    <div class="stats-grid">
        <div class="stat-card blue"><h4>P95 Latency</h4><div class="value" id="adv-p95">-</div></div>
        <div class="stat-card orange"><h4>P99 Latency</h4><div class="value" id="adv-p99">-</div></div>
        <div class="stat-card green"><h4>Latency ‚â§ 500ms</h4><div class="value" id="adv-fast-rate">-</div></div>
        <div class="stat-card purple"><h4>Most Used Skill</h4><div class="value" id="adv-top-skill">-</div></div>
    </div>

    <div class="charts-row">
        <div class="chart-card">
            <h4>‚öñÔ∏è Usage vs Avg Latency (Top Skills)</h4>
            <canvas id="chart-usage-vs-latency"></canvas>
        </div>
        <div class="chart-card">
            <h4>üì¶ Latency Distribution</h4>
            <canvas id="chart-latency-distribution"></canvas>
        </div>
    </div>

    <div class="charts-row">
        <div class="chart-card">
            <h4>üéØ Reliability vs Load</h4>
            <canvas id="chart-reliability-load"></canvas>
        </div>
        <div class="content-card">
            <h4>üîé Advanced Notes</h4>
            <div id="advanced-notes" class="story-list">
                <div class="empty-state">Loading advanced analytics...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="/static/js/chart-helpers.js"></script>
<script>
let insights = null;
let charts = {};
let pathNetwork = null;

document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
    });
});

function fmtNumber(n) {
    return (n || 0).toLocaleString();
}

function esc(str) {
    if (str == null) return '';
    const d = document.createElement('div');
    d.textContent = String(str);
    return d.innerHTML;
}

function fmtDate(iso) {
    if (!iso) return '‚Äî';
    const dt = new Date(iso);
    if (Number.isNaN(dt.getTime())) return '‚Äî';
    return dt.toLocaleString();
}

async function loadSkillStatsDashboard() {
    const hours = document.getElementById('hours-filter').value;
    insights = await fetchAriaData(`${API_BASE_URL}/skills/insights?hours=${hours}&limit=150`);
    renderOverview();
    renderUsageTime();
    renderStory();
    renderAdvanced();
}

function certitudePercent(value, idx = 0) {
    const numeric = Number(value);
    if (Number.isFinite(numeric)) {
        if (numeric <= 1 && numeric >= 0) return Math.round(numeric * 100);
        if (numeric > 1) return Math.min(100, Math.round(numeric));
    }
    return Math.max(50, 100 - (idx * 10));
}

function renderDecisionGraph(task, candidates, traversalByCandidate) {
    const container = document.getElementById('path-decision-graph');
    if (!container || !window.vis) {
        if (container) container.innerHTML = '<div class="empty-state">Graph library unavailable.</div>';
        return;
    }

    const colors = ['#3b82f6', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444'];
    const nodes = [];
    const edges = [];

    nodes.push({ id: 'ask', label: `Aria Ask\n${task}`, shape: 'box', color: { background: '#1e293b', border: '#60a5fa' }, font: { color: '#e2e8f0' } });
    nodes.push({ id: 'choice', label: 'Aria Choice', shape: 'ellipse', color: { background: '#14532d', border: '#22c55e' }, font: { color: '#dcfce7' } });

    candidates.forEach((candidate, index) => {
        const color = colors[index % colors.length];
        const certainty = certitudePercent(candidate.relevance, index);
        const pId = `prop-${index}`;
        const gId = `pattern-${index}`;

        const traversal = traversalByCandidate[index] || { nodes: [], edges: [] };
        const nodeCount = (traversal.nodes || []).length;
        const edgeCount = (traversal.edges || []).length;

        nodes.push({
            id: pId,
            label: `Proposition ${index + 1}\n${candidate.name}\nCertitude ${certainty}%`,
            shape: 'box',
            color: { background: '#111827', border: color },
            font: { color: '#f3f4f6' },
        });
        nodes.push({
            id: gId,
            label: `Graph Pattern\n${nodeCount} nodes / ${edgeCount} edges`,
            shape: 'diamond',
            color: { background: '#0f172a', border: color },
            font: { color: '#d1d5db' },
        });

        edges.push({ from: 'ask', to: pId, color, width: 2, label: `path ${index + 1}` });
        edges.push({ from: pId, to: gId, color, width: 2, dashes: true });
        if (index === 0) {
            edges.push({ from: gId, to: 'choice', color: '#22c55e', width: 3, label: 'selected' });
        } else {
            edges.push({ from: gId, to: 'choice', color: '#6b7280', width: 1 });
        }
    });

    const data = {
        nodes: new vis.DataSet(nodes),
        edges: new vis.DataSet(edges),
    };
    const options = {
        physics: { stabilization: true, barnesHut: { gravitationalConstant: -3200, springLength: 150 } },
        interaction: { hover: true },
        layout: { hierarchical: { enabled: true, direction: 'LR', sortMethod: 'directed', levelSeparation: 180, nodeSpacing: 120 } },
        edges: { arrows: { to: { enabled: true, scaleFactor: 0.7 } }, smooth: { type: 'cubicBezier', forceDirection: 'horizontal', roundness: 0.35 } },
    };

    if (pathNetwork) {
        pathNetwork.destroy();
    }
    pathNetwork = new vis.Network(container, data, options);
}

function renderOverview() {
    const summary = insights?.summary || {};
    const bySkill = insights?.by_skill || [];
    const byTool = insights?.by_tool || [];

    document.getElementById('stat-total').textContent = fmtNumber(summary.total_invocations);
    document.getElementById('stat-success').textContent = `${summary.success_rate || 0}%`;
    document.getElementById('stat-latency').textContent = `${Math.round(summary.avg_duration_ms || 0)}ms`;
    document.getElementById('stat-tokens').textContent = fmtNumber(summary.total_tokens);
    document.getElementById('stat-skills').textContent = fmtNumber(summary.unique_skills);
    document.getElementById('stat-tools').textContent = fmtNumber(summary.unique_tools);

    const topSkills = bySkill.slice(0, 12);
    ARIAChartHelpers.renderChart(charts, 'chart-skill-calls', 'bar', {
        labels: topSkills.map(s => s.skill_name),
        datasets: [{
            label: 'Invocations',
            data: topSkills.map(s => s.invocations),
            backgroundColor: '#a855f7',
            borderRadius: 6
        }]
    }, { indexAxis: 'y', maxTicksLimit: 10 });

    ARIAChartHelpers.renderChart(charts, 'chart-tool-calls', 'bar', {
        labels: byTool.map(t => t.tool_name),
        datasets: [{
            label: 'Invocations',
            data: byTool.map(t => t.invocations),
            backgroundColor: '#3b82f6',
            borderRadius: 6
        }]
    }, { indexAxis: 'y', maxTicksLimit: 10 });

    const body = document.getElementById('top-skills-body');
    if (!bySkill.length) {
        body.innerHTML = '<tr><td colspan="5" class="empty-state">No skill usage in this period</td></tr>';
        return;
    }

    body.innerHTML = bySkill.slice(0, 20).map(s => `
        <tr>
            <td>${esc(s.skill_name)}</td>
            <td>${fmtNumber(s.invocations)}</td>
            <td>${Math.round(s.avg_duration_ms || 0)}ms</td>
            <td>${(s.error_rate || 0).toFixed(1)}%</td>
            <td>${fmtNumber(s.total_tokens)}</td>
        </tr>
    `).join('');
}

function renderUsageTime() {
    const timeline = insights?.timeline || [];
    const recent = insights?.recent_invocations || [];

    ARIAChartHelpers.renderChart(charts, 'chart-volume-time', 'line', {
        labels: timeline.map(t => new Date(t.hour).toLocaleTimeString([], { month: 'short', day: 'numeric', hour: '2-digit' })),
        datasets: [{
            label: 'Invocations',
            data: timeline.map(t => t.invocations),
            borderColor: '#a855f7',
            backgroundColor: 'rgba(168,85,247,0.15)',
            tension: 0.25,
            fill: true
        }]
    });

    ARIAChartHelpers.renderChart(charts, 'chart-latency-time', 'line', {
        labels: timeline.map(t => new Date(t.hour).toLocaleTimeString([], { month: 'short', day: 'numeric', hour: '2-digit' })),
        datasets: [{
            label: 'Avg Latency (ms)',
            data: timeline.map(t => Math.round(t.avg_duration_ms || 0)),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59,130,246,0.15)',
            tension: 0.25,
            fill: true
        }]
    });

    const body = document.getElementById('recent-invocations-body');
    if (!recent.length) {
        body.innerHTML = '<tr><td colspan="6" class="empty-state">No recent skill executions</td></tr>';
        return;
    }

    body.innerHTML = recent.slice(0, 80).map(item => `
        <tr>
            <td>${esc(item.skill_name)}</td>
            <td>${esc(item.tool_name || '‚Äî')}</td>
            <td>${esc(item.model_used || '‚Äî')}</td>
            <td>${item.duration_ms ? item.duration_ms + 'ms' : '‚Äî'}</td>
            <td><span class="status-badge ${item.success ? 'ok' : 'fail'}">${item.success ? 'OK' : 'FAIL'}</span></td>
            <td>${fmtDate(item.created_at)}</td>
        </tr>
    `).join('');
}

async function runPathFind() {
    const task = document.getElementById('task-query').value.trim();
    if (!task) {
        alert('Please describe a task first.');
        return;
    }

    const candidatesWrap = document.getElementById('path-candidates');
    const graphWrap = document.getElementById('path-graph-summary');
    candidatesWrap.innerHTML = 'Searching...';
    graphWrap.innerHTML = 'Traversing...';

    try {
        const result = await fetchAriaData(`${API_BASE_URL}/knowledge-graph/skill-for-task?task=${encodeURIComponent(task)}&limit=5`);
        const candidates = result?.candidates || [];

        if (!candidates.length) {
            candidatesWrap.innerHTML = '<div class="empty-state">No matching skills found for that task.</div>';
            graphWrap.innerHTML = '<div class="empty-state">No traversal available.</div>';
            return;
        }

        candidatesWrap.innerHTML = `
            <table class="candidate-table">
                <thead><tr><th>#</th><th>Proposition (Vectorized)</th><th>Certitude</th><th>Match Type</th></tr></thead>
                <tbody>
                    ${candidates.map((c, idx) => `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${esc(c.name)}</td>
                            <td><span class="certainty-pill">${certitudePercent(c.relevance, idx)}%</span></td>
                            <td>${esc(c.match_type || 'vector')}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;

        const graphCandidates = candidates.slice(0, 3);
        const traversals = await Promise.all(graphCandidates.map(async (candidate) => {
            try {
                return await fetchAriaData(`${API_BASE_URL}/knowledge-graph/traverse?start=${encodeURIComponent(candidate.id)}&max_depth=2&direction=both`);
            } catch {
                return { nodes: [], edges: [] };
            }
        }));

        const top = graphCandidates[0];
        const topTraversal = traversals[0] || { nodes: [], edges: [] };
        const nodes = topTraversal?.nodes || [];
        const edges = topTraversal?.edges || [];

        graphWrap.innerHTML = `
            <div><strong>Top Match:</strong> ${esc(top.name)}</div>
            <div style="margin-top:8px;"><strong>Connected Nodes:</strong> ${fmtNumber(nodes.length)}</div>
            <div><strong>Relations:</strong> ${fmtNumber(edges.length)}</div>
            <div style="margin-top:10px;color:var(--text-secondary);font-size:12px;">
                Aria can use this subgraph to reason from skill ‚Üí tools ‚Üí related entities before execution.
            </div>
        `;

        renderDecisionGraph(task, graphCandidates, traversals);
    } catch (err) {
        candidatesWrap.innerHTML = `<div class="empty-state">Path find failed: ${esc(err.message || err)}</div>`;
        graphWrap.innerHTML = '<div class="empty-state">Traversal unavailable.</div>';
        const graphContainer = document.getElementById('path-decision-graph');
        if (graphContainer) {
            graphContainer.innerHTML = '<div class="empty-state">Decision graph unavailable.</div>';
        }
    }
}

function renderStory() {
    const wrap = document.getElementById('story-list');
    const invocations = insights?.recent_invocations || [];
    const graphQueries = insights?.recent_graph_queries || [];

    const events = [
        ...invocations.map(i => ({
            type: 'skill',
            ts: i.created_at || '',
            text: `Aria executed skill "${i.skill_name}" with tool "${i.tool_name || 'unknown'}" (${i.duration_ms || 0}ms) and got ${i.success ? 'success' : 'failure'}.`
        })),
        ...graphQueries.map(q => ({
            type: 'graph',
            ts: q.created_at || '',
            text: `Aria queried graph via "${q.query_type}" with params ${JSON.stringify(q.params || {})} and received ${q.result_count || 0} results.`
        }))
    ].sort((a, b) => (b.ts || '').localeCompare(a.ts || ''));

    if (!events.length) {
        wrap.innerHTML = '<div class="empty-state">No interrogation activity in this time window.</div>';
        return;
    }

    wrap.innerHTML = events.slice(0, 120).map(e => `
        <div class="story-item">
            <div class="story-time">${fmtDate(e.ts)} ¬∑ ${e.type === 'graph' ? 'Graph' : 'Skill'}</div>
            <div class="story-text">${esc(e.text)}</div>
        </div>
    `).join('');
}

function percentile(values, p) {
    if (!values.length) return 0;
    const sorted = [...values].sort((a, b) => a - b);
    const idx = Math.min(sorted.length - 1, Math.max(0, Math.ceil((p / 100) * sorted.length) - 1));
    return sorted[idx] || 0;
}

function renderAdvanced() {
    const bySkill = insights?.by_skill || [];
    const recent = insights?.recent_invocations || [];
    const durations = recent
        .map(r => Number(r.duration_ms || 0))
        .filter(v => Number.isFinite(v) && v > 0);

    const p95 = percentile(durations, 95);
    const p99 = percentile(durations, 99);
    const fastRate = durations.length
        ? ((durations.filter(v => v <= 500).length / durations.length) * 100)
        : 0;
    const topSkill = bySkill.length ? bySkill[0].skill_name : '‚Äî';

    document.getElementById('adv-p95').textContent = `${Math.round(p95)}ms`;
    document.getElementById('adv-p99').textContent = `${Math.round(p99)}ms`;
    document.getElementById('adv-fast-rate').textContent = `${fastRate.toFixed(1)}%`;
    document.getElementById('adv-top-skill').textContent = topSkill;

    const top = bySkill.slice(0, 12);
    ARIAChartHelpers.renderChart(charts, 'chart-usage-vs-latency', 'bar', {
        labels: top.map(s => s.skill_name),
        datasets: [
            {
                type: 'bar',
                label: 'Invocations',
                data: top.map(s => s.invocations || 0),
                backgroundColor: 'rgba(168,85,247,0.55)',
                borderRadius: 5,
                yAxisID: 'y'
            },
            {
                type: 'line',
                label: 'Avg Latency (ms)',
                data: top.map(s => Math.round(s.avg_duration_ms || 0)),
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34,197,94,0.20)',
                yAxisID: 'y1',
                tension: 0.25
            }
        ]
    }, {
        maxTicksLimit: 12,
        scales: {
            y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Invocations' } },
            y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Latency (ms)' } }
        }
    });

    const bucketLabels = ['0-100', '101-300', '301-500', '501-1000', '1001-2000', '2000+'];
    const buckets = [0, 0, 0, 0, 0, 0];
    durations.forEach(v => {
        if (v <= 100) buckets[0] += 1;
        else if (v <= 300) buckets[1] += 1;
        else if (v <= 500) buckets[2] += 1;
        else if (v <= 1000) buckets[3] += 1;
        else if (v <= 2000) buckets[4] += 1;
        else buckets[5] += 1;
    });

    ARIAChartHelpers.renderChart(charts, 'chart-latency-distribution', 'bar', {
        labels: bucketLabels,
        datasets: [{
            label: 'Executions',
            data: buckets,
            backgroundColor: ['#22c55e', '#84cc16', '#f59e0b', '#f97316', '#ef4444', '#b91c1c'],
            borderRadius: 6
        }]
    });

    const reliability = top.map(s => {
        const inv = s.invocations || 0;
        const errRate = Number(s.error_rate || 0);
        return {
            x: inv,
            y: Math.max(0, 100 - errRate),
            r: Math.max(5, Math.min(18, Math.round((s.avg_duration_ms || 0) / 80))),
            label: s.skill_name
        };
    });

    ARIAChartHelpers.renderChart(charts, 'chart-reliability-load', 'bubble', {
        datasets: [{
            label: 'Skill Reliability',
            data: reliability,
            backgroundColor: 'rgba(59,130,246,0.45)',
            borderColor: '#3b82f6'
        }]
    }, {
        scales: {
            x: { title: { display: true, text: 'Invocations' }, beginAtZero: true },
            y: { title: { display: true, text: 'Success %' }, beginAtZero: true, max: 100 }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(ctx) {
                        const d = ctx.raw || {};
                        return `${d.label || 'skill'} ‚Ä¢ calls:${d.x || 0} ‚Ä¢ success:${(d.y || 0).toFixed(1)}% ‚Ä¢ latency-size:${d.r || 0}`;
                    }
                }
            }
        }
    });

    const notes = document.getElementById('advanced-notes');
    const hot = bySkill.slice(0, 5);
    if (!hot.length) {
        notes.innerHTML = '<div class="empty-state">No advanced analytics available in this range.</div>';
        return;
    }

    notes.innerHTML = hot.map((s, i) => `
        <div class="story-item">
            <div class="story-time">#${i + 1} ${esc(s.skill_name)}</div>
            <div class="story-text">
                ${fmtNumber(s.invocations)} calls ¬∑ ${Math.round(s.avg_duration_ms || 0)}ms avg ¬∑ ${(Number(s.error_rate || 0)).toFixed(1)}% error ¬∑ ${fmtNumber(s.total_tokens || 0)} tokens
            </div>
        </div>
    `).join('');
}

document.getElementById('hours-filter').addEventListener('change', loadSkillStatsDashboard);
loadSkillStatsDashboard();
setInterval(loadSkillStatsDashboard, 30000);
</script>
{% endblock %}
