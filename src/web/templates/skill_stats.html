{% extends "base.html" %}

{% block title %}Skill Stats â€” Aria Blue{% endblock %}

{% block extra_css %}
<style>
.stats-container { max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem; }
.chart-card { background: var(--surface, #1e1e2e); border: 1px solid var(--border, #3a3a5e); border-radius: 12px; padding: 1.25rem; }
.chart-card h3 { margin: 0 0 1rem 0; font-size: 0.95rem; color: var(--text-muted, #888); }
.summary-row { display: flex; gap: 1.5rem; margin-top: 1rem; flex-wrap: wrap; }
.summary-card { background: var(--surface, #1e1e2e); border: 1px solid var(--border, #3a3a5e); border-radius: 12px; padding: 1.25rem; text-align: center; flex: 1; min-width: 140px; }
.summary-value { font-size: 2rem; font-weight: 700; color: var(--text, #e0e0e0); }
.summary-label { font-size: 0.8rem; color: var(--text-muted, #888); margin-top: 0.25rem; }
.skill-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
.skill-table th, .skill-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border, #3a3a5e); }
.skill-table th { color: var(--text-muted, #888); font-size: 0.8rem; text-transform: uppercase; }
.skill-table td { color: var(--text, #e0e0e0); font-size: 0.9rem; }
.error-pct { color: #f87171; }
.success-pct { color: #4ade80; }
.time-filter { display: flex; gap: 0.5rem; margin-top: 1rem; }
.time-btn { padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border, #3a3a5e); background: transparent; color: var(--text-muted, #888); cursor: pointer; font-size: 0.8rem; }
.time-btn.active { background: var(--primary, #6c5ce7); color: white; border-color: var(--primary, #6c5ce7); }
@media (max-width: 768px) { .charts-grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<div class="stats-container">
    <h1>ðŸ“Š Skill Stats</h1>
    <p style="color: var(--text-muted);">Invocation metrics, latency, and error rates across all skills.</p>

    <div class="time-filter">
        <button class="time-btn" onclick="setHours(1)">1h</button>
        <button class="time-btn" onclick="setHours(6)">6h</button>
        <button class="time-btn active" onclick="setHours(24)">24h</button>
        <button class="time-btn" onclick="setHours(168)">7d</button>
        <button class="time-btn" onclick="setHours(720)">30d</button>
    </div>

    <div class="summary-row" id="summary-row"></div>

    <div class="charts-grid">
        <div class="chart-card">
            <h3>Invocations per Skill</h3>
            <canvas id="invocationsChart" height="250"></canvas>
        </div>
        <div class="chart-card">
            <h3>Error Rate by Skill</h3>
            <canvas id="errorChart" height="250"></canvas>
        </div>
        <div class="chart-card">
            <h3>Avg Latency (ms)</h3>
            <canvas id="latencyChart" height="250"></canvas>
        </div>
        <div class="chart-card">
            <h3>Token Usage</h3>
            <canvas id="tokenChart" height="250"></canvas>
        </div>
    </div>

    <div class="chart-card" style="margin-top: 1.5rem;">
        <h3>Skill Detail Table</h3>
        <table class="skill-table">
            <thead><tr>
                <th>Skill</th>
                <th>Invocations</th>
                <th>Avg Latency</th>
                <th>Error Rate</th>
                <th>Tokens Used</th>
            </tr></thead>
            <tbody id="stats-body">
                <tr><td colspan="5" style="color: var(--text-muted);">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
let currentHours = 24;
let charts = {};

const COLORS = [
    '#6c5ce7','#00b894','#fdcb6e','#e17055','#74b9ff',
    '#a29bfe','#55efc4','#fab1a0','#81ecec','#ffeaa7',
    '#dfe6e9','#636e72'
];

function setHours(h) {
    currentHours = h;
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    loadSkillStats();
}

async function loadSkillStats() {
    const body = await fetchAriaData(`/api/skills/stats?hours=${currentHours}`);
    renderAll(body.stats || []);
}

function renderAll(stats) {
    if (!stats || !stats.length) {
        document.getElementById('summary-row').innerHTML = '<p style="color:var(--text-muted);">No invocations recorded yet.</p>';
        document.getElementById('stats-body').innerHTML = '<tr><td colspan="5" style="color:var(--text-muted);">No data</td></tr>';
        return;
    }

    const totalInvocations = stats.reduce((s, r) => s + (r.total || r.total_invocations || 0), 0);
    const totalErrors = stats.reduce((s, r) => s + Math.round(r.error_rate * (r.total || r.total_invocations || 0)), 0);
    const avgLatency = Math.round(stats.reduce((s, r) => s + r.avg_duration_ms, 0) / stats.length);
    const totalTokens = stats.reduce((s, r) => s + (r.total_tokens || 0), 0);

    document.getElementById('summary-row').innerHTML = `
        <div class="summary-card"><div class="summary-value">${totalInvocations}</div><div class="summary-label">Total Invocations</div></div>
        <div class="summary-card"><div class="summary-value success-pct">${((1 - totalErrors / Math.max(totalInvocations,1)) * 100).toFixed(1)}%</div><div class="summary-label">Success Rate</div></div>
        <div class="summary-card"><div class="summary-value">${avgLatency}ms</div><div class="summary-label">Avg Latency</div></div>
        <div class="summary-card"><div class="summary-value">${totalTokens.toLocaleString()}</div><div class="summary-label">Total Tokens</div></div>
    `;

    const labels = stats.map(s => s.skill_name);
    const bg = labels.map((_, i) => COLORS[i % COLORS.length]);

    renderBar('invocationsChart', labels, stats.map(s => s.total || s.total_invocations || 0), bg, 'Invocations');
    renderBar('errorChart', labels, stats.map(s => (s.error_rate * 100).toFixed(1)), bg.map(c => c.replace(')', ', 0.7)').replace('rgb', 'rgba')), 'Error %');
    renderBar('latencyChart', labels, stats.map(s => Math.round(s.avg_duration_ms)), bg, 'ms');
    renderDoughnut('tokenChart', labels, stats.map(s => s.total_tokens || 0), bg);

    document.getElementById('stats-body').innerHTML = stats.map(s => `
        <tr>
            <td>${s.skill_name}</td>
            <td>${s.total || s.total_invocations || 0}</td>
            <td>${Math.round(s.avg_duration_ms)}ms</td>
            <td class="${s.error_rate > 0.1 ? 'error-pct' : 'success-pct'}">${(s.error_rate * 100).toFixed(1)}%</td>
            <td>${(s.total_tokens || 0).toLocaleString()}</td>
        </tr>
    `).join('');
}

function renderBar(id, labels, data, bg, yLabel) {
    if (charts[id]) charts[id].destroy();
    charts[id] = new Chart(document.getElementById(id), {
        type: 'bar',
        data: { labels, datasets: [{ data, backgroundColor: bg, borderRadius: 6 }] },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#888', maxRotation: 45 }, grid: { display: false } },
                y: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' }, title: { display: true, text: yLabel, color: '#888' } }
            }
        }
    });
}

function renderDoughnut(id, labels, data, bg) {
    if (charts[id]) charts[id].destroy();
    charts[id] = new Chart(document.getElementById(id), {
        type: 'doughnut',
        data: { labels, datasets: [{ data, backgroundColor: bg, borderWidth: 0 }] },
        options: {
            responsive: true,
            plugins: { legend: { position: 'right', labels: { color: '#888', boxWidth: 12, font: { size: 11 } } } }
        }
    });
}

loadSkillStats();
</script>
{% endblock %}
