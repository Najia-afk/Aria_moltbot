{% extends "base.html" %}
{% block title %}Skill Stats{% endblock %}

{% block extra_css %}
<style>
    .page-controls {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
    }
    .filter-select,
    .task-input {
        padding: 10px 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 13px;
    }
    .task-input {
        min-width: 280px;
        flex: 1;
    }

    .tabs {
        display: flex;
        gap: 0;
        margin-bottom: 22px;
        border-bottom: 2px solid var(--border-color);
        overflow-x: auto;
    }
    .tab-btn {
        padding: 12px 20px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .tab-btn.active {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 15px;
        margin-bottom: 22px;
    }
    .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 16px;
    }
    .stat-card h4 {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-bottom: 6px;
    }
    .stat-card .value {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
    }
    .stat-card.blue .value { color: var(--accent-blue); }
    .stat-card.green .value { color: var(--success); }
    .stat-card.orange .value { color: #f59e0b; }
    .stat-card.purple .value { color: #a855f7; }

    .charts-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
    }
    .chart-card,
    .content-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 18px;
    }
    .chart-card h4,
    .content-card h4 {
        font-size: 13px;
        color: var(--text-secondary);
        margin-bottom: 12px;
    }
    .chart-card canvas { max-height: 280px; }

    .data-table {
        width: 100%;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        border-collapse: collapse;
    }
    .data-table th,
    .data-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border-color);
        font-size: 13px;
        text-align: left;
    }
    .data-table th {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        background: rgba(0,0,0,0.2);
    }
    .data-table tr:last-child td { border-bottom: none; }

    .status-badge {
        display: inline-block;
        font-size: 11px;
        border-radius: 10px;
        padding: 2px 8px;
        font-weight: 700;
    }
    .status-badge.ok { background: rgba(34,197,94,0.2); color: var(--success); }
    .status-badge.fail { background: rgba(239,68,68,0.2); color: var(--danger); }

    .story-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 520px;
        overflow: auto;
    }
    .story-item {
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: rgba(255,255,255,0.02);
        padding: 10px 12px;
    }
    .story-time {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 4px;
    }
    .story-text {
        font-size: 13px;
        color: var(--text-primary);
        line-height: 1.4;
    }

    .candidate-card {
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 10px 12px;
        margin-bottom: 8px;
        background: rgba(255,255,255,0.02);
    }

    .empty-state {
        text-align: center;
        color: var(--text-muted);
        padding: 28px;
    }

    @media (max-width: 900px) {
        .charts-row { grid-template-columns: 1fr; }
        .task-input { min-width: 100%; }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‚ö° Skill Stats</h1>
    <p>Beautiful observability for Aria skill usage, execution timing, path finding, and graph interrogation flow.</p>
</div>

<div class="page-controls">
    <select class="filter-select" id="hours-filter">
        <option value="24">Last 24 Hours</option>
        <option value="72">Last 3 Days</option>
        <option value="168">Last Week</option>
        <option value="720">Last Month</option>
    </select>
    <button class="btn btn-primary" onclick="loadSkillStatsDashboard()">Refresh</button>
</div>

<div class="tabs">
    <button class="tab-btn active" data-tab="overview">üìä Overview</button>
    <button class="tab-btn" data-tab="usage">‚è±Ô∏è Usage Time</button>
    <button class="tab-btn" data-tab="pathfind">üß≠ Path Find</button>
    <button class="tab-btn" data-tab="story">üß† Interrogation Story</button>
</div>

<div class="tab-panel active" id="panel-overview">
    <div class="stats-grid">
        <div class="stat-card blue"><h4>Total Invocations</h4><div class="value" id="stat-total">-</div></div>
        <div class="stat-card green"><h4>Success Rate</h4><div class="value" id="stat-success">-</div></div>
        <div class="stat-card orange"><h4>Avg Latency</h4><div class="value" id="stat-latency">-</div></div>
        <div class="stat-card purple"><h4>Total Tokens</h4><div class="value" id="stat-tokens">-</div></div>
        <div class="stat-card"><h4>Unique Skills</h4><div class="value" id="stat-skills">-</div></div>
        <div class="stat-card"><h4>Unique Tools</h4><div class="value" id="stat-tools">-</div></div>
    </div>

    <div class="charts-row">
        <div class="chart-card">
            <h4>üìà Calls per Skill</h4>
            <canvas id="chart-skill-calls"></canvas>
        </div>
        <div class="chart-card">
            <h4>üîß Calls per Tool</h4>
            <canvas id="chart-tool-calls"></canvas>
        </div>
    </div>

    <h4 style="margin:0 0 10px 0;">Top Skill Performance</h4>
    <table class="data-table">
        <thead>
            <tr><th>Skill</th><th>Calls</th><th>Avg Latency</th><th>Error Rate</th><th>Tokens</th></tr>
        </thead>
        <tbody id="top-skills-body">
            <tr><td colspan="5" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
</div>

<div class="tab-panel" id="panel-usage">
    <div class="charts-row">
        <div class="chart-card">
            <h4>üìâ Invocation Volume Over Time</h4>
            <canvas id="chart-volume-time"></canvas>
        </div>
        <div class="chart-card">
            <h4>‚ö° Average Latency Over Time</h4>
            <canvas id="chart-latency-time"></canvas>
        </div>
    </div>

    <h4 style="margin:0 0 10px 0;">Recent Skill Executions</h4>
    <table class="data-table">
        <thead>
            <tr><th>Skill</th><th>Tool</th><th>Model</th><th>Duration</th><th>Status</th><th>Time</th></tr>
        </thead>
        <tbody id="recent-invocations-body">
            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
</div>

<div class="tab-panel" id="panel-pathfind">
    <div class="page-controls" style="margin-bottom: 14px;">
        <input id="task-query" class="task-input" placeholder="Describe the task you want Aria to solve, e.g. 'analyze market sentiment and summarize risks'">
        <button class="btn btn-primary" onclick="runPathFind()">Find Skill Path</button>
    </div>

    <div class="charts-row">
        <div class="content-card">
            <h4>üéØ Best Skills for Task</h4>
            <div id="path-candidates" class="empty-state">Run path find to see candidate skills.</div>
        </div>
        <div class="content-card">
            <h4>üï∏Ô∏è Graph Traversal Around Top Match</h4>
            <div id="path-graph-summary" class="empty-state">Traversal summary appears here after path find.</div>
        </div>
    </div>
</div>

<div class="tab-panel" id="panel-story">
    <div class="content-card">
        <h4>üß© How Aria Interrogated Skills, Tools, and Graph</h4>
        <div id="story-list" class="story-list">
            <div class="empty-state">Loading interrogation story...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/chart-helpers.js"></script>
<script>
let insights = null;
let charts = {};

document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
    });
});

function fmtNumber(n) {
    return (n || 0).toLocaleString();
}

function esc(str) {
    if (str == null) return '';
    const d = document.createElement('div');
    d.textContent = String(str);
    return d.innerHTML;
}

function fmtDate(iso) {
    if (!iso) return '‚Äî';
    const dt = new Date(iso);
    if (Number.isNaN(dt.getTime())) return '‚Äî';
    return dt.toLocaleString();
}

async function loadSkillStatsDashboard() {
    const hours = document.getElementById('hours-filter').value;
    insights = await fetchAriaData(`${API_BASE_URL}/skills/insights?hours=${hours}&limit=150`);
    renderOverview();
    renderUsageTime();
    renderStory();
}

function renderOverview() {
    const summary = insights?.summary || {};
    const bySkill = insights?.by_skill || [];
    const byTool = insights?.by_tool || [];

    document.getElementById('stat-total').textContent = fmtNumber(summary.total_invocations);
    document.getElementById('stat-success').textContent = `${summary.success_rate || 0}%`;
    document.getElementById('stat-latency').textContent = `${Math.round(summary.avg_duration_ms || 0)}ms`;
    document.getElementById('stat-tokens').textContent = fmtNumber(summary.total_tokens);
    document.getElementById('stat-skills').textContent = fmtNumber(summary.unique_skills);
    document.getElementById('stat-tools').textContent = fmtNumber(summary.unique_tools);

    const topSkills = bySkill.slice(0, 12);
    ARIAChartHelpers.renderChart(charts, 'chart-skill-calls', 'bar', {
        labels: topSkills.map(s => s.skill_name),
        datasets: [{
            label: 'Invocations',
            data: topSkills.map(s => s.invocations),
            backgroundColor: '#a855f7',
            borderRadius: 6
        }]
    }, { indexAxis: 'y', maxTicksLimit: 10 });

    ARIAChartHelpers.renderChart(charts, 'chart-tool-calls', 'bar', {
        labels: byTool.map(t => t.tool_name),
        datasets: [{
            label: 'Invocations',
            data: byTool.map(t => t.invocations),
            backgroundColor: '#3b82f6',
            borderRadius: 6
        }]
    }, { indexAxis: 'y', maxTicksLimit: 10 });

    const body = document.getElementById('top-skills-body');
    if (!bySkill.length) {
        body.innerHTML = '<tr><td colspan="5" class="empty-state">No skill usage in this period</td></tr>';
        return;
    }

    body.innerHTML = bySkill.slice(0, 20).map(s => `
        <tr>
            <td>${esc(s.skill_name)}</td>
            <td>${fmtNumber(s.invocations)}</td>
            <td>${Math.round(s.avg_duration_ms || 0)}ms</td>
            <td>${(s.error_rate || 0).toFixed(1)}%</td>
            <td>${fmtNumber(s.total_tokens)}</td>
        </tr>
    `).join('');
}

function renderUsageTime() {
    const timeline = insights?.timeline || [];
    const recent = insights?.recent_invocations || [];

    ARIAChartHelpers.renderChart(charts, 'chart-volume-time', 'line', {
        labels: timeline.map(t => new Date(t.hour).toLocaleTimeString([], { month: 'short', day: 'numeric', hour: '2-digit' })),
        datasets: [{
            label: 'Invocations',
            data: timeline.map(t => t.invocations),
            borderColor: '#a855f7',
            backgroundColor: 'rgba(168,85,247,0.15)',
            tension: 0.25,
            fill: true
        }]
    });

    ARIAChartHelpers.renderChart(charts, 'chart-latency-time', 'line', {
        labels: timeline.map(t => new Date(t.hour).toLocaleTimeString([], { month: 'short', day: 'numeric', hour: '2-digit' })),
        datasets: [{
            label: 'Avg Latency (ms)',
            data: timeline.map(t => Math.round(t.avg_duration_ms || 0)),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59,130,246,0.15)',
            tension: 0.25,
            fill: true
        }]
    });

    const body = document.getElementById('recent-invocations-body');
    if (!recent.length) {
        body.innerHTML = '<tr><td colspan="6" class="empty-state">No recent skill executions</td></tr>';
        return;
    }

    body.innerHTML = recent.slice(0, 80).map(item => `
        <tr>
            <td>${esc(item.skill_name)}</td>
            <td>${esc(item.tool_name || '‚Äî')}</td>
            <td>${esc(item.model_used || '‚Äî')}</td>
            <td>${item.duration_ms ? item.duration_ms + 'ms' : '‚Äî'}</td>
            <td><span class="status-badge ${item.success ? 'ok' : 'fail'}">${item.success ? 'OK' : 'FAIL'}</span></td>
            <td>${fmtDate(item.created_at)}</td>
        </tr>
    `).join('');
}

async function runPathFind() {
    const task = document.getElementById('task-query').value.trim();
    if (!task) {
        alert('Please describe a task first.');
        return;
    }

    const candidatesWrap = document.getElementById('path-candidates');
    const graphWrap = document.getElementById('path-graph-summary');
    candidatesWrap.innerHTML = 'Searching...';
    graphWrap.innerHTML = 'Traversing...';

    try {
        const result = await fetchAriaData(`${API_BASE_URL}/knowledge-graph/skill-for-task?task=${encodeURIComponent(task)}&limit=5`);
        const candidates = result?.candidates || [];

        if (!candidates.length) {
            candidatesWrap.innerHTML = '<div class="empty-state">No matching skills found for that task.</div>';
            graphWrap.innerHTML = '<div class="empty-state">No traversal available.</div>';
            return;
        }

        candidatesWrap.innerHTML = candidates.map((c, idx) => `
            <div class="candidate-card">
                <strong>${idx + 1}. ${esc(c.name)}</strong><br>
                <span style="color:var(--text-secondary);font-size:12px;">Match: ${esc(c.match_type)} ¬∑ Relevance: ${esc(c.relevance)}</span>
            </div>
        `).join('');

        const top = candidates[0];
        const traversal = await fetchAriaData(`${API_BASE_URL}/knowledge-graph/traverse?start=${encodeURIComponent(top.id)}&max_depth=2&direction=both`);
        const nodes = traversal?.nodes || [];
        const edges = traversal?.edges || [];

        graphWrap.innerHTML = `
            <div><strong>Top Match:</strong> ${esc(top.name)}</div>
            <div style="margin-top:8px;"><strong>Connected Nodes:</strong> ${fmtNumber(nodes.length)}</div>
            <div><strong>Relations:</strong> ${fmtNumber(edges.length)}</div>
            <div style="margin-top:10px;color:var(--text-secondary);font-size:12px;">
                Aria can use this subgraph to reason from skill ‚Üí tools ‚Üí related entities before execution.
            </div>
        `;
    } catch (err) {
        candidatesWrap.innerHTML = `<div class="empty-state">Path find failed: ${esc(err.message || err)}</div>`;
        graphWrap.innerHTML = '<div class="empty-state">Traversal unavailable.</div>';
    }
}

function renderStory() {
    const wrap = document.getElementById('story-list');
    const invocations = insights?.recent_invocations || [];
    const graphQueries = insights?.recent_graph_queries || [];

    const events = [
        ...invocations.map(i => ({
            type: 'skill',
            ts: i.created_at || '',
            text: `Aria executed skill "${i.skill_name}" with tool "${i.tool_name || 'unknown'}" (${i.duration_ms || 0}ms) and got ${i.success ? 'success' : 'failure'}.`
        })),
        ...graphQueries.map(q => ({
            type: 'graph',
            ts: q.created_at || '',
            text: `Aria queried graph via "${q.query_type}" with params ${JSON.stringify(q.params || {})} and received ${q.result_count || 0} results.`
        }))
    ].sort((a, b) => (b.ts || '').localeCompare(a.ts || ''));

    if (!events.length) {
        wrap.innerHTML = '<div class="empty-state">No interrogation activity in this time window.</div>';
        return;
    }

    wrap.innerHTML = events.slice(0, 120).map(e => `
        <div class="story-item">
            <div class="story-time">${fmtDate(e.ts)} ¬∑ ${e.type === 'graph' ? 'Graph' : 'Skill'}</div>
            <div class="story-text">${esc(e.text)}</div>
        </div>
    `).join('');
}

document.getElementById('hours-filter').addEventListener('change', loadSkillStatsDashboard);
loadSkillStatsDashboard();
setInterval(loadSkillStatsDashboard, 30000);
</script>
{% endblock %}
