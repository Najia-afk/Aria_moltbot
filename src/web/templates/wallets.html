{% extends "base.html" %}
{% set service_host = request.host.split(':')[0] %}
{% block title %}Aria - Wallets & Balances{% endblock %}

{% block content %}
<div class="hero hero-compact">
    <h1 class="hero-title">üí∞ Wallets & Balances</h1>
    <p class="hero-subtitle">Provider Credit Balances & API Cost Tracking</p>
</div>

<!-- Wallet Summary -->
<div class="summary-card">
    <div class="summary-header">
        <h2>Total Available Credits</h2>
    </div>
    <div class="summary-amount" id="total-balance">Loading...</div>
    <div class="summary-note">Combined balance across all providers (USD equivalent)</div>
    <div class="summary-updated">
        <span class="auto-refresh-indicator">üîÑ Auto-refresh: <span id="last-refresh">Loading...</span></span>
    </div>
</div>

<!-- Provider Wallets -->
<div class="wallets-grid">
    <!-- Kimi / Moonshot -->
    <div class="wallet-card kimi" id="wallet-kimi">
        <div class="wallet-header">
            <div class="wallet-icon">üåô</div>
            <div class="wallet-info">
                <h3 class="wallet-name">Moonshot / Kimi</h3>
                <span class="wallet-status" id="kimi-status">Checking...</span>
            </div>
        </div>
        <div class="wallet-balance">
            <div class="balance-main" id="kimi-balance">--</div>
            <div class="balance-currency">USD (US Dollars)</div>
            <div class="balance-usd" id="kimi-usd"></div>
        </div>
        <div class="wallet-details">
            <div class="detail-row">
                <span class="detail-label">üíµ Cash Balance</span>
                <span class="detail-value" id="kimi-cash">--</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">üéüÔ∏è Voucher Balance</span>
                <span class="detail-value" id="kimi-voucher">--</span>
            </div>
        </div>
        <div class="wallet-actions">
            <a href="https://platform.moonshot.cn/console/account" target="_blank" class="btn btn-secondary btn-sm">
                Top Up ‚Üí
            </a>
        </div>
    </div>

    <!-- OpenRouter -->
    <div class="wallet-card openrouter" id="wallet-openrouter">
        <div class="wallet-header">
            <div class="wallet-icon">üîÄ</div>
            <div class="wallet-info">
                <h3 class="wallet-name">OpenRouter</h3>
                <span class="wallet-status" id="openrouter-status">Checking...</span>
            </div>
        </div>
        <div class="wallet-balance">
            <div class="balance-main" id="openrouter-balance">--</div>
            <div class="balance-currency">USD (US Dollars)</div>
        </div>
        <div class="wallet-details">
            <div class="detail-row">
                <span class="detail-label">üìä Credit Limit</span>
                <span class="detail-value" id="openrouter-limit">--</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">üí∏ Amount Used</span>
                <span class="detail-value" id="openrouter-used">--</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">‚úÖ Remaining</span>
                <span class="detail-value" id="openrouter-remaining">--</span>
            </div>
        </div>
        <div class="wallet-actions">
            <a href="https://openrouter.ai/account" target="_blank" class="btn btn-secondary btn-sm">
                Manage Account ‚Üí
            </a>
        </div>
    </div>

    <!-- Local Models -->
    <div class="wallet-card local" id="wallet-local">
        <div class="wallet-header">
            <div class="wallet-icon">üè†</div>
            <div class="wallet-info">
                <h3 class="wallet-name">Local Models</h3>
                <span class="wallet-status free" id="local-status">Free</span>
            </div>
        </div>
        <div class="wallet-balance">
            <div class="balance-main free">$0.00</div>
            <div class="balance-currency">No cost - running locally</div>
        </div>
        <div class="wallet-details">
            <div class="detail-row">
                <span class="detail-label">üñ•Ô∏è MLX Server</span>
                <span class="detail-value" id="mlx-status">--</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ü¶ô Ollama</span>
                <span class="detail-value" id="ollama-status">--</span>
            </div>
        </div>
        <div class="wallet-note">
            <p>Local models run on your hardware with zero API costs.</p>
        </div>
    </div>
</div>

<!-- Spend History -->
<div class="section-card">
    <div class="section-header">
        <h2 class="section-title">üìä Spending Overview</h2>
    </div>
    <div class="spend-overview">
        <div class="spend-stat">
            <div class="spend-stat-value" id="spend-total">--</div>
            <div class="spend-stat-label">Total Spend</div>
        </div>
        <div class="spend-stat">
            <div class="spend-stat-value" id="spend-today">--</div>
            <div class="spend-stat-label">Today</div>
        </div>
        <div class="spend-stat">
            <div class="spend-stat-value" id="spend-week">--</div>
            <div class="spend-stat-label">This Week</div>
        </div>
        <div class="spend-stat">
            <div class="spend-stat-value" id="spend-month">--</div>
            <div class="spend-stat-label">This Month</div>
        </div>
    </div>
</div>

<!-- Balance History Chart -->
<div class="section-card">
    <div class="section-header">
        <h2 class="section-title">üìà Balance History</h2>
    </div>
    <div class="chart-container">
        <canvas id="balance-history-chart"></canvas>
    </div>
</div>

<!-- API Cost Estimator -->
<div class="section-card">
    <div class="section-header">
        <h2 class="section-title">üßÆ Cost Estimator</h2>
    </div>
    <div class="estimator">
        <div class="estimator-inputs">
            <div class="input-group">
                <label>Model</label>
                <select id="est-model" onchange="calculateEstimate()">
                    <option value="">Loading models‚Ä¶</option>
                </select>
            </div>
            <div class="input-group">
                <label>Input Tokens</label>
                <input type="number" id="est-input" value="1000" onchange="calculateEstimate()">
            </div>
            <div class="input-group">
                <label>Output Tokens</label>
                <input type="number" id="est-output" value="500" onchange="calculateEstimate()">
            </div>
            <div class="input-group">
                <label>Requests</label>
                <input type="number" id="est-requests" value="100" onchange="calculateEstimate()">
            </div>
        </div>
        <div class="estimator-result">
            <div class="est-label">Estimated Cost</div>
            <div class="est-value" id="est-cost">$0.00</div>
            <div class="est-note" id="est-note">--</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Summary Card */
.summary-card {
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    padding: var(--space-2xl);
    text-align: center;
    margin-bottom: var(--space-xl);
    position: relative;
    overflow: hidden;
}

.summary-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #22c55e, #3b82f6, #8b5cf6);
}

.summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
}

.summary-header h2 {
    font-size: 1rem;
    color: var(--text-muted);
    font-weight: 500;
}

.summary-amount {
    font-size: 3.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #22c55e, #3b82f6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-sm);
}

.summary-note {
    color: var(--text-muted);
    font-size: 0.875rem;
}

.summary-updated {
    margin-top: var(--space-md);
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* Wallets Grid */
.wallets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
}

.wallet-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    position: relative;
    overflow: hidden;
}

.wallet-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.wallet-card.kimi::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
.wallet-card.openrouter::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
.wallet-card.local::before { background: linear-gradient(90deg, #22c55e, #4ade80); }

.wallet-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.wallet-icon {
    font-size: 2.5rem;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
}

.wallet-name {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.wallet-status {
    font-size: 0.75rem;
    padding: 3px 10px;
    border-radius: var(--radius-full);
    font-weight: 500;
}

.wallet-status.ok, .wallet-status.active { 
    background: rgba(34, 197, 94, 0.2); 
    color: #22c55e; 
}
.wallet-status.error { 
    background: rgba(239, 68, 68, 0.2); 
    color: #ef4444; 
}
.wallet-status.free { 
    background: rgba(59, 130, 246, 0.2); 
    color: #3b82f6; 
}
.wallet-status.checking { 
    background: rgba(234, 179, 8, 0.2); 
    color: #eab308; 
}

.wallet-balance {
    margin-bottom: var(--space-lg);
}

.balance-main {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.balance-main.free {
    background: linear-gradient(135deg, #22c55e, #4ade80);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.balance-main.negative {
    color: #ef4444;
}

.auto-refresh-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    color: #22c55e;
}

.balance-currency {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.balance-usd {
    font-size: 0.875rem;
    color: var(--accent-primary);
    margin-top: 4px;
}

.wallet-details {
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    margin-bottom: var(--space-md);
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--border-subtle);
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    color: var(--text-muted);
    font-size: 0.875rem;
}

.detail-value {
    color: var(--text-primary);
    font-weight: 500;
}

.wallet-actions {
    margin-top: var(--space-md);
}

.wallet-note {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md);
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* Spend Overview */
.spend-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-md);
}

.spend-stat {
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    text-align: center;
}

.spend-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #22c55e;
    margin-bottom: var(--space-xs);
}

.spend-stat-label {
    font-size: 0.875rem;
    color: var(--text-muted);
}

/* Chart Container */
.chart-container {
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    min-height: 300px;
}

/* Estimator */
.estimator {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: var(--space-xl);
    align-items: center;
}

.estimator-inputs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-md);
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}

.input-group label {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.input-group select,
.input-group input {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    padding: 10px 14px;
    color: var(--text-primary);
    font-size: 0.875rem;
}

.input-group select:focus,
.input-group input:focus {
    outline: none;
    border-color: var(--accent-primary);
}

.estimator-result {
    background: var(--bg-tertiary);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    text-align: center;
    min-width: 200px;
}

.est-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: var(--space-sm);
}

.est-value {
    font-size: 2rem;
    font-weight: 800;
    color: #22c55e;
}

.est-note {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: var(--space-sm);
}

/* Responsive */
@media (max-width: 768px) {
    .summary-amount {
        font-size: 2.5rem;
    }
    
    .estimator {
        grid-template-columns: 1fr;
    }
    
    .wallets-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script data-page-script>
const API_URL = window.ARIA_API_BASE_URL;\n\n// Debug mode: set window.ARIA_DEBUG = true in console to enable verbose logging\nwindow.ARIA_DEBUG = window.ARIA_DEBUG || false;

let balanceChart = null;

// All pricing, calculateLogCost, formatMoney, formatNumber, getProvider, etc.
// are provided by /static/js/pricing.js (loaded in base.html)

async function loadBalances() {
    try {
        const response = await fetch(`${API_URL}/providers/balances`);
        const data = await response.json();
        
        let totalUSD = 0;
        
        // Kimi ‚Äî international API (api.moonshot.ai) returns USD
        if (data.kimi) {
            const kimi = data.kimi;
            if (kimi.status === 'ok') {
                const available = kimi.available || 0;
                totalUSD += available;
                
                document.getElementById('kimi-status').textContent = 'Active';
                document.getElementById('kimi-status').className = 'wallet-status ok';
                document.getElementById('kimi-balance').textContent = formatMoney(available, currency);
                document.getElementById('kimi-usd').textContent = '';
                document.getElementById('kimi-cash').textContent = formatMoney(kimi.cash || 0, currency);
                document.getElementById('kimi-voucher').textContent = formatMoney(kimi.voucher || 0, currency);
            } else {
                document.getElementById('kimi-status').textContent = 'Error';
                document.getElementById('kimi-status').className = 'wallet-status error';
                document.getElementById('kimi-balance').textContent = '--';
            }
        }
        
        // OpenRouter - shows real spend (can be negative)
        if (data.openrouter) {
            const or = data.openrouter;
            if (or.status === 'ok') {
                const usage = or.usage || 0;
                const limit = or.limit;
                
                // Calculate balance: if limit exists, remaining = limit - usage
                // If no limit (prepaid/free), show negative usage as spend
                let displayBalance;
                if (limit !== null && limit !== undefined) {
                    displayBalance = limit - usage;
                } else {
                    displayBalance = -usage; // Negative = money spent
                }
                
                // Add to total if positive
                if (displayBalance > 0) {
                    totalUSD += displayBalance;
                }
                
                document.getElementById('openrouter-status').textContent = 'Active';
                document.getElementById('openrouter-status').className = 'wallet-status ok';
                
                // Format balance display
                const balanceEl = document.getElementById('openrouter-balance');
                if (displayBalance >= 0) {
                    balanceEl.textContent = '$' + displayBalance.toFixed(2);
                    balanceEl.className = 'balance-main';
                } else {
                    balanceEl.textContent = '-$' + Math.abs(displayBalance).toFixed(2);
                    balanceEl.className = 'balance-main negative';
                }
                
                document.getElementById('openrouter-limit').textContent = limit !== null ? '$' + limit.toFixed(2) : 'No limit';
                document.getElementById('openrouter-used').textContent = '$' + usage.toFixed(2);
                document.getElementById('openrouter-remaining').textContent = displayBalance >= 0 ? '$' + displayBalance.toFixed(2) : '-$' + Math.abs(displayBalance).toFixed(2);
            } else if (or.status === 'free_tier') {
                document.getElementById('openrouter-status').textContent = 'Free Tier';
                document.getElementById('openrouter-status').className = 'wallet-status free';
                document.getElementById('openrouter-balance').textContent = 'FREE';
                document.getElementById('openrouter-balance').classList.add('free');
            } else {
                document.getElementById('openrouter-status').textContent = 'Error';
                document.getElementById('openrouter-status').className = 'wallet-status error';
            }
        }
        
        // Local
        if (data.local) {
            document.getElementById('local-status').textContent = 'Free';
            document.getElementById('local-status').className = 'wallet-status free';
            document.getElementById('mlx-status').textContent = data.local.mlx_status || 'Available';
            document.getElementById('ollama-status').textContent = data.local.ollama_status || 'Available';
        }
        
        // Update total
        document.getElementById('total-balance').textContent = '$' + totalUSD.toFixed(2);
        
    } catch (error) {
        console.error('Error loading balances:', error);
        document.getElementById('total-balance').textContent = 'Error';
    }
}

async function loadSpend() {
    try {
        // Fetch all spend logs to calculate real spend from tokens
        const summary = await fetchSpendSummary(API_URL, 50);
        window._walletSpendLogs = summary.logs;
        
        document.getElementById('spend-total').textContent = formatMoney(summary.totalSpend);
        document.getElementById('spend-today').textContent = formatMoney(summary.todaySpend);
        document.getElementById('spend-week').textContent = formatMoney(summary.weekSpend);
        document.getElementById('spend-month').textContent = formatMoney(summary.monthSpend);
        
    } catch (error) {
        console.error('Error loading spend:', error);
        document.getElementById('spend-total').textContent = '--';
        document.getElementById('spend-today').textContent = '--';
        document.getElementById('spend-week').textContent = '--';
        document.getElementById('spend-month').textContent = '--';
    }
}

async function createBalanceChart() {
    const ctx = document.getElementById('balance-history-chart').getContext('2d');
    
    // Use cached logs from loadSpend
    let spendLogs;
    try {
        spendLogs = window._walletSpendLogs || [];
    } catch (e) {
        spendLogs = [];
    }
    
    // Build daily spend data for the last 30 days
    const dayData = {};
    const now = new Date();
    for (let i = 29; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(d.getDate() - i);
        const key = d.toISOString().split('T')[0];
        dayData[key] = { kimi: 0, openrouter: 0, local: 0 };
    }
    
    // Aggregate CALCULATED spend by provider and day
    if (Array.isArray(spendLogs)) {
        spendLogs.forEach(log => {
            const logDate = new Date(log.startTime || log.created_at);
            const key = logDate.toISOString().split('T')[0];
            if (dayData.hasOwnProperty(key)) {
                const model = (log.model || '').toLowerCase();
                // Calculate actual cost from tokens
                const cost = calculateLogCost(log);
                
                if (model.includes('moonshot') || model.includes('kimi')) {
                    dayData[key].kimi += cost;
                } else if (model.includes('local') || model.includes('mlx') || model.includes('ollama')) {
                    dayData[key].local += cost;
                } else {
                    dayData[key].openrouter += cost;
                }
            }
        });
    }
    
    // Prepare chart data
    const labels = Object.keys(dayData).map(d => {
        const date = new Date(d);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });
    
    // Calculate cumulative spend
    let kimiCumulative = 0;
    let orCumulative = 0;
    const kimiSpendData = [];
    const orSpendData = [];
    
    Object.values(dayData).forEach(day => {
        kimiCumulative += day.kimi;
        orCumulative += day.openrouter;
        kimiSpendData.push(kimiCumulative);
        orSpendData.push(orCumulative);
    });
    
    // Check if there's any data
    const hasData = kimiCumulative > 0 || orCumulative > 0;
    
    if (!hasData) {
        ctx.canvas.parentElement.innerHTML = `
            <h3 class="chart-title">üìà Balance History</h3>
            <div class="empty-state" style="height: 250px; display: flex; align-items: center; justify-content: center;">
                <p>No spend data available yet</p>
            </div>`;
        return;
    }
    
    balanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Kimi Spend (USD)',
                    data: kimiSpendData,
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 2
                },
                {
                    label: 'OpenRouter Spend (USD)',
                    data: orSpendData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#9ca3af' }
                },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `${ctx.dataset.label}: ${formatMoney(ctx.raw)}`
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#9ca3af', maxTicksLimit: 10 }
                },
                y: {
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { 
                        color: '#9ca3af', 
                        callback: v => formatMoney(v)
                    },
                    beginAtZero: true
                }
            }
        }
    });
}

function calculateEstimate() {
    const model = document.getElementById('est-model').value;
    const inputTokens = parseInt(document.getElementById('est-input').value) || 0;
    const outputTokens = parseInt(document.getElementById('est-output').value) || 0;
    const requests = parseInt(document.getElementById('est-requests').value) || 0;
    
    const pricing = getModelPricing(model);
    if (!pricing) return;
    
    // Cost per request (pricing is already in USD)
    const inputCost = (inputTokens / 1000000) * pricing.input;
    const outputCost = (outputTokens / 1000000) * pricing.output;
    let totalCost = (inputCost + outputCost) * requests;
    
    const costEl = document.getElementById('est-cost');
    const noteEl = document.getElementById('est-note');
    
    if (totalCost === 0) {
        costEl.textContent = 'FREE';
        costEl.style.color = '#22c55e';
        noteEl.textContent = 'This model has no cost';
    } else {
        costEl.textContent = formatMoney(totalCost);
        costEl.style.color = '#22c55e';
        noteEl.textContent = `${formatMoney(totalCost / requests)} per request`;
    }
}

function refreshAll() {
    loadBalances();
    loadSpend();
    updateLastRefresh();
}

// Update last refresh timestamp
let lastRefreshTime = null;
let refreshInterval = null;
let countdownInterval = null;

function updateLastRefresh() {
    lastRefreshTime = new Date();
    const el = document.getElementById('last-refresh');
    if (el) {
        el.textContent = 'Just now';
    }
}

function updateCountdown() {
    if (!lastRefreshTime) return;
    const el = document.getElementById('last-refresh');
    if (!el) return;
    
    const elapsed = Math.floor((new Date() - lastRefreshTime) / 1000);
    const remaining = 60 - elapsed;
    
    if (elapsed < 5) {
        el.textContent = 'Just now';
    } else if (remaining > 0) {
        el.textContent = `${elapsed}s ago (refresh in ${remaining}s)`;
    } else {
        el.textContent = 'Refreshing...';
    }
}

// Populate cost estimator dropdown dynamically from models.yaml
function populateEstimatorModels() {
    const select = document.getElementById('est-model');
    if (!select || !AriaModels._pricing) return;

    // Deduplicate: only keep model_ids (skip aliases/litellm keys)
    const seen = new Set();
    const models = [];
    for (const [key, val] of Object.entries(AriaModels._pricing)) {
        const id = val.model_id || key;
        if (seen.has(id)) continue;
        seen.add(id);
        const isFree = val.input === 0 && val.output === 0;
        const label = isFree
            ? `${id} (Free)`
            : `${id} ($${val.input}/$${val.output} per 1M)`;
        models.push({ id, label, tier: val.tier || 'unknown' });
    }

    // Sort: paid first, then free, then local
    const tierOrder = { paid: 0, free: 1, local: 2, unknown: 3 };
    models.sort((a, b) => (tierOrder[a.tier] ?? 3) - (tierOrder[b.tier] ?? 3));

    select.innerHTML = models.map(m =>
        `<option value="${m.id}">${m.label}</option>`
    ).join('');
}

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    await AriaModels.init();
    populateEstimatorModels();
    loadBalances();
    loadSpend();
    await createBalanceChart();
    calculateEstimate();
    updateLastRefresh();
    
    // Auto-refresh every 60 seconds
    refreshInterval = setInterval(refreshAll, 60000);
    
    // Update countdown every second
    countdownInterval = setInterval(updateCountdown, 1000);
    
    if (window.ARIA_DEBUG) console.log('üí∞ Wallet auto-refresh enabled (every 60s)');
});
</script>
{% endblock %}
