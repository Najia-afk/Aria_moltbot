{% extends "base.html" %}
{% set service_host = request.host.split(':')[0] %}
{% block title %}Aria - Wallets & Balances{% endblock %}

{% block content %}
<div class="hero hero-compact">
    <h1 class="hero-title">üí∞ Wallets & Balances</h1>
    <p class="hero-subtitle">Provider Credit Balances & API Cost Tracking</p>
</div>

<!-- Wallet Summary -->
<div class="summary-card">
    <div class="summary-header">
        <h2>Total Available Credits</h2>
        <button class="btn btn-secondary btn-sm" onclick="refreshAll()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Refresh All
        </button>
    </div>
    <div class="summary-amount" id="total-balance">Loading...</div>
    <div class="summary-note">Combined balance across all providers (USD equivalent)</div>
    <div class="summary-updated">Last updated: <span id="last-updated">--</span></div>
</div>

<!-- Provider Wallets -->
<div class="wallets-grid">
    <!-- Kimi / Moonshot -->
    <div class="wallet-card kimi" id="wallet-kimi">
        <div class="wallet-header">
            <div class="wallet-icon">üåô</div>
            <div class="wallet-info">
                <h3 class="wallet-name">Moonshot / Kimi</h3>
                <span class="wallet-status" id="kimi-status">Checking...</span>
            </div>
        </div>
        <div class="wallet-balance">
            <div class="balance-main" id="kimi-balance">--</div>
            <div class="balance-currency">USD (US Dollars)</div>
            <div class="balance-usd" id="kimi-usd"></div>
        </div>
        <div class="wallet-details">
            <div class="detail-row">
                <span class="detail-label">üíµ Cash Balance</span>
                <span class="detail-value" id="kimi-cash">--</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">üéüÔ∏è Voucher Balance</span>
                <span class="detail-value" id="kimi-voucher">--</span>
            </div>
        </div>
        <div class="wallet-actions">
            <a href="https://platform.moonshot.cn/console/account" target="_blank" class="btn btn-secondary btn-sm">
                Top Up ‚Üí
            </a>
        </div>
    </div>

    <!-- OpenRouter -->
    <div class="wallet-card openrouter" id="wallet-openrouter">
        <div class="wallet-header">
            <div class="wallet-icon">üîÄ</div>
            <div class="wallet-info">
                <h3 class="wallet-name">OpenRouter</h3>
                <span class="wallet-status" id="openrouter-status">Checking...</span>
            </div>
        </div>
        <div class="wallet-balance">
            <div class="balance-main" id="openrouter-balance">--</div>
            <div class="balance-currency">USD (US Dollars)</div>
        </div>
        <div class="wallet-details">
            <div class="detail-row">
                <span class="detail-label">üìä Credit Limit</span>
                <span class="detail-value" id="openrouter-limit">--</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">üí∏ Amount Used</span>
                <span class="detail-value" id="openrouter-used">--</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">‚úÖ Remaining</span>
                <span class="detail-value" id="openrouter-remaining">--</span>
            </div>
        </div>
        <div class="wallet-actions">
            <a href="https://openrouter.ai/account" target="_blank" class="btn btn-secondary btn-sm">
                Manage Account ‚Üí
            </a>
        </div>
    </div>

    <!-- Local Models -->
    <div class="wallet-card local" id="wallet-local">
        <div class="wallet-header">
            <div class="wallet-icon">üè†</div>
            <div class="wallet-info">
                <h3 class="wallet-name">Local Models</h3>
                <span class="wallet-status free" id="local-status">Free</span>
            </div>
        </div>
        <div class="wallet-balance">
            <div class="balance-main free">$0.00</div>
            <div class="balance-currency">No cost - running locally</div>
        </div>
        <div class="wallet-details">
            <div class="detail-row">
                <span class="detail-label">üñ•Ô∏è MLX Server</span>
                <span class="detail-value" id="mlx-status">--</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ü¶ô Ollama</span>
                <span class="detail-value" id="ollama-status">--</span>
            </div>
        </div>
        <div class="wallet-note">
            <p>Local models run on your hardware with zero API costs.</p>
        </div>
    </div>
</div>

<!-- Spend History -->
<div class="section-card">
    <div class="section-header">
        <h2 class="section-title">üìä Spending Overview</h2>
    </div>
    <div class="spend-overview">
        <div class="spend-stat">
            <div class="spend-stat-value" id="spend-total">--</div>
            <div class="spend-stat-label">Total Spend</div>
        </div>
        <div class="spend-stat">
            <div class="spend-stat-value" id="spend-today">--</div>
            <div class="spend-stat-label">Today</div>
        </div>
        <div class="spend-stat">
            <div class="spend-stat-value" id="spend-week">--</div>
            <div class="spend-stat-label">This Week</div>
        </div>
        <div class="spend-stat">
            <div class="spend-stat-value" id="spend-month">--</div>
            <div class="spend-stat-label">This Month</div>
        </div>
    </div>
</div>

<!-- Balance History Chart -->
<div class="section-card">
    <div class="section-header">
        <h2 class="section-title">üìà Balance History</h2>
    </div>
    <div class="chart-container">
        <canvas id="balance-history-chart"></canvas>
    </div>
</div>

<!-- API Cost Estimator -->
<div class="section-card">
    <div class="section-header">
        <h2 class="section-title">üßÆ Cost Estimator</h2>
    </div>
    <div class="estimator">
        <div class="estimator-inputs">
            <div class="input-group">
                <label>Model</label>
                <select id="est-model" onchange="calculateEstimate()">
                    <option value="kimi">Kimi (moonshot-v1-auto)</option>
                    <option value="gemini-free">Gemini 2.0 Flash (Free)</option>
                    <option value="deepseek-free">DeepSeek Chat (Free)</option>
                    <option value="llama-free">Llama 3.3 70B (Free)</option>
                    <option value="local">Local (MLX/Ollama)</option>
                </select>
            </div>
            <div class="input-group">
                <label>Input Tokens</label>
                <input type="number" id="est-input" value="1000" onchange="calculateEstimate()">
            </div>
            <div class="input-group">
                <label>Output Tokens</label>
                <input type="number" id="est-output" value="500" onchange="calculateEstimate()">
            </div>
            <div class="input-group">
                <label>Requests</label>
                <input type="number" id="est-requests" value="100" onchange="calculateEstimate()">
            </div>
        </div>
        <div class="estimator-result">
            <div class="est-label">Estimated Cost</div>
            <div class="est-value" id="est-cost">$0.00</div>
            <div class="est-note" id="est-note">--</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Summary Card */
.summary-card {
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    padding: var(--space-2xl);
    text-align: center;
    margin-bottom: var(--space-xl);
    position: relative;
    overflow: hidden;
}

.summary-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #22c55e, #3b82f6, #8b5cf6);
}

.summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
}

.summary-header h2 {
    font-size: 1rem;
    color: var(--text-muted);
    font-weight: 500;
}

.summary-amount {
    font-size: 3.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #22c55e, #3b82f6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-sm);
}

.summary-note {
    color: var(--text-muted);
    font-size: 0.875rem;
}

.summary-updated {
    margin-top: var(--space-md);
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* Wallets Grid */
.wallets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
}

.wallet-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    position: relative;
    overflow: hidden;
}

.wallet-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.wallet-card.kimi::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
.wallet-card.openrouter::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
.wallet-card.local::before { background: linear-gradient(90deg, #22c55e, #4ade80); }

.wallet-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.wallet-icon {
    font-size: 2.5rem;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
}

.wallet-name {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.wallet-status {
    font-size: 0.75rem;
    padding: 3px 10px;
    border-radius: var(--radius-full);
    font-weight: 500;
}

.wallet-status.ok, .wallet-status.active { 
    background: rgba(34, 197, 94, 0.2); 
    color: #22c55e; 
}
.wallet-status.error { 
    background: rgba(239, 68, 68, 0.2); 
    color: #ef4444; 
}
.wallet-status.free { 
    background: rgba(59, 130, 246, 0.2); 
    color: #3b82f6; 
}
.wallet-status.checking { 
    background: rgba(234, 179, 8, 0.2); 
    color: #eab308; 
}

.wallet-balance {
    margin-bottom: var(--space-lg);
}

.balance-main {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.balance-main.free {
    background: linear-gradient(135deg, #22c55e, #4ade80);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.balance-currency {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.balance-usd {
    font-size: 0.875rem;
    color: var(--accent-primary);
    margin-top: 4px;
}

.wallet-details {
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    margin-bottom: var(--space-md);
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--border-subtle);
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    color: var(--text-muted);
    font-size: 0.875rem;
}

.detail-value {
    color: var(--text-primary);
    font-weight: 500;
}

.wallet-actions {
    margin-top: var(--space-md);
}

.wallet-note {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md);
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* Spend Overview */
.spend-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-md);
}

.spend-stat {
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    text-align: center;
}

.spend-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #22c55e;
    margin-bottom: var(--space-xs);
}

.spend-stat-label {
    font-size: 0.875rem;
    color: var(--text-muted);
}

/* Chart Container */
.chart-container {
    background: var(--bg-tertiary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    min-height: 300px;
}

/* Estimator */
.estimator {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: var(--space-xl);
    align-items: center;
}

.estimator-inputs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-md);
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}

.input-group label {
    font-size: 0.875rem;
    color: var(--text-muted);
}

.input-group select,
.input-group input {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    padding: 10px 14px;
    color: var(--text-primary);
    font-size: 0.875rem;
}

.input-group select:focus,
.input-group input:focus {
    outline: none;
    border-color: var(--accent-primary);
}

.estimator-result {
    background: var(--bg-tertiary);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    text-align: center;
    min-width: 200px;
}

.est-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: var(--space-sm);
}

.est-value {
    font-size: 2rem;
    font-weight: 800;
    color: #22c55e;
}

.est-note {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: var(--space-sm);
}

/* Responsive */
@media (max-width: 768px) {
    .summary-amount {
        font-size: 2.5rem;
    }
    
    .estimator {
        grid-template-columns: 1fr;
    }
    
    .wallets-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script data-page-script>
const API_URL = window.ARIA_API_BASE_URL;
const CNY_TO_USD = 0.14;

let balanceChart = null;

// Model pricing per 1M tokens
const PRICING = {
    'kimi': { input: 1.68, output: 1.68, currency: 'CNY' },
    'gemini-free': { input: 0, output: 0, currency: 'USD' },
    'deepseek-free': { input: 0, output: 0, currency: 'USD' },
    'llama-free': { input: 0, output: 0, currency: 'USD' },
    'local': { input: 0, output: 0, currency: 'USD' },
};

function formatMoney(amount, currency = 'USD') {
    if (currency === 'CNY') {
        return '¬•' + amount.toFixed(2);
    }
    if (amount === 0) return '$0.00';
    if (amount < 0.01) return '$' + amount.toFixed(4);
    return '$' + amount.toFixed(2);
}

async function loadBalances() {
    try {
        const response = await fetch(`${API_URL}/providers/balances`);
        const data = await response.json();
        
        let totalUSD = 0;
        
        // Kimi (already in USD)
        if (data.kimi) {
            const kimi = data.kimi;
            if (kimi.status === 'ok') {
                const available = kimi.available || 0;
                totalUSD += available;
                
                document.getElementById('kimi-status').textContent = 'Active';
                document.getElementById('kimi-status').className = 'wallet-status ok';
                document.getElementById('kimi-balance').textContent = '$' + available.toFixed(2);
                document.getElementById('kimi-usd').textContent = '';
                document.getElementById('kimi-cash').textContent = '$' + (kimi.cash || 0).toFixed(2);
                document.getElementById('kimi-voucher').textContent = '$' + (kimi.voucher || 0).toFixed(2);
            } else {
                document.getElementById('kimi-status').textContent = 'Error';
                document.getElementById('kimi-status').className = 'wallet-status error';
                document.getElementById('kimi-balance').textContent = '--';
            }
        }
        
        // OpenRouter
        if (data.openrouter) {
            const or = data.openrouter;
            if (or.status === 'ok') {
                const remaining = or.remaining || 0;
                const usage = or.usage || 0;
                const limit = or.limit;
                
                // Only add positive remaining to total
                if (remaining > 0) {
                    totalUSD += remaining;
                }
                
                document.getElementById('openrouter-status').textContent = or.is_free_tier ? 'Free Tier' : 'Active';
                document.getElementById('openrouter-status').className = 'wallet-status ' + (or.is_free_tier ? 'free' : 'ok');
                
                if (or.is_free_tier) {
                    // Free tier - show usage as spend
                    document.getElementById('openrouter-balance').textContent = usage > 0 ? '-$' + usage.toFixed(2) : 'FREE';
                    if (usage > 0) {
                        document.getElementById('openrouter-balance').classList.add('negative');
                    } else {
                        document.getElementById('openrouter-balance').classList.add('free');
                    }
                    document.getElementById('openrouter-limit').textContent = 'No limit (free)';
                } else {
                    document.getElementById('openrouter-balance').textContent = '$' + remaining.toFixed(2);
                    document.getElementById('openrouter-limit').textContent = '$' + (limit || 0).toFixed(2);
                }
                document.getElementById('openrouter-used').textContent = '$' + usage.toFixed(2);
                document.getElementById('openrouter-remaining').textContent = remaining >= 0 ? '$' + remaining.toFixed(2) : '-$' + Math.abs(remaining).toFixed(2);
            } else if (or.status === 'free_tier') {
                document.getElementById('openrouter-status').textContent = 'Free Tier';
                document.getElementById('openrouter-status').className = 'wallet-status free';
                document.getElementById('openrouter-balance').textContent = 'FREE';
                document.getElementById('openrouter-balance').classList.add('free');
            } else {
                document.getElementById('openrouter-status').textContent = 'Error';
                document.getElementById('openrouter-status').className = 'wallet-status error';
            }
        }
        
        // Local
        if (data.local) {
            document.getElementById('local-status').textContent = 'Free';
            document.getElementById('local-status').className = 'wallet-status free';
            document.getElementById('mlx-status').textContent = data.local.mlx_status || 'Available';
            document.getElementById('ollama-status').textContent = data.local.ollama_status || 'Available';
        }
        
        // Update total
        document.getElementById('total-balance').textContent = '$' + totalUSD.toFixed(2);
        document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        
    } catch (error) {
        console.error('Error loading balances:', error);
        document.getElementById('total-balance').textContent = 'Error';
    }
}

async function loadSpend() {
    try {
        const response = await fetch(`${API_URL}/litellm/global-spend`);
        const data = await response.json();
        
        const totalSpend = data.spend || 0;
        document.getElementById('spend-total').textContent = formatMoney(totalSpend);
        
        // Mock period data (would need proper date filtering in API)
        document.getElementById('spend-today').textContent = formatMoney(totalSpend * 0.05);
        document.getElementById('spend-week').textContent = formatMoney(totalSpend * 0.2);
        document.getElementById('spend-month').textContent = formatMoney(totalSpend * 0.5);
        
    } catch (error) {
        console.error('Error loading spend:', error);
    }
}

function createBalanceChart() {
    const ctx = document.getElementById('balance-history-chart').getContext('2d');
    
    // Mock historical data
    const labels = [];
    const kimiData = [];
    const orData = [];
    
    for (let i = 30; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        kimiData.push(50 + Math.random() * 20 - i * 0.5);
        orData.push(20 + Math.random() * 10 - i * 0.3);
    }
    
    balanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Kimi (USD equiv)',
                    data: kimiData,
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'OpenRouter',
                    data: orData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#9ca3af' }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#9ca3af', maxTicksLimit: 10 }
                },
                y: {
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#9ca3af', callback: v => '$' + v }
                }
            }
        }
    });
}

function calculateEstimate() {
    const model = document.getElementById('est-model').value;
    const inputTokens = parseInt(document.getElementById('est-input').value) || 0;
    const outputTokens = parseInt(document.getElementById('est-output').value) || 0;
    const requests = parseInt(document.getElementById('est-requests').value) || 0;
    
    const pricing = PRICING[model];
    if (!pricing) return;
    
    // Cost per request
    const inputCost = (inputTokens / 1000000) * pricing.input;
    const outputCost = (outputTokens / 1000000) * pricing.output;
    let totalCost = (inputCost + outputCost) * requests;
    
    // Convert CNY to USD if needed
    if (pricing.currency === 'CNY') {
        totalCost *= CNY_TO_USD;
    }
    
    const costEl = document.getElementById('est-cost');
    const noteEl = document.getElementById('est-note');
    
    if (totalCost === 0) {
        costEl.textContent = 'FREE';
        costEl.style.color = '#22c55e';
        noteEl.textContent = 'This model has no cost';
    } else {
        costEl.textContent = formatMoney(totalCost);
        costEl.style.color = '#22c55e';
        noteEl.textContent = `${formatMoney(totalCost / requests)} per request`;
    }
}

function refreshAll() {
    loadBalances();
    loadSpend();
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadBalances();
    loadSpend();
    createBalanceChart();
    calculateEstimate();
});
</script>
{% endblock %}
