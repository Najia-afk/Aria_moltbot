{% extends "base.html" %}
{% block title %}Memories - Aria{% endblock %}

{% block extra_css %}
<style>
.memory-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    transition: transform 0.2s;
}
.memory-card:hover { transform: translateY(-2px); }
.memory-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}
.memory-key {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    color: var(--accent-cyan);
    font-weight: 600;
}
.memory-category {
    padding: 0.25rem 0.75rem;
    background: rgba(59, 130, 246, 0.15);
    color: var(--accent-blue);
    border-radius: 20px;
    font-size: 0.8rem;
}
.memory-time {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
}
.memory-value {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-top: 1rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    color: var(--text-secondary);
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 200px;
    overflow-y: auto;
}
.memory-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}
.memory-actions button {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s;
}
.btn-delete {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: var(--danger);
}
.btn-delete:hover {
    background: rgba(239, 68, 68, 0.2);
}
.btn-copy {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: var(--accent-blue);
}
.btn-copy:hover {
    background: rgba(59, 130, 246, 0.2);
}
.stats-bar {
    display: flex;
    gap: 2rem;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
}
.stat-item {
    display: flex;
    flex-direction: column;
}
.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent-primary);
}
.stat-label {
    font-size: 0.85rem;
    color: var(--text-muted);
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üíæ Aria's Memories</h1>
    <p>Persistent key-value store for long-term memory</p>
</div>

<div class="stats-bar" id="statsBar">
    <div class="stat-item">
        <span class="stat-value" id="totalMemories">-</span>
        <span class="stat-label">Total Memories</span>
    </div>
    <div class="stat-item">
        <span class="stat-value" id="uniqueCategories">-</span>
        <span class="stat-label">Categories</span>
    </div>
</div>

<div class="filters">
    <div class="search-box">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="text" class="input" id="searchInput" placeholder="Search memories by key or value...">
    </div>
    <div class="filter-group">
        <label class="filter-label">Category:</label>
        <select id="categoryFilter" onchange="filterMemories()">
            <option value="">All Categories</option>
        </select>
    </div>
    <button class="btn btn-primary" onclick="loadMemories()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 11-6.22-8.56"/>
        </svg>
        Refresh
    </button>
</div>

<div class="memories-grid grid-2" id="memoriesContainer">
    <div class="loading"><div class="spinner"></div></div>
</div>
<div id="memories-pagination"></div>
{% endblock %}

{% block extra_js %}
<script data-page-script>
let allMemories = [];
let memoriesPager;

async function loadMemories(page = 1, limit = 25) {
    const container = document.getElementById('memoriesContainer');
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    try {
        const response = await fetch(`${window.ARIA_API_BASE_URL}/memories?limit=${limit}&page=${page}`);
        const data = await response.json();
        allMemories = data.items || data.memories || [];
        
        // Update stats
        document.getElementById('totalMemories').textContent = data.total || allMemories.length;
        const categories = [...new Set(allMemories.map(m => m.category))];
        document.getElementById('uniqueCategories').textContent = categories.length;
        
        // Populate category filter
        const categorySelect = document.getElementById('categoryFilter');
        categorySelect.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
        
        renderMemories(allMemories);
        if (memoriesPager && data.pages) memoriesPager.update(data);
    } catch (error) {
        container.innerHTML = '<div class="empty-state"><p>Error loading memories</p></div>';
    }
}

function renderMemories(memories) {
    const container = document.getElementById('memoriesContainer');
    
    if (!memories.length) {
        container.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:64px;height:64px;opacity:0.5;">
                    <path d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                </svg>
                <p>No memories stored yet</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = memories.map(m => `
        <div class="memory-card" data-category="${m.category || 'general'}" data-key="${m.key}">
            <div class="memory-header">
                <span class="memory-key">${m.key}</span>
                <span class="memory-category">${m.category || 'general'}</span>
            </div>
            <div class="memory-value">${formatValue(m.value)}</div>
            <div class="memory-time">Updated: ${formatTime(m.updated_at || m.created_at)}</div>
            <div class="memory-actions">
                <button class="btn-copy" onclick="copyValue('${m.key}')">üìã Copy</button>
                <button class="btn-delete" onclick="deleteMemory('${m.key}')">üóëÔ∏è Delete</button>
            </div>
        </div>
    `).join('');
}

function formatValue(value) {
    if (typeof value === 'object') {
        return JSON.stringify(value, null, 2);
    }
    return String(value);
}

function filterMemories() {
    const category = document.getElementById('categoryFilter').value;
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    const filtered = allMemories.filter(m => {
        const matchCategory = !category || m.category === category;
        const matchSearch = !search || 
            m.key.toLowerCase().includes(search) || 
            JSON.stringify(m.value).toLowerCase().includes(search);
        return matchCategory && matchSearch;
    });
    
    renderMemories(filtered);
}

function copyValue(key) {
    const memory = allMemories.find(m => m.key === key);
    if (memory) {
        const text = typeof memory.value === 'object' ? JSON.stringify(memory.value, null, 2) : String(memory.value);
        navigator.clipboard.writeText(text);
        showToast('Copied to clipboard!');
    }
}

async function deleteMemory(key) {
    if (!confirm(`Delete memory "${key}"?`)) return;
    
    try {
        await fetch(`${window.ARIA_API_BASE_URL}/memories/${encodeURIComponent(key)}`, { method: 'DELETE' });
        loadMemories();
        showToast('Memory deleted');
    } catch (error) {
        showToast('Error deleting memory', 'error');
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        background: ${type === 'error' ? 'var(--danger)' : 'var(--success)'};
        color: white;
        border-radius: var(--radius-md);
        z-index: 1000;
        animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function formatTime(ts) {
    return new Date(ts).toLocaleString();
}

document.getElementById('searchInput').addEventListener('input', filterMemories);
memoriesPager = new AriaPagination('memories-pagination', {
    onPageChange: (page, limit) => loadMemories(page, limit),
    limit: 25
});
document.addEventListener('DOMContentLoaded', () => loadMemories());
</script>
{% endblock %}
