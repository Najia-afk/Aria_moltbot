{% extends "base.html" %}
{% block title %}Security Events{% endblock %}

{% block extra_css %}
<style>
    .page-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }
    .search-box {
        flex: 1;
        min-width: 250px;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
    }
    .search-box:focus {
        outline: none;
        border-color: var(--accent-blue);
    }
    .filter-select {
        padding: 12px 16px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        cursor: pointer;
    }
    
    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
    }
    .stat-card h3 {
        font-size: 2rem;
        margin: 0 0 5px 0;
        color: var(--text-primary);
    }
    .stat-card p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    .stat-card.critical h3 { color: #ef4444; }
    .stat-card.high h3 { color: #f97316; }
    .stat-card.medium h3 { color: #eab308; }
    .stat-card.low h3 { color: #22c55e; }
    .stat-card.blocked h3 { color: #a855f7; }
    
    /* Table */
    .data-table {
        width: 100%;
        background: var(--bg-secondary);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    .data-table th, .data-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    .data-table th {
        background: rgba(0,0,0,0.2);
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 12px;
        text-transform: uppercase;
    }
    .data-table tr:hover {
        background: rgba(0,212,255,0.05);
    }
    .data-table tr:last-child td {
        border-bottom: none;
    }
    
    /* Threat Level Badges */
    .threat-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .threat-badge.CRITICAL { background: rgba(239,68,68,0.2); color: #ef4444; }
    .threat-badge.HIGH { background: rgba(249,115,22,0.2); color: #f97316; }
    .threat-badge.MEDIUM { background: rgba(234,179,8,0.2); color: #eab308; }
    .threat-badge.LOW { background: rgba(34,197,94,0.2); color: #22c55e; }
    .threat-badge.NONE { background: rgba(100,100,100,0.2); color: #888; }
    
    /* Blocked Badge */
    .blocked-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
    }
    .blocked-badge.yes { background: rgba(239,68,68,0.2); color: #ef4444; }
    .blocked-badge.no { background: rgba(34,197,94,0.2); color: #22c55e; }
    
    /* Pattern Tags */
    .pattern-tag {
        display: inline-block;
        padding: 2px 8px;
        margin: 2px;
        background: rgba(124,58,237,0.2);
        color: #a78bfa;
        border-radius: 4px;
        font-size: 11px;
        font-family: monospace;
    }
    
    /* Input Preview */
    .input-preview {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-family: monospace;
        font-size: 12px;
        color: var(--text-secondary);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }
    .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üõ°Ô∏è Security Events</h1>
    <p>Monitor security threats, prompt injection attempts, and blocked requests</p>
</div>

<!-- Stats Cards -->
<div class="stats-grid" id="stats-grid">
    <div class="stat-card">
        <h3 id="stat-total">-</h3>
        <p>Total Events</p>
    </div>
    <div class="stat-card blocked">
        <h3 id="stat-blocked">-</h3>
        <p>Blocked</p>
    </div>
    <div class="stat-card critical">
        <h3 id="stat-critical">-</h3>
        <p>Critical</p>
    </div>
    <div class="stat-card high">
        <h3 id="stat-high">-</h3>
        <p>High</p>
    </div>
    <div class="stat-card medium">
        <h3 id="stat-medium">-</h3>
        <p>Medium</p>
    </div>
    <div class="stat-card low">
        <h3 id="stat-low">-</h3>
        <p>Low</p>
    </div>
</div>

<div class="page-controls">
    <input type="text" class="search-box" id="search-input" placeholder="Search patterns, types, sources...">
    <select class="filter-select" id="level-filter">
        <option value="">All Threat Levels</option>
        <option value="CRITICAL">Critical</option>
        <option value="HIGH">High</option>
        <option value="MEDIUM">Medium</option>
        <option value="LOW">Low</option>
    </select>
    <select class="filter-select" id="blocked-filter">
        <option value="">All Requests</option>
        <option value="blocked">Blocked Only</option>
        <option value="allowed">Allowed Only</option>
    </select>
    <button class="btn btn-primary" onclick="loadSecurityEvents()">Refresh</button>
</div>

<div id="events-container">
    <table class="data-table" id="events-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>Level</th>
                <th>Type</th>
                <th>Patterns</th>
                <th>Source</th>
                <th>Blocked</th>
                <th>Preview</th>
            </tr>
        </thead>
        <tbody id="events-body">
            <tr><td colspan="7" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
    <div id="events-pagination"></div>
</div>
{% endblock %}

{% block extra_js %}
<script data-page-script>
    let allEvents = [];

    async function loadSecurityStats() {
        try {
            const data = await fetchAriaData(`${window.ARIA_API_BASE_URL}/security-events/stats`);
            document.getElementById('stat-total').textContent = data.total_events || 0;
            document.getElementById('stat-blocked').textContent = data.blocked_count || 0;
            document.getElementById('stat-critical').textContent = data.by_level?.CRITICAL || 0;
            document.getElementById('stat-high').textContent = data.by_level?.HIGH || 0;
            document.getElementById('stat-medium').textContent = data.by_level?.MEDIUM || 0;
            document.getElementById('stat-low').textContent = data.by_level?.LOW || 0;
        } catch (e) {
            console.error('Failed to load stats:', e);
        }
    }
    let eventsPager;

    async function loadSecurityEvents(page = 1, limit = 25) {
        document.getElementById('events-body').innerHTML = '<tr><td colspan="7" class="empty-state">Loading...</td></tr>';

        try {
            const data = await fetchAriaData(`${window.ARIA_API_BASE_URL}/security-events?limit=${limit}&page=${page}`);
            allEvents = data.items || data;
            renderEvents(allEvents);
            loadSecurityStats();
            if (eventsPager && data.pages) eventsPager.update(data);
        } catch (e) {
            document.getElementById('events-body').innerHTML = `
                <tr><td colspan="7" class="empty-state">
                    <div>Could not load security events</div>
                    <div style="font-size:12px;margin-top:10px">${e.message}</div>
                </td></tr>`;
        }
    }

    function renderEvents(data) {
        if (!data || data.length === 0) {
            document.getElementById('events-body').innerHTML = `
                <tr><td colspan="7" class="empty-state">
                    <svg fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                    </svg>
                    <div>No security events recorded</div>
                    <div style="font-size:14px;margin-top:10px">Aria's defenses are monitoring for threats</div>
                </td></tr>`;
            return;
        }

        let html = '';
        data.forEach(e => {
            const time = e.created_at ? new Date(e.created_at).toLocaleString() : '-';
            const patterns = (e.threat_patterns || []).map(p => 
                `<span class="pattern-tag">${escapeHtml(p)}</span>`
            ).join('');
            const blockedClass = e.blocked ? 'yes' : 'no';
            const blockedText = e.blocked ? 'üö´ Blocked' : '‚úÖ Allowed';
            const preview = escapeHtml(e.input_preview || '');
            
            html += `<tr>
                <td>${time}</td>
                <td><span class="threat-badge ${e.threat_level}">${e.threat_level}</span></td>
                <td>${escapeHtml(e.threat_type)}</td>
                <td>${patterns || '-'}</td>
                <td>${escapeHtml(e.source) || '-'}</td>
                <td><span class="blocked-badge ${blockedClass}">${blockedText}</span></td>
                <td><div class="input-preview" title="${escapeHtml(preview)}">${preview || '-'}</div></td>
            </tr>`;
        });
        document.getElementById('events-body').innerHTML = html;
    }

    function filterEvents() {
        const search = document.getElementById('search-input').value.toLowerCase();
        const levelFilter = document.getElementById('level-filter').value;
        const blockedFilter = document.getElementById('blocked-filter').value;
        
        let filtered = allEvents;
        
        if (search) {
            filtered = filtered.filter(e => 
                (e.threat_type && e.threat_type.toLowerCase().includes(search)) ||
                (e.source && e.source.toLowerCase().includes(search)) ||
                (e.input_preview && e.input_preview.toLowerCase().includes(search)) ||
                (e.threat_patterns && e.threat_patterns.some(p => p.toLowerCase().includes(search)))
            );
        }
        
        if (levelFilter) {
            filtered = filtered.filter(e => e.threat_level === levelFilter);
        }
        
        if (blockedFilter === 'blocked') {
            filtered = filtered.filter(e => e.blocked);
        } else if (blockedFilter === 'allowed') {
            filtered = filtered.filter(e => !e.blocked);
        }
        
        renderEvents(filtered);
    }

    document.getElementById('search-input').addEventListener('input', filterEvents);
    document.getElementById('level-filter').addEventListener('change', filterEvents);
    document.getElementById('blocked-filter').addEventListener('change', filterEvents);

    eventsPager = new AriaPagination('events-pagination', {
        onPageChange: (page, limit) => loadSecurityEvents(page, limit),
        limit: 25
    });
    loadSecurityEvents();
</script>
{% endblock %}
