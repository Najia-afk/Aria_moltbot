{% extends "base.html" %}
{% set dynamic_host = request.host.split(':')[0] %}
{% block title %}Services - Aria{% endblock %}

{% block extra_css %}
<style>
/* Architecture Diagram */
.architecture-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
}
.architecture-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}
.architecture-title {
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.architecture-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.status-summary {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: var(--text-muted);
}
.status-summary .online { color: var(--success); }
.status-summary .offline { color: var(--danger); }
.architecture-diagram {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}
.arch-layer {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: 1rem;
}
.arch-layer-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--text-muted);
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px dashed var(--border-color);
}
.arch-services {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: center;
}
.arch-service {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
    padding: 0.75rem 1rem;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    min-width: 110px;
    text-align: center;
    font-size: 0.85rem;
    transition: all 0.2s;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    position: relative;
}
.arch-service:hover {
    border-color: var(--accent-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}
.arch-service.online {
    border-color: var(--success);
}
.arch-service.offline {
    border-color: var(--danger);
}
.arch-service.checking {
    border-color: var(--warning);
}
.arch-service-icon {
    font-size: 1.8rem;
}
.arch-service-name {
    font-weight: 600;
    font-size: 0.9rem;
}
.arch-service-port {
    font-size: 0.7rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
}
.arch-service-status {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--border-color);
}
.arch-service.online .arch-service-status {
    background: var(--success);
    box-shadow: 0 0 6px var(--success);
}
.arch-service.offline .arch-service-status {
    background: var(--danger);
}
.arch-service.checking .arch-service-status {
    background: var(--warning);
    animation: pulse 1s infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
.arch-arrow {
    display: flex;
    justify-content: center;
    color: var(--text-muted);
    font-size: 1.2rem;
}
.arch-legend {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px dashed var(--border-color);
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: var(--text-muted);
}
.legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}
.legend-dot.online { background: var(--success); }
.legend-dot.offline { background: var(--danger); }
.legend-dot.checking { background: var(--warning); }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‚öôÔ∏è Services</h1>
    <p>Monitor and manage all Aria stack services</p>
</div>

<!-- Architecture Diagram with Live Status -->
<div class="architecture-section">
    <div class="architecture-header">
        <div class="architecture-title">üèóÔ∏è Service Architecture</div>
        <div class="architecture-actions">
            <div class="status-summary">
                <span class="online" id="online-count">0 online</span>
                <span class="offline" id="offline-count">0 offline</span>
            </div>
            <button class="btn btn-primary" onclick="refreshAllStatus()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12a9 9 0 11-6.22-8.56"/>
                </svg>
                Refresh
            </button>
        </div>
    </div>
    <div class="architecture-diagram">
        <!-- External Layer -->
        <div class="arch-layer">
            <div class="arch-layer-title">üåê External Access</div>
            <div class="arch-services">
                <a href="/traefik/dashboard/" target="_blank" class="arch-service checking" data-service="traefik">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üîÄ</div>
                    <div class="arch-service-name">Traefik</div>
                    <div class="arch-service-port">:80/:443</div>
                </a>
                <a href="{{ clawdbot_public_url }}" target="_blank" class="arch-service checking" data-service="clawdbot">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">ü¶û</div>
                    <div class="arch-service-name">OpenClaw</div>
                    <div class="arch-service-port">:18789</div>
                </a>
                <a href="/litellm" class="arch-service checking" data-service="litellm">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">‚ö°</div>
                    <div class="arch-service-name">LiteLLM</div>
                    <div class="arch-service-port">:18793</div>
                </a>
            </div>
        </div>
        
        <div class="arch-arrow">‚ñº</div>
        
        <!-- Core Services Layer -->
        <div class="arch-layer">
            <div class="arch-layer-title">üê≥ Docker Core Services</div>
            <div class="arch-services">
                <a href="/" class="arch-service checking" data-service="aria-web">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üåê</div>
                    <div class="arch-service-name">aria-web</div>
                    <div class="arch-service-port">Flask :5000</div>
                </a>
                <a href="/api/docs" target="_blank" class="arch-service checking" data-service="aria-api">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üöÄ</div>
                    <div class="arch-service-name">aria-api</div>
                    <div class="arch-service-port">FastAPI :8000</div>
                </a>
            </div>
        </div>
        
        <div class="arch-arrow">‚ñº</div>
        
        <!-- LLM Layer -->
        <div class="arch-layer">
            <div class="arch-layer-title">üß† LLM Backends</div>
            <div class="arch-services">
                <a href="http://{{ dynamic_host }}:8080/" target="_blank" class="arch-service checking" data-service="mlx">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üçé</div>
                    <div class="arch-service-name">MLX</div>
                    <div class="arch-service-port">:8080 (Metal)</div>
                </a>
                <a href="/ollama/" target="_blank" class="arch-service checking" data-service="ollama">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">ü¶ô</div>
                    <div class="arch-service-name">Ollama</div>
                    <div class="arch-service-port">:11434</div>
                </a>
                <div class="arch-service" data-service="openrouter" style="cursor: default;">
                    <span class="arch-service-status" style="background: var(--info);"></span>
                    <div class="arch-service-icon">üåê</div>
                    <div class="arch-service-name">OpenRouter</div>
                    <div class="arch-service-port">Free Models</div>
                </div>
            </div>
        </div>
        
        <div class="arch-arrow">‚ñº</div>
        
        <!-- Storage & Monitoring Layer -->
        <div class="arch-layer">
            <div class="arch-layer-title">üíæ Storage & Monitoring</div>
            <div class="arch-services">
                <div class="arch-service checking" data-service="postgres">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üêò</div>
                    <div class="arch-service-name">PostgreSQL</div>
                    <div class="arch-service-port">:5432</div>
                </div>
                <a href="/grafana/" target="_blank" class="arch-service checking" data-service="grafana">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üìà</div>
                    <div class="arch-service-name">Grafana</div>
                    <div class="arch-service-port">:3001</div>
                </a>
                <a href="/prometheus/" target="_blank" class="arch-service checking" data-service="prometheus">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üìä</div>
                    <div class="arch-service-name">Prometheus</div>
                    <div class="arch-service-port">:9090</div>
                </a>
                <a href="/pgadmin/" target="_blank" class="arch-service checking" data-service="pgadmin">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üîß</div>
                    <div class="arch-service-name">PgAdmin</div>
                    <div class="arch-service-port">:5050</div>
                </a>
            </div>
        </div>
        
        <!-- Legend -->
        <div class="arch-legend">
            <div class="legend-item"><span class="legend-dot online"></span> Online</div>
            <div class="legend-item"><span class="legend-dot offline"></span> Offline</div>
            <div class="legend-item"><span class="legend-dot checking"></span> Checking</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script data-page-script>
const services = [
    'traefik', 'clawdbot', 'litellm',
    'aria-web', 'aria-api',
    'mlx', 'ollama',
    'postgres', 'grafana', 'prometheus', 'pgadmin'
];

let onlineCount = 0;
let offlineCount = 0;

async function checkServiceStatus(serviceId) {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        const response = await fetch(`${window.ARIA_API_BASE_URL}/status/${serviceId}`, {
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        const data = await response.json();
        return data.status === 'online';
    } catch {
        return false;
    }
}

function updateServiceStatus(serviceId, online) {
    const el = document.querySelector(`[data-service="${serviceId}"]`);
    if (!el) return;
    
    el.classList.remove('checking', 'online', 'offline');
    el.classList.add(online ? 'online' : 'offline');
    
    if (online) onlineCount++;
    else offlineCount++;
    
    document.getElementById('online-count').textContent = `${onlineCount} online`;
    document.getElementById('offline-count').textContent = `${offlineCount} offline`;
}

async function refreshAllStatus() {
    onlineCount = 0;
    offlineCount = 0;
    
    // Reset all to checking
    services.forEach(id => {
        const el = document.querySelector(`[data-service="${id}"]`);
        if (el) {
            el.classList.remove('online', 'offline');
            el.classList.add('checking');
        }
    });
    
    document.getElementById('online-count').textContent = '... checking';
    document.getElementById('offline-count').textContent = '';
    
    // Check all services
    for (const serviceId of services) {
        const online = await checkServiceStatus(serviceId);
        updateServiceStatus(serviceId, online);
        await new Promise(r => setTimeout(r, 100)); // Small delay
    }
}

// Initial load
document.addEventListener('DOMContentLoaded', refreshAllStatus);
</script>
{% endblock %}
