{% extends "base.html" %}
{% set dynamic_host = request.host.split(':')[0] %}
{% block title %}Services - Aria{% endblock %}

{% block extra_css %}
<style>
/* Architecture Diagram */
.architecture-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
}
.architecture-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}
.architecture-title {
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.architecture-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.admin-token-btn {
    background: transparent;
    border: 1px dashed var(--border-color);
    color: var(--text-muted);
    padding: 0.35rem 0.6rem;
    border-radius: var(--radius-md);
    font-size: 0.75rem;
    cursor: pointer;
}
.admin-token-btn:hover {
    color: var(--text-primary);
    border-color: var(--border-accent);
}
.status-summary {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: var(--text-muted);
}
.status-summary .online { color: var(--success); }
.status-summary .offline { color: var(--danger); }
.architecture-diagram {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}
.arch-layer {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: 1rem;
}
.arch-layer-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--text-muted);
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px dashed var(--border-color);
}
.arch-services {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: center;
}
.arch-service {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
    padding: 0.75rem 1rem;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    min-width: 110px;
    text-align: center;
    font-size: 0.85rem;
    transition: all 0.2s;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    position: relative;
}
.arch-service:hover {
    border-color: var(--accent-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}
.arch-service.online {
    border-color: var(--success);
}
.arch-service.offline {
    border-color: var(--danger);
}
.arch-service.checking {
    border-color: var(--warning);
}
.arch-service-icon {
    font-size: 1.8rem;
}
.arch-service-name {
    font-weight: 600;
    font-size: 0.9rem;
}
.arch-service-port {
    font-size: 0.7rem;
    color: var(--text-muted);
    font-family: var(--font-mono);
}
.arch-service-status {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--border-color);
}
.arch-service.online .arch-service-status {
    background: var(--success);
    box-shadow: 0 0 6px var(--success);
}
.arch-service.offline .arch-service-status {
    background: var(--danger);
}
.arch-service.checking .arch-service-status {
    background: var(--warning);
    animation: pulse 1s infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
.arch-arrow {
    display: flex;
    justify-content: center;
    color: var(--text-muted);
    font-size: 1.2rem;
}
.arch-legend {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px dashed var(--border-color);
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: var(--text-muted);
}
.legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}
.legend-dot.online { background: var(--success); }
.legend-dot.offline { background: var(--danger); }
.legend-dot.checking { background: var(--warning); }

.control-panel {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
}
.control-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.75rem;
}
.control-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
.control-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.9rem;
    font-weight: 600;
}
.control-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--border-color);
}
.control-card.online .control-status {
    background: var(--success);
    box-shadow: 0 0 6px var(--success);
}
.control-card.offline .control-status { background: var(--danger); }
.control-card.checking .control-status {
    background: var(--warning);
    animation: pulse 1s infinite;
}
.control-actions {
    display: flex;
    gap: 0.5rem;
}
.control-btn {
    flex: 1;
    font-size: 0.75rem;
    padding: 0.35rem 0.5rem;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
}
.control-btn:hover { border-color: var(--border-accent); }
.control-btn.danger {
    border-color: rgba(239, 68, 68, 0.6);
    color: #ef4444;
}
.control-btn.danger:hover { background: rgba(239, 68, 68, 0.1); }
.control-note {
    font-size: 0.7rem;
    color: var(--text-muted);
}
.app-flow-section {
    margin-top: 1.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
}
.app-flow-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
}
.app-flow {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    justify-content: center;
}
.app-node {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 0.6rem 0.9rem;
    font-size: 0.85rem;
    text-align: center;
    min-width: 120px;
}
.app-arrow {
    color: var(--text-muted);
    font-size: 1.2rem;
}
</style>
{% endblock %}
{% block content %}
<div class="page-header">
    <h1>‚öôÔ∏è Services</h1>
    <p>Monitor and manage all Aria stack services</p>
</div>

<!-- Architecture Diagram with Live Status -->
<div class="architecture-section">
    <div class="architecture-header">
        <div class="architecture-title">üèóÔ∏è Service Architecture</div>
        <div class="architecture-actions">
            <div class="status-summary">
                <span class="online" id="online-count">0 online</span>
                <span class="offline" id="offline-count">0 offline</span>
            </div>
            <button class="admin-token-btn" id="set-admin-token">Set Admin Token</button>
            <button class="btn btn-primary" onclick="refreshAllStatus()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12a9 9 0 11-6.22-8.56"/>
                </svg>
                Refresh
            </button>
        </div>
    </div>
    <div class="architecture-diagram">
        <!-- External Layer -->
        <div class="arch-layer">
            <div class="arch-layer-title">üåê External Access</div>
            <div class="arch-services">
                <a href="/traefik/dashboard/" target="_blank" class="arch-service checking" data-service="traefik">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üîÄ</div>
                    <div class="arch-service-name">Traefik</div>
                    <div class="arch-service-port">:80/:443</div>
                </a>
                <a href="/clawdbot/?session=main&token={{ clawdbot_token }}" target="_blank" class="arch-service checking clawdbot-link" data-service="clawdbot">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">ü¶û</div>
                    <div class="arch-service-name">OpenClaw</div>
                    <div class="arch-service-port">:18789</div>
                </a>
                <a href="/models" class="arch-service checking" data-service="litellm">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">‚ö°</div>
                    <div class="arch-service-name">LiteLLM</div>
                    <div class="arch-service-port">:18793</div>
                </a>
            </div>
        </div>
        
        <div class="arch-arrow">‚ñº</div>
        
        <!-- Core Services Layer -->
        <div class="arch-layer">
            <div class="arch-layer-title">üê≥ Docker Core Services</div>
            <div class="arch-services">
                <a href="/" class="arch-service checking" data-service="aria-web">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üåê</div>
                    <div class="arch-service-name">aria-web</div>
                    <div class="arch-service-port">Flask :5000</div>
                </a>
                <a href="/api/docs" target="_blank" class="arch-service checking" data-service="aria-api">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üöÄ</div>
                    <div class="arch-service-name">aria-api</div>
                    <div class="arch-service-port">FastAPI :8000</div>
                </a>
            </div>
        </div>
        
        <div class="arch-arrow">‚ñº</div>
        
        <!-- LLM Layer -->
        <div class="arch-layer">
            <div class="arch-layer-title">üß† LLM Backends</div>
            <div class="arch-services">
                <a href="http://{{ dynamic_host }}:8080/" target="_blank" class="arch-service checking" data-service="mlx">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üçé</div>
                    <div class="arch-service-name">MLX</div>
                    <div class="arch-service-port">:8080 (Metal)</div>
                </a>
                <a href="/ollama/" target="_blank" class="arch-service checking" data-service="ollama">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">ü¶ô</div>
                    <div class="arch-service-name">Ollama</div>
                    <div class="arch-service-port">:11434</div>
                </a>
                <div class="arch-service" data-service="openrouter" style="cursor: default;">
                    <span class="arch-service-status" style="background: var(--info);"></span>
                    <div class="arch-service-icon">üåê</div>
                    <div class="arch-service-name">OpenRouter</div>
                    <div class="arch-service-port">Free Models</div>
                </div>
            </div>
        </div>
        
        <div class="arch-arrow">‚ñº</div>
        
        <!-- Storage & Monitoring Layer -->
        <div class="arch-layer">
            <div class="arch-layer-title">üíæ Storage & Monitoring</div>
            <div class="arch-services">
                <div class="arch-service checking" data-service="postgres">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üêò</div>
                    <div class="arch-service-name">PostgreSQL</div>
                    <div class="arch-service-port">:5432</div>
                </div>
                <a href="/grafana/" target="_blank" class="arch-service checking" data-service="grafana">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üìà</div>
                    <div class="arch-service-name">Grafana</div>
                    <div class="arch-service-port">:3001</div>
                </a>
                <a href="/prometheus/" target="_blank" class="arch-service checking" data-service="prometheus">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üìä</div>
                    <div class="arch-service-name">Prometheus</div>
                    <div class="arch-service-port">:9090</div>
                </a>
                <a href="/pgadmin/" target="_blank" class="arch-service checking" data-service="pgadmin">
                    <span class="arch-service-status"></span>
                    <div class="arch-service-icon">üîß</div>
                    <div class="arch-service-name">PgAdmin</div>
                    <div class="arch-service-port">:5050</div>
                </a>
            </div>
        </div>
        
        <!-- Legend -->
        <div class="arch-legend">
            <div class="legend-item"><span class="legend-dot online"></span> Online</div>
            <div class="legend-item"><span class="legend-dot offline"></span> Offline</div>
            <div class="legend-item"><span class="legend-dot checking"></span> Checking</div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="arch-layer-title">üßØ Service Controls (Admin)</div>
            <div class="control-grid">
                <div class="control-card checking" data-service="litellm">
                    <div class="control-header">LiteLLM<span class="control-status"></span></div>
                    <div class="control-actions">
                        <button class="control-btn" data-action="restart">Restart</button>
                        <button class="control-btn danger" data-action="stop">Kill</button>
                    </div>
                    <div class="control-note">Router</div>
                </div>
                <div class="control-card checking" data-service="ollama">
                    <div class="control-header">Ollama<span class="control-status"></span></div>
                    <div class="control-actions">
                        <button class="control-btn" data-action="restart">Restart</button>
                        <button class="control-btn danger" data-action="stop">Kill</button>
                    </div>
                    <div class="control-note">Local LLM</div>
                </div>
                <div class="control-card checking" data-service="mlx">
                    <div class="control-header">MLX<span class="control-status"></span></div>
                    <div class="control-actions">
                        <button class="control-btn" data-action="restart">Restart</button>
                        <button class="control-btn danger" data-action="stop">Kill</button>
                    </div>
                    <div class="control-note">Apple Silicon</div>
                </div>
                <div class="control-card checking" data-service="aria-api">
                    <div class="control-header">aria-api<span class="control-status"></span></div>
                    <div class="control-actions">
                        <button class="control-btn" data-action="restart">Restart</button>
                        <button class="control-btn danger" data-action="stop">Kill</button>
                    </div>
                    <div class="control-note">FastAPI</div>
                </div>
                <div class="control-card checking" data-service="aria-web">
                    <div class="control-header">aria-web<span class="control-status"></span></div>
                    <div class="control-actions">
                        <button class="control-btn" data-action="restart">Restart</button>
                        <button class="control-btn danger" data-action="stop">Kill</button>
                    </div>
                    <div class="control-note">Flask UI</div>
                </div>
                <div class="control-card checking" data-service="clawdbot">
                    <div class="control-header">OpenClaw<span class="control-status"></span></div>
                    <div class="control-actions">
                        <button class="control-btn" data-action="restart">Restart</button>
                        <button class="control-btn danger" data-action="stop">Kill</button>
                    </div>
                    <div class="control-note">Gateway</div>
                </div>
                <div class="control-card checking" data-service="grafana">
                    <div class="control-header">Grafana<span class="control-status"></span></div>
                    <div class="control-actions">
                        <button class="control-btn" data-action="restart">Restart</button>
                        <button class="control-btn danger" data-action="stop">Kill</button>
                    </div>
                    <div class="control-note">Dashboards</div>
                </div>
                <div class="control-card checking" data-service="prometheus">
                    <div class="control-header">Prometheus<span class="control-status"></span></div>
                    <div class="control-actions">
                        <button class="control-btn" data-action="restart">Restart</button>
                        <button class="control-btn danger" data-action="stop">Kill</button>
                    </div>
                    <div class="control-note">Metrics</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Application Flow Diagram -->
<div class="app-flow-section">
    <div class="app-flow-title">üß© Application Flow</div>
    <div class="app-flow">
        <div class="app-node">User</div>
        <div class="app-arrow">‚Üí</div>
        <div class="app-node">aria-web</div>
        <div class="app-arrow">‚Üí</div>
        <div class="app-node">aria-api</div>
        <div class="app-arrow">‚Üí</div>
        <div class="app-node">aria-db</div>
        <div class="app-arrow">‚Üî</div>
        <div class="app-node">LiteLLM</div>
        <div class="app-arrow">‚Üí</div>
        <div class="app-node">MLX / Ollama</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script data-page-script>
const services = [
    'traefik', 'clawdbot', 'litellm',
    'aria-web', 'aria-api',
    'mlx', 'ollama',
    'postgres', 'grafana', 'prometheus', 'pgadmin'
];

let onlineCount = 0;
let offlineCount = 0;

async function checkServiceStatus(serviceId) {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        const response = await fetch(`${window.ARIA_API_BASE_URL}/status/${serviceId}`, {
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        const data = await response.json();
        return data.status === 'online';
    } catch {
        return false;
    }
}

function updateServiceStatus(serviceId, online) {
    const elements = document.querySelectorAll(`[data-service="${serviceId}"]`);
    if (!elements.length) return;
    
    elements.forEach(el => {
        el.classList.remove('checking', 'online', 'offline');
        el.classList.add(online ? 'online' : 'offline');
    });
    
    if (online) onlineCount++;
    else offlineCount++;
    
    document.getElementById('online-count').textContent = `${onlineCount} online`;
    document.getElementById('offline-count').textContent = `${offlineCount} offline`;
}

async function refreshAllStatus() {
    onlineCount = 0;
    offlineCount = 0;
    
    // Reset all to checking
    services.forEach(id => {
        const elements = document.querySelectorAll(`[data-service="${id}"]`);
        elements.forEach(el => {
            el.classList.remove('online', 'offline');
            el.classList.add('checking');
        });
    });
    
    document.getElementById('online-count').textContent = '... checking';
    document.getElementById('offline-count').textContent = '';
    
    // Check all services
    for (const serviceId of services) {
        const online = await checkServiceStatus(serviceId);
        updateServiceStatus(serviceId, online);
        await new Promise(r => setTimeout(r, 100)); // Small delay
    }
}

function getAdminToken() {
    let token = localStorage.getItem('ariaAdminToken');
    if (!token) {
        token = prompt('Enter admin token (stored locally):');
        if (token) localStorage.setItem('ariaAdminToken', token);
    }
    return token || '';
}

async function runServiceAction(serviceId, action) {
    const confirmText = action === 'stop'
        ? `Kill ${serviceId}? This will stop the service.`
        : `Restart ${serviceId}?`;
    if (!confirm(confirmText)) return;

    const token = getAdminToken();
    const headers = token ? { 'X-Admin-Token': token } : {};

    try {
        const response = await fetch(
            `${window.ARIA_API_BASE_URL}/admin/services/${serviceId}/${action}`,
            { method: 'POST', headers }
        );
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
            alert(data.detail || 'Service action failed');
            return;
        }
        alert(`${serviceId} ${action}: ${data.status || 'ok'}`);
        refreshAllStatus();
    } catch (err) {
        alert(`Request failed: ${err}`);
    }
}

// Initial load
document.addEventListener('DOMContentLoaded', () => refreshAllStatus());

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.control-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const card = btn.closest('[data-service]');
            if (!card) return;
            const serviceId = card.getAttribute('data-service');
            const action = btn.getAttribute('data-action');
            if (serviceId && action) runServiceAction(serviceId, action);
        });
    });

    const setTokenBtn = document.getElementById('set-admin-token');
    if (setTokenBtn) {
        setTokenBtn.addEventListener('click', () => {
            const token = prompt('Enter admin token (stored locally):');
            if (token) localStorage.setItem('ariaAdminToken', token);
        });
    }
});
</script>
{% endblock %}
