{% extends "base.html" %}
{% block title %}Rate Limits{% endblock %}

{% block extra_css %}
<style>
    .page-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .search-box { flex: 1; min-width: 200px; padding: 10px 14px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 13px; }
    .search-box:focus { outline: none; border-color: var(--accent-blue); }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .stat-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; padding: 18px; }
    .stat-card h4 { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.03em; }
    .stat-card .value { font-size: 22px; font-weight: 700; color: var(--text-primary); }
    .stat-card.blue .value { color: var(--accent-blue); }
    .stat-card.green .value { color: var(--success); }
    .stat-card.purple .value { color: #a855f7; }
    .stat-card.orange .value { color: #f59e0b; }
    .stats-sub { font-size: 11px; color: var(--text-muted); margin-top: 3px; }

    /* Info */
    .info-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; padding: 16px 20px; margin-bottom: 20px; }
    .info-card h3 { font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; }
    .info-card p { font-size: 12px; color: var(--text-muted); line-height: 1.6; }

    /* Table */
    .section-title { font-size: 15px; font-weight: 600; margin: 20px 0 12px; display: flex; align-items: center; gap: 8px; }
    .data-table { width: 100%; background: var(--bg-secondary); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); }
    .data-table th, .data-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 13px; }
    .data-table th { background: rgba(0,0,0,0.2); font-weight: 600; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; }
    .data-table tr:hover { background: rgba(0,212,255,0.04); }
    .data-table tr:last-child td { border-bottom: none; }

    .skill-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 10px; background: rgba(59,130,246,0.15); border-radius: 10px; font-size: 12px; font-weight: 600; color: var(--accent-blue); }

    /* Progress bar for action count */
    .action-bar-wrap { display: flex; align-items: center; gap: 8px; min-width: 140px; }
    .action-bar { flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; max-width: 100px; }
    .action-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
    .action-bar-fill.low { background: var(--success); }
    .action-bar-fill.medium { background: #f59e0b; }
    .action-bar-fill.high { background: var(--danger); }
    .action-count { font-weight: 700; min-width: 30px; }

    .empty-state { text-align: center; padding: 50px 20px; color: var(--text-secondary); }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>‚è±Ô∏è Rate Limits</h1>
    <p>Monitor API and skill rate limiting status</p>
</div>

<div class="info-card">
    <h3>‚ÑπÔ∏è About Rate Limits</h3>
    <p>Rate limits prevent abuse and ensure fair resource usage. Each skill tracks its action count within a rolling time window. When the count exceeds the configured limit, requests are temporarily blocked until the window resets.</p>
</div>

<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card blue">
        <h4>Skills Tracked</h4>
        <div class="value" id="stat-skills">-</div>
    </div>
    <div class="stat-card purple">
        <h4>Total Actions</h4>
        <div class="value" id="stat-actions">-</div>
    </div>
    <div class="stat-card orange">
        <h4>Highest Count</h4>
        <div class="value" id="stat-highest">-</div>
        <div class="stats-sub" id="stat-highest-sub"></div>
    </div>
    <div class="stat-card green">
        <h4>Last Activity</h4>
        <div class="value" id="stat-last" style="font-size:14px">-</div>
    </div>
</div>

<div class="page-controls">
    <input type="text" class="search-box" id="search-input" placeholder="Search by skill name...">
    <button class="btn btn-primary" onclick="loadRateLimits()">Refresh</button>
</div>

<h3 class="section-title">üîß Rate Limit Status</h3>
<table class="data-table" id="limits-table">
    <thead>
        <tr>
            <th>Skill</th>
            <th>Action Count</th>
            <th>Last Action</th>
            <th>Last Post</th>
            <th>Window Start</th>
            <th>Updated</th>
        </tr>
    </thead>
    <tbody id="limits-body">
        <tr><td colspan="6" class="empty-state">Loading...</td></tr>
    </tbody>
</table>

<!-- Model Limits from models.yaml -->
<h3 class="section-title" style="margin-top:30px">ü§ñ Model Configuration (models.yaml)</h3>
<table class="data-table" id="model-config-table">
    <thead>
        <tr>
            <th>Model</th>
            <th>Tier</th>
            <th>Context Window</th>
            <th>Max Tokens</th>
            <th>Cost (in/out per 1M)</th>
            <th>Reasoning</th>
        </tr>
    </thead>
    <tbody id="model-config-body">
        <tr><td colspan="6" class="empty-state">Loading...</td></tr>
    </tbody>
</table>
{% endblock %}

{% block extra_js %}
<script data-page-script>
let allLimits = [];

async function loadRateLimits() {
    document.getElementById('limits-body').innerHTML = '<tr><td colspan="6" class="empty-state">Loading...</td></tr>';
    try {
        const res = await fetch(`${API_BASE_URL}/rate-limits`);
        const data = await res.json();
        allLimits = data.rate_limits || [];
        renderStats();
        renderLimits(allLimits);
    } catch (e) {
        document.getElementById('limits-body').innerHTML = `
            <tr><td colspan="6" class="empty-state">
                <div>Could not load rate limits</div>
                <div style="font-size:12px;margin-top:10px">${e.message}</div>
            </td></tr>`;
    }
}

function renderStats() {
    const totalActions = allLimits.reduce((a, r) => a + (r.action_count || 0), 0);
    const highest = allLimits.reduce((max, r) => (r.action_count || 0) > (max.action_count || 0) ? r : max, { action_count: 0 });
    const lastActivity = allLimits.reduce((latest, r) => {
        const t = r.last_action || r.last_post || r.updated_at;
        return t && (!latest || t > latest) ? t : latest;
    }, null);

    document.getElementById('stat-skills').textContent = allLimits.length;
    document.getElementById('stat-actions').textContent = formatNumber(totalActions);
    document.getElementById('stat-highest').textContent = highest.action_count || 0;
    document.getElementById('stat-highest-sub').textContent = highest.skill || '-';
    document.getElementById('stat-last').textContent = lastActivity ? formatDate(lastActivity) : '-';
}

function renderLimits(limits) {
    if (!limits || limits.length === 0) {
        document.getElementById('limits-body').innerHTML = `
            <tr><td colspan="6" class="empty-state">
                <div>No rate limit records</div>
                <div style="font-size:14px;margin-top:10px">Rate limits will appear here as skills are used</div>
            </td></tr>`;
        return;
    }

    const maxCount = Math.max(...limits.map(r => r.action_count || 0), 1);
    let html = '';
    limits.forEach(r => {
        const count = r.action_count || 0;
        const pct = Math.min(count / maxCount * 100, 100);
        const barClass = count < 25 ? 'low' : count < 75 ? 'medium' : 'high';
        html += `<tr>
            <td><span class="skill-badge">üîß ${r.skill}</span></td>
            <td>
                <div class="action-bar-wrap">
                    <div class="action-bar"><div class="action-bar-fill ${barClass}" style="width:${pct}%"></div></div>
                    <span class="action-count">${count}</span>
                </div>
            </td>
            <td>${formatDate(r.last_action)}</td>
            <td>${formatDate(r.last_post)}</td>
            <td>${formatDate(r.window_start)}</td>
            <td>${formatDate(r.updated_at)}</td>
        </tr>`;
    });
    document.getElementById('limits-body').innerHTML = html;
}

function filterLimits() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const filtered = search ? allLimits.filter(r => r.skill.toLowerCase().includes(search)) : allLimits;
    renderLimits(filtered);
}

document.getElementById('search-input').addEventListener('input', filterLimits);

async function init() {
    await AriaModels.init();
    loadRateLimits();
    loadModelConfig();
}

async function loadModelConfig() {
    const tbody = document.getElementById('model-config-body');
    try {
        const res = await fetch(`${API_BASE_URL}/models/config`);
        const data = await res.json();
        const models = data.models || {};
        const entries = Object.values(models);
        if (entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No models configured</td></tr>';
            return;
        }
        const tierColors = { local: '#22c55e', free: '#3b82f6', paid: '#f59e0b' };
        tbody.innerHTML = entries.map(m => {
            const cost = m.cost || {};
            const tierColor = tierColors[m.tier] || '#9ca3af';
            return `<tr>
                <td><strong>${m.name || m.id}</strong></td>
                <td><span style="color:${tierColor};font-weight:600">${(m.tier || '-').toUpperCase()}</span></td>
                <td>${formatNumber(m.contextWindow || 0)}</td>
                <td>${formatNumber(m.maxTokens || 0)}</td>
                <td>$${(cost.input || 0).toFixed(3)} / $${(cost.output || 0).toFixed(3)}</td>
                <td>${m.reasoning ? '‚úÖ' : '‚Äî'}</td>
            </tr>`;
        }).join('');
    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty-state">Failed to load: ${e.message}</td></tr>`;
    }
}

init();
setInterval(loadRateLimits, 30000);
</script>
{% endblock %}
