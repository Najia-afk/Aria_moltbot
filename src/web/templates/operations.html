{% extends "base.html" %}
{% block title %}Operations Dashboard{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    .stat-card h3 {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .stat-card .value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
    }
    .stat-card .subvalue {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
    }
    .stat-card.accent-blue .value { color: var(--accent-blue); }
    .stat-card.accent-green .value { color: var(--success); }
    .stat-card.accent-purple .value { color: #a855f7; }
    .stat-card.accent-orange .value { color: #f59e0b; }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        margin: 30px 0 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .quick-links {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    .quick-link {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        text-decoration: none;
        color: var(--text-primary);
        transition: all 0.2s;
    }
    .quick-link:hover {
        background: var(--bg-tertiary);
        border-color: var(--accent-blue);
        transform: translateX(4px);
    }
    .quick-link .icon {
        font-size: 24px;
    }
    .quick-link .text {
        display: flex;
        flex-direction: column;
    }
    .quick-link .text strong {
        font-size: 14px;
    }
    .quick-link .text span {
        font-size: 12px;
        color: var(--text-muted);
    }
    
    .data-table {
        width: 100%;
        background: var(--bg-secondary);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    .data-table th, .data-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    .data-table th {
        background: rgba(0,0,0,0.2);
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 12px;
        text-transform: uppercase;
    }
    .data-table tr:hover {
        background: rgba(0,212,255,0.05);
    }
    .data-table tr:last-child td {
        border-bottom: none;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
    }
    .status-badge.active { background: rgba(34,197,94,0.2); color: var(--success); }
    .status-badge.completed { background: rgba(59,130,246,0.2); color: #3b82f6; }
    .status-badge.error { background: rgba(239,68,68,0.2); color: var(--danger); }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üîß Operations Dashboard</h1>
    <p>Monitor Aria's operational metrics, cron jobs, and model usage</p>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card accent-blue">
        <h3>‚è∞ Scheduled Jobs</h3>
        <div class="value" id="active-jobs">-</div>
        <div class="subvalue" id="jobs-summary">Loading...</div>
    </div>
    <div class="stat-card accent-green">
        <h3>ü§ñ API Requests</h3>
        <div class="value" id="model-requests">-</div>
        <div class="subvalue" id="model-tokens">Loading...</div>
    </div>
    <div class="stat-card accent-purple">
        <h3>üí∞ Total Spend</h3>
        <div class="value" id="total-cost">-</div>
        <div class="subvalue" id="cost-breakdown">Loading...</div>
    </div>
    <div class="stat-card accent-orange">
        <h3>üü¢ Services</h3>
        <div class="value" id="services-up">-</div>
        <div class="subvalue" id="services-detail">Loading...</div>
    </div>
</div>

<!-- Quick Links -->
<h2 class="section-title">üìä Quick Access</h2>
<div class="quick-links">
    <a href="/models" class="quick-link">
        <span class="icon">ü§ñ</span>
        <span class="text">
            <strong>Models & Usage</strong>
            <span>Track token usage and costs</span>
        </span>
    </a>
    <a href="/services" class="quick-link">
        <span class="icon">‚öôÔ∏è</span>
        <span class="text">
            <strong>Services</strong>
            <span>Service architecture & health</span>
        </span>
    </a>
    <a href="/security" class="quick-link">
        <span class="icon">üõ°Ô∏è</span>
        <span class="text">
            <strong>Security Events</strong>
            <span>View security alerts</span>
        </span>
    </a>
    <a href="/performance" class="quick-link">
        <span class="icon">üìà</span>
        <span class="text">
            <strong>Performance</strong>
            <span>System performance logs</span>
        </span>
    </a>
    <a href="/activities" class="quick-link">
        <span class="icon">‚ö°</span>
        <span class="text">
            <strong>Activities</strong>
            <span>Full activity log</span>
        </span>
    </a>
    <a href="/dashboard" class="quick-link">
        <span class="icon">üìä</span>
        <span class="text">
            <strong>Dashboard</strong>
            <span>Charts & analytics</span>
        </span>
    </a>
</div>

<!-- OpenClaw Cron Jobs -->
<h2 class="section-title">‚è∞ OpenClaw Cron Jobs</h2>
<table class="data-table" id="jobs-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Agent</th>
            <th>Schedule</th>
            <th>Status</th>
            <th>Last Run</th>
            <th>Next Run</th>
            <th>Duration</th>
        </tr>
    </thead>
    <tbody id="jobs-body">
        <tr><td colspan="7" style="text-align:center;padding:30px;">Loading jobs...</td></tr>
    </tbody>
</table>

<!-- Top Models from LiteLLM -->
<h2 class="section-title">ü§ñ Model Usage (LiteLLM)</h2>
<table class="data-table" id="models-table">
    <thead>
        <tr>
            <th>Model</th>
            <th>Requests</th>
            <th>Input Tokens</th>
            <th>Output Tokens</th>
            <th>Total Tokens</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody id="models-body">
        <tr><td colspan="6" style="text-align:center;padding:30px;">Loading model stats...</td></tr>
    </tbody>
</table>

<!-- Recent API Calls -->
<h2 class="section-title">üìù Recent API Calls</h2>
<table class="data-table" id="logs-table">
    <thead>
        <tr>
            <th>Time</th>
            <th>Model</th>
            <th>Tokens</th>
            <th>Cost</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody id="logs-body">
        <tr><td colspan="5" style="text-align:center;padding:30px;">Loading logs...</td></tr>
    </tbody>
</table>
{% endblock %}

{% block extra_js %}
<script data-page-script>
    function formatCost(cost) {
        if (!cost || cost === 0) return '$0.00';
        if (cost < 0.01) return '$' + cost.toFixed(4);
        return '$' + cost.toFixed(2);
    }
    
    function formatNumber(num) {
        if (!num) return '0';
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }
    
    function formatDate(isoString) {
        if (!isoString) return '-';
        const d = new Date(isoString);
        const now = new Date();
        const diffMs = now - d;

        // Future dates (next_run_at)
        if (diffMs < 0) {
            const futureMins = Math.floor(-diffMs / 60000);
            if (futureMins < 1) return 'in <1m';
            if (futureMins < 60) return `in ${futureMins}m`;
            const futureHrs = Math.floor(futureMins / 60);
            const remainMins = futureMins % 60;
            if (futureHrs < 24) return `in ${futureHrs}h ${remainMins}m`;
            const days = Math.floor(futureHrs / 24);
            return `in ${days}d ${futureHrs % 24}h`;
        }

        const diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        const diffHrs = Math.floor(diffMins / 60);
        if (diffHrs < 24) return `${diffHrs}h ago`;
        return d.toLocaleString();
    }

    function formatDuration(ms) {
        if (!ms) return '-';
        if (ms < 1000) return ms + 'ms';
        const secs = Math.floor(ms / 1000);
        if (secs < 60) return secs + 's';
        const mins = Math.floor(secs / 60);
        const remainSecs = secs % 60;
        if (mins < 60) return `${mins}m ${remainSecs}s`;
        const hrs = Math.floor(mins / 60);
        return `${hrs}h ${mins % 60}m`;
    }

    function statusBadge(status) {
        const cls = status === 'ok' ? 'active' : status === 'error' ? 'error' : 'completed';
        const label = status || 'pending';
        return `<span class="status-badge ${cls}">${label}</span>`;
    }

    // Load OpenClaw cron jobs (live from jobs.json)
    async function loadJobs() {
        try {
            const res = await fetch(`${API_BASE_URL}/jobs/live`);
            const data = await res.json();
            const jobs = data.jobs || [];
            const tbody = document.getElementById('jobs-body');
            
            // Update stats card
            const enabled = jobs.filter(j => j.enabled !== false);
            const lastOk = jobs.filter(j => j.last_status === 'ok').length;
            const lastErr = jobs.filter(j => j.last_status === 'error').length;
            document.getElementById('active-jobs').textContent = enabled.length;
            document.getElementById('jobs-summary').textContent = `${lastOk} ok, ${lastErr} errors, ${jobs.length} total`;
            
            if (jobs.length > 0) {
                tbody.innerHTML = jobs.map(j => `
                    <tr>
                        <td><strong>${j.name || '-'}</strong></td>
                        <td>${j.agent_id || 'main'}</td>
                        <td><code>${j.schedule_expr || '-'}</code></td>
                        <td>${statusBadge(j.last_status)}</td>
                        <td>${formatDate(j.last_run_at)}</td>
                        <td>${formatDate(j.next_run_at)}</td>
                        <td>${formatDuration(j.last_duration_ms)}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--text-muted);">No cron jobs found</td></tr>';
            }
        } catch (e) {
            console.error('Error loading jobs:', e);
            document.getElementById('jobs-body').innerHTML = `
                <tr><td colspan="7" style="text-align:center;padding:30px;color:var(--danger);">
                    Error loading jobs: ${e.message}
                </td></tr>`;
        }
    }

    // Load LiteLLM spend data for model stats + recent calls
    async function loadLitellmData() {
        try {
            // Global spend stats
            const globalRes = await fetch(`${API_BASE_URL}/litellm/global-spend`);
            const global = await globalRes.json();
            
            document.getElementById('model-requests').textContent = formatNumber(global.api_requests || 0);
            document.getElementById('model-tokens').textContent = `${formatNumber(global.total_tokens || 0)} tokens`;
            document.getElementById('total-cost').textContent = formatCost(global.spend || 0);
            document.getElementById('cost-breakdown').textContent = `${formatNumber(global.input_tokens || 0)} in / ${formatNumber(global.output_tokens || 0)} out`;
            
            // Spend logs for tables
            const logsRes = await fetch(`${API_BASE_URL}/litellm/spend?limit=50&lite=true`);
            const logs = await logsRes.json();
            
            if (Array.isArray(logs) && logs.length > 0) {
                // Aggregate by model for top models table
                const byModel = {};
                logs.forEach(log => {
                    const model = log.model || 'unknown';
                    if (!byModel[model]) {
                        byModel[model] = { requests: 0, input: 0, output: 0, total: 0, errors: 0 };
                    }
                    byModel[model].requests++;
                    byModel[model].input += log.prompt_tokens || 0;
                    byModel[model].output += log.completion_tokens || 0;
                    byModel[model].total += (log.prompt_tokens || 0) + (log.completion_tokens || 0) + (log.total_tokens || 0);
                    if (log.status === 'error') byModel[model].errors++;
                });
                
                const sorted = Object.entries(byModel).sort((a, b) => b[1].requests - a[1].requests);
                const modelsBody = document.getElementById('models-body');
                modelsBody.innerHTML = sorted.slice(0, 10).map(([model, stats]) => `
                    <tr>
                        <td><strong>${model}</strong></td>
                        <td>${stats.requests}</td>
                        <td>${formatNumber(stats.input)}</td>
                        <td>${formatNumber(stats.output)}</td>
                        <td>${formatNumber(stats.total)}</td>
                        <td>${stats.errors > 0 ? `<span class="status-badge error">${stats.errors} errors</span>` : '<span class="status-badge active">ok</span>'}</td>
                    </tr>
                `).join('');
                
                // Recent API calls table
                const logsBody = document.getElementById('logs-body');
                logsBody.innerHTML = logs.slice(0, 20).map(log => {
                    const tokens = (log.prompt_tokens || 0) + (log.completion_tokens || 0);
                    const cost = log.spend || 0;
                    const status = log.status === 'error' ? 'error' : 'active';
                    return `
                        <tr>
                            <td>${formatDate(log.startTime)}</td>
                            <td><code>${log.model || 'unknown'}</code></td>
                            <td>${formatNumber(tokens)}</td>
                            <td>${formatCost(cost)}</td>
                            <td><span class="status-badge ${status}">${log.status || 'success'}</span></td>
                        </tr>
                    `;
                }).join('');
            } else {
                document.getElementById('models-body').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text-muted);">No model usage data yet</td></tr>';
                document.getElementById('logs-body').innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-muted);">No API calls yet</td></tr>';
            }
        } catch (e) {
            console.error('Error loading LiteLLM data:', e);
            document.getElementById('model-requests').textContent = '?';
            document.getElementById('total-cost').textContent = '?';
        }
    }

    // Load service status for stats card
    async function loadServiceStatus() {
        try {
            const res = await fetch(`${API_BASE_URL}/status`);
            const data = await res.json();
            const online = Object.values(data).filter(s => s.status === 'up').length;
            const total = Object.keys(data).length;
            document.getElementById('services-up').textContent = `${online}/${total}`;
            document.getElementById('services-detail').textContent = online === total ? 'All systems online' : `${total - online} services down`;
        } catch (e) {
            document.getElementById('services-up').textContent = '?';
            document.getElementById('services-detail').textContent = 'Could not check';
        }
    }

    // Load all data
    loadJobs();
    loadLitellmData();
    loadServiceStatus();
    
    // Refresh every 30 seconds
    setInterval(() => {
        loadJobs();
        loadLitellmData();
        loadServiceStatus();
    }, 30000);
</script>
{% endblock %}
