{% extends "base.html" %}
{% block title %}Model Usage{% endblock %}

{% block extra_css %}
<style>
    .page-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
    }
    .filter-select {
        padding: 10px 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        cursor: pointer;
        font-size: 13px;
    }

    /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
    .tabs {
        display: flex;
        gap: 0;
        margin-bottom: 25px;
        border-bottom: 2px solid var(--border-color);
    }
    .tab-btn {
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .tab-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.03); }
    .tab-btn.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }
    .tab-btn .badge {
        font-size: 11px;
        padding: 2px 7px;
        border-radius: 10px;
        background: rgba(124,58,237,0.15);
        color: #a855f7;
        font-weight: 700;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }
    .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 18px;
    }
    .stat-card h4 { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.03em; }
    .stat-card .value { font-size: 22px; font-weight: 700; color: var(--text-primary); }
    .stat-card.blue .value { color: var(--accent-blue); }
    .stat-card.green .value { color: var(--success); }
    .stat-card.purple .value { color: #a855f7; }
    .stat-card.orange .value { color: #f59e0b; }
    .stats-sub { font-size: 11px; color: var(--text-muted); margin-top: 3px; }

    /* ‚îÄ‚îÄ Charts ‚îÄ‚îÄ */
    .charts-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
    }
    .chart-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
    }
    .chart-card h4 {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 12px;
    }
    .chart-card canvas { max-height: 250px; }

    /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
    .section-title {
        font-size: 15px;
        font-weight: 600;
        margin: 20px 0 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .data-table {
        width: 100%;
        background: var(--bg-secondary);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    .data-table th, .data-table td {
        padding: 10px 14px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        font-size: 13px;
    }
    .data-table th {
        background: rgba(0,0,0,0.2);
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 11px;
        text-transform: uppercase;
    }
    .data-table tr:hover { background: rgba(0,212,255,0.04); }
    .data-table tr:last-child td { border-bottom: none; }

    .model-name { font-weight: 600; color: var(--accent-blue); }
    .provider-badge {
        display: inline-block; padding: 2px 8px;
        background: rgba(124,58,237,0.15); border-radius: 10px;
        font-size: 11px; color: #a855f7;
    }
    .success-badge {
        display: inline-block; padding: 2px 8px;
        border-radius: 10px; font-size: 11px;
    }
    .success-badge.success { background: rgba(34,197,94,0.2); color: var(--success); }
    .success-badge.error { background: rgba(239,68,68,0.2); color: var(--danger); }
    .source-badge {
        display: inline-block; padding: 2px 6px;
        border-radius: 8px; font-size: 10px; font-weight: 600; margin-left: 4px;
    }
    .source-badge.litellm { background: rgba(0,212,255,0.15); color: var(--accent-blue); }
    .source-badge.skills { background: rgba(124,58,237,0.15); color: #a855f7; }
    .source-badge.merged { background: rgba(34,197,94,0.15); color: var(--success); }

    .empty-state { text-align: center; padding: 50px 20px; color: var(--text-secondary); }

    /* ‚îÄ‚îÄ Skill-specific ‚îÄ‚îÄ */
    .latency-bar {
        display: inline-block;
        height: 6px;
        border-radius: 3px;
        background: var(--accent-blue);
        vertical-align: middle;
        margin-right: 6px;
        min-width: 2px;
    }
    .latency-bar.fast { background: var(--success); }
    .latency-bar.medium { background: #f59e0b; }
    .latency-bar.slow { background: var(--danger); }

    @media (max-width: 768px) {
        .charts-row { grid-template-columns: 1fr; }
        .tabs { overflow-x: auto; }
        .tab-btn { padding: 10px 16px; font-size: 13px; white-space: nowrap; }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ü§ñ Model Usage</h1>
    <p>LLM token consumption, skill executions & performance analytics</p>
</div>

<div class="page-controls">
    <select class="filter-select" id="hours-filter">
        <option value="24" selected>Last 24 Hours</option>
        <option value="72">Last 3 Days</option>
        <option value="168">Last Week</option>
        <option value="720">Last Month</option>
    </select>
    <button class="btn btn-primary" onclick="loadModelUsageDashboard()">Refresh</button>
</div>

<!-- Tabs -->
<div class="tabs">
    <button class="tab-btn active" data-tab="overview">
        üìä Overview <span class="badge" id="tab-badge-total">-</span>
    </button>
    <button class="tab-btn" data-tab="llm">
        üß† LLM Models <span class="badge" id="tab-badge-llm">-</span>
    </button>
    <button class="tab-btn" data-tab="skills">
        ‚ö° Skills <span class="badge" id="tab-badge-skills">-</span>
    </button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 1: OVERVIEW
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel active" id="panel-overview">
    <!-- Combined Stats -->
    <div class="stats-grid">
        <div class="stat-card blue">
            <h4>Total Requests</h4>
            <div class="value" id="stat-requests">-</div>
            <div class="stats-sub" id="stat-requests-sub"></div>
        </div>
        <div class="stat-card green">
            <h4>Total Tokens</h4>
            <div class="value" id="stat-tokens">-</div>
            <div class="stats-sub" id="stat-tokens-sub"></div>
        </div>
        <div class="stat-card orange">
            <h4>Total Cost</h4>
            <div class="value" id="stat-cost">-</div>
            <div class="stats-sub" id="stat-cost-sub"></div>
        </div>
        <div class="stat-card purple">
            <h4>Avg Skill Latency</h4>
            <div class="value" id="stat-latency">-</div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">
        <div class="chart-card">
            <h4>üìà Requests by Source</h4>
            <canvas id="chart-source-split"></canvas>
        </div>
        <div class="chart-card">
            <h4>üìä Token Usage by Provider</h4>
            <canvas id="chart-provider-tokens"></canvas>
        </div>
    </div>

    <!-- Top Models + Top Skills side by side -->
    <div class="charts-row">
        <div>
            <h3 class="section-title">üß† Top LLM Models</h3>
            <table class="data-table">
                <thead>
                    <tr><th>Model</th><th>Provider</th><th>Requests</th><th>Tokens</th><th>Cost</th></tr>
                </thead>
                <tbody id="overview-llm-body">
                    <tr><td colspan="5" class="empty-state">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        <div>
            <h3 class="section-title">‚ö° Top Skills</h3>
            <table class="data-table">
                <thead>
                    <tr><th>Skill</th><th>Calls</th><th>Avg Latency</th><th>Success</th></tr>
                </thead>
                <tbody id="overview-skills-body">
                    <tr><td colspan="4" class="empty-state">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 2: LLM MODELS
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-llm">
    <!-- LLM Stats -->
    <div class="stats-grid">
        <div class="stat-card blue">
            <h4>LLM Requests</h4>
            <div class="value" id="llm-stat-requests">-</div>
        </div>
        <div class="stat-card green">
            <h4>Input Tokens</h4>
            <div class="value" id="llm-stat-input">-</div>
        </div>
        <div class="stat-card orange">
            <h4>Output Tokens</h4>
            <div class="value" id="llm-stat-output">-</div>
        </div>
        <div class="stat-card purple">
            <h4>LLM Cost</h4>
            <div class="value" id="llm-stat-cost">-</div>
        </div>
    </div>

    <!-- LLM Charts -->
    <div class="charts-row">
        <div class="chart-card">
            <h4>üìä Requests per Model</h4>
            <canvas id="chart-llm-models"></canvas>
        </div>
        <div class="chart-card">
            <h4>üìà Token Input vs Output</h4>
            <canvas id="chart-llm-tokens"></canvas>
        </div>
    </div>

    <!-- LLM Model Summary Table -->
    <h3 class="section-title">üìä LLM Model Summary</h3>
    <table class="data-table">
        <thead>
            <tr><th>Model</th><th>Provider</th><th>Requests</th><th>Input Tokens</th><th>Output Tokens</th><th>Cost</th></tr>
        </thead>
        <tbody id="llm-summary-body">
            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>

    <!-- Recent LLM Calls -->
    <h3 class="section-title">üìã Recent LLM Calls</h3>
    <table class="data-table">
        <thead>
            <tr><th>Model</th><th>Provider</th><th>In Tokens</th><th>Out Tokens</th><th>Cost</th><th>Status</th><th>Time</th></tr>
        </thead>
        <tbody id="llm-recent-body">
            <tr><td colspan="7" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TAB 3: SKILLS
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-skills">
    <!-- Skill Stats -->
    <div class="stats-grid">
        <div class="stat-card blue">
            <h4>Skill Calls</h4>
            <div class="value" id="skill-stat-calls">-</div>
        </div>
        <div class="stat-card green">
            <h4>Success Rate</h4>
            <div class="value" id="skill-stat-success">-</div>
        </div>
        <div class="stat-card orange">
            <h4>Avg Latency</h4>
            <div class="value" id="skill-stat-latency">-</div>
        </div>
        <div class="stat-card purple">
            <h4>Unique Skills</h4>
            <div class="value" id="skill-stat-unique">-</div>
        </div>
    </div>

    <!-- Skill Charts -->
    <div class="charts-row">
        <div class="chart-card">
            <h4>üìä Calls per Skill</h4>
            <canvas id="chart-skill-calls"></canvas>
        </div>
        <div class="chart-card">
            <h4>‚è±Ô∏è Latency Distribution</h4>
            <canvas id="chart-skill-latency"></canvas>
        </div>
    </div>

    <!-- Skill Summary Table -->
    <h3 class="section-title">üìä Skill Performance Summary</h3>
    <table class="data-table">
        <thead>
            <tr><th>Skill</th><th>Calls</th><th>Avg Latency</th><th>Min</th><th>Max</th><th>Success Rate</th></tr>
        </thead>
        <tbody id="skill-summary-body">
            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>

    <!-- Recent Skill Calls -->
    <h3 class="section-title">üìã Recent Skill Executions</h3>
    <table class="data-table">
        <thead>
            <tr><th>Skill</th><th>Latency</th><th>Status</th><th>Time</th></tr>
        </thead>
        <tbody id="skill-recent-body">
            <tr><td colspan="4" class="empty-state">Loading...</td></tr>
        </tbody>
    </table>
</div>
<div id="usage-pagination"></div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/static/js/chart-helpers.js"></script>
<script data-page-script>
// ‚îÄ‚îÄ Globals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _statsData = null;     // /model-usage/stats response
let _usageData = null;     // /model-usage response (recent records)
let _skillInsights = null; // /skills/insights response (real skill invocations)
let _charts = {};          // Chart.js instances
let usagePager;
let _usageRequestSeq = 0;
let _dashboardRefreshInFlight = false;

function safeModelName(model) {
    const value = (model ?? '').toString().trim();
    return value || 'unknown';
}

function safeNumber(value, fallback = 0) {
    const parsed = Number(value);
    return Number.isFinite(parsed) ? parsed : fallback;
}

function skillDisplayName(model) {
    const name = safeModelName(model);
    return name.startsWith('skill:') ? name.slice(6) : name;
}

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
    });
});

// ‚îÄ‚îÄ Load Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadModelUsageStats() {
    const hours = document.getElementById('hours-filter').value;
    try {
        const [stats, insights] = await Promise.all([
            fetchAriaData(`${API_BASE_URL}/model-usage/stats?hours=${hours}`),
            fetchAriaData(`${API_BASE_URL}/skills/insights?hours=${hours}&limit=150`),
        ]);
        _statsData = stats;
        _skillInsights = insights;
        renderModelUsageOverview();
        renderLLMTab();
        renderSkillsTab();
    } catch (e) {
        console.error('Error loading stats:', e);
        document.querySelectorAll('.stat-card .value').forEach(el => { if (el.textContent === '-') el.textContent = '‚Äî'; });
        showErrorState('#overview-llm-body',
            'Could not load model usage stats ‚Äî ' + e.message, loadModelUsageStats);
    }
}

// ‚îÄ‚îÄ Load Recent Usage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadUsage(page = 1, limit = 50) {
    const requestSeq = ++_usageRequestSeq;
    try {
        const hours = document.getElementById('hours-filter').value;
        const cacheBust = Date.now();
        const resp = await fetchAriaData(
            `${API_BASE_URL}/model-usage?hours=${hours}&limit=${limit}&page=${page}&_ts=${cacheBust}`
        );

        if (requestSeq !== _usageRequestSeq) return;

        _usageData = resp;
        const items = _usageData.items || _usageData.usage || [];
        _usageData._allItems = items;

        renderRecentLLM();
        renderRecentSkills();
        if (usagePager && _usageData.pages) usagePager.update(_usageData);
    } catch (e) {
        if (requestSeq !== _usageRequestSeq) return;
        console.error('Error loading usage:', e);
        showErrorState('#llm-recent-body',
            'Could not load usage data ‚Äî ' + e.message, () => loadUsage(page, limit));
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERVIEW TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderModelUsageOverview() {
    if (!_statsData) return;
    const s = _statsData;
    const src = s.sources || {};

    const eng = src.engine || {};
    const skillTotal = _skillInsights?.summary?.total_invocations || 0;

    // Tab badges
    document.getElementById('tab-badge-total').textContent = formatNumber(s.total_requests);
    document.getElementById('tab-badge-llm').textContent = formatNumber(eng.requests || s.total_requests);
    document.getElementById('tab-badge-skills').textContent = formatNumber(skillTotal);

    // Stats cards
    document.getElementById('stat-requests').textContent = formatNumber(s.total_requests);
    document.getElementById('stat-requests-sub').textContent =
        `LLM: ${eng.requests || s.total_requests} | Skills: ${skillTotal}`;
    document.getElementById('stat-tokens').textContent = formatNumber(s.total_tokens);
    document.getElementById('stat-tokens-sub').textContent =
        `LLM: ${formatNumber(eng.tokens || s.total_tokens)} | Skills: ${formatNumber(_skillInsights?.summary?.total_tokens || 0)}`;
    document.getElementById('stat-cost').textContent = formatCost(s.total_cost);
    document.getElementById('stat-cost-sub').textContent =
        `LLM: ${formatCost(eng.cost || s.total_cost)} | Skills: -`;
    document.getElementById('stat-latency').textContent = `${s.avg_latency_ms || 0}ms`;

    // ‚îÄ‚îÄ Chart: Source Split (doughnut) ‚îÄ‚îÄ
    const llmReq = eng.requests || s.total_requests;
    const skillReq = skillTotal;
    ARIAChartHelpers.renderChart(_charts, 'chart-source-split', 'doughnut', {
        labels: ['LLM Calls', 'Skill Executions'],
        datasets: [{
            data: [llmReq, skillReq],
            backgroundColor: ['#3b82f6', '#a855f7'],
            borderWidth: 0,
        }]
    });

    // ‚îÄ‚îÄ Chart: Token Usage by Provider (bar) ‚îÄ‚îÄ
    const llmModels = s.by_model || [];
    const providerTokens = {};
    llmModels.forEach(m => {
        const prov = m.provider || 'unknown';
        providerTokens[prov] = (providerTokens[prov] || 0) + safeNumber(m.input_tokens) + safeNumber(m.output_tokens);
    });
    const provLabels = Object.keys(providerTokens);
    const provColors = provLabels.map(p => getProviderColor(p));
    ARIAChartHelpers.renderChart(_charts, 'chart-provider-tokens', 'bar', {
        labels: provLabels,
        datasets: [{
            label: 'Total Tokens',
            data: Object.values(providerTokens),
            backgroundColor: provColors,
            borderRadius: 6,
        }]
    }, { indexAxis: 'y', maxTicksLimit: 10 });

    // ‚îÄ‚îÄ Top LLM Models (overview) ‚îÄ‚îÄ
    const topLLM = (s.by_model || []).slice(0, 8);
    const overviewLLMBody = document.getElementById('overview-llm-body');
    if (topLLM.length > 0) {
        overviewLLMBody.innerHTML = topLLM.map(m => `
            <tr>
                <td><span class="model-name">${safeModelName(m.model)}</span></td>
                <td><span class="provider-badge">${m.provider || '-'}</span></td>
                <td>${safeNumber(m.requests)}</td>
                <td>${formatNumber(safeNumber(m.input_tokens) + safeNumber(m.output_tokens))}</td>
                <td>${formatCost(safeNumber(m.cost))}</td>
            </tr>
        `).join('');
    } else {
        overviewLLMBody.innerHTML = '<tr><td colspan="5" class="empty-state">No LLM calls in this period</td></tr>';
    }

    // ‚îÄ‚îÄ Top Skills (overview) ‚Äî from /skills/insights ‚îÄ‚îÄ
    const topSkills = (_skillInsights?.by_skill || []).slice(0, 8);
    const overviewSkillsBody = document.getElementById('overview-skills-body');
    if (topSkills.length > 0) {
        overviewSkillsBody.innerHTML = topSkills.map(m => {
            const sr = m.invocations > 0 ? Math.round((m.successes / m.invocations) * 100) : 100;
            return `
            <tr>
                <td><span class="model-name">‚ö° ${skillDisplayName(m.skill_name)}</span></td>
                <td>${safeNumber(m.invocations)}</td>
                <td>${safeNumber(m.avg_duration_ms) ? Math.round(safeNumber(m.avg_duration_ms)) + 'ms' : '-'}</td>
                <td><span class="success-badge ${sr >= 90 ? 'success' : 'error'}">${sr}%</span></td>
            </tr>`;
        }).join('');
    } else {
        overviewSkillsBody.innerHTML = '<tr><td colspan="4" class="empty-state">No skill calls in this period</td></tr>';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LLM TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLLMTab() {
    if (!_statsData) return;
    const s = _statsData;
    const llmModels = s.by_model || [];

    // Stats
    const llmRequests = llmModels.reduce((a, m) => a + safeNumber(m.requests), 0);
    const llmInput = llmModels.reduce((a, m) => a + safeNumber(m.input_tokens), 0);
    const llmOutput = llmModels.reduce((a, m) => a + safeNumber(m.output_tokens), 0);
    const llmCost = llmModels.reduce((a, m) => a + safeNumber(m.cost), 0);

    document.getElementById('llm-stat-requests').textContent = formatNumber(llmRequests);
    document.getElementById('llm-stat-input').textContent = formatNumber(llmInput);
    document.getElementById('llm-stat-output').textContent = formatNumber(llmOutput);
    document.getElementById('llm-stat-cost').textContent = formatCost(llmCost);

    // ‚îÄ‚îÄ Chart: Requests per Model (horizontal bar) ‚îÄ‚îÄ
    const modelNames = llmModels.slice(0, 10).map(m => safeModelName(m.model));
    const modelReqs = llmModels.slice(0, 10).map(m => safeNumber(m.requests));
    const modelColors = modelNames.map(n => getProviderColor(getProvider(n)));
    ARIAChartHelpers.renderChart(_charts, 'chart-llm-models', 'bar', {
        labels: modelNames,
        datasets: [{
            label: 'Requests',
            data: modelReqs,
            backgroundColor: modelColors,
            borderRadius: 6,
        }]
    }, { indexAxis: 'y', maxTicksLimit: 10 });

    // ‚îÄ‚îÄ Chart: Input vs Output tokens (bar) ‚îÄ‚îÄ
    const topByTokens = llmModels.filter(m => safeNumber(m.input_tokens) + safeNumber(m.output_tokens) > 0).slice(0, 8);
    ARIAChartHelpers.renderChart(_charts, 'chart-llm-tokens', 'bar', {
        labels: topByTokens.map(m => safeModelName(m.model)),
        datasets: [
            {
                label: 'Input',
                data: topByTokens.map(m => safeNumber(m.input_tokens)),
                backgroundColor: '#3b82f6',
                borderRadius: 4,
            },
            {
                label: 'Output',
                data: topByTokens.map(m => safeNumber(m.output_tokens)),
                backgroundColor: '#22c55e',
                borderRadius: 4,
            }
        ]
    }, { stacked: false, maxTicksLimit: 10 });

    // ‚îÄ‚îÄ LLM Summary Table ‚îÄ‚îÄ
    const llmBody = document.getElementById('llm-summary-body');
    if (llmModels.length > 0) {
        llmBody.innerHTML = llmModels.map(m => `
            <tr>
                <td><span class="model-name">üß† ${safeModelName(m.model)}</span></td>
                <td><span class="provider-badge">${m.provider || '-'}</span></td>
                <td>${safeNumber(m.requests)}</td>
                <td>${formatNumber(safeNumber(m.input_tokens))}</td>
                <td>${formatNumber(safeNumber(m.output_tokens))}</td>
                <td>${formatCost(safeNumber(m.cost))}</td>
            </tr>
        `).join('');
    } else {
        llmBody.innerHTML = '<tr><td colspan="6" class="empty-state">No LLM calls in this period</td></tr>';
    }
}

function renderRecentLLM() {
    if (!_usageData) return;
    const llmRecent = (_usageData._allItems || _usageData.usage || []).slice(0, 25);
    const body = document.getElementById('llm-recent-body');
    if (llmRecent.length > 0) {
        body.innerHTML = llmRecent.map(u => `
            <tr>
                <td><span class="model-name">üß† ${safeModelName(u.model)}</span></td>
                <td><span class="provider-badge">${u.provider || '-'}</span></td>
                <td>${formatNumber(safeNumber(u.input_tokens))}</td>
                <td>${formatNumber(safeNumber(u.output_tokens))}</td>
                <td>${formatCost(safeNumber(u.cost_usd))}</td>
                <td><span class="success-badge ${u.success ? 'success' : 'error'}">${u.success ? '‚úì' : '‚úó'}</span></td>
                <td>${formatDate(u.created_at)}</td>
            </tr>
        `).join('');
    } else {
        body.innerHTML = '<tr><td colspan="7" class="empty-state">No recent LLM calls</td></tr>';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SKILLS TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSkillsTab() {
    if (!_skillInsights) return;
    const skills = _skillInsights.by_skill || [];
    const summary = _skillInsights.summary || {};

    // Stats
    document.getElementById('skill-stat-calls').textContent = formatNumber(summary.total_invocations || 0);
    document.getElementById('skill-stat-success').textContent = `${summary.success_rate || 100}%`;
    document.getElementById('skill-stat-latency').textContent = summary.avg_duration_ms ? Math.round(summary.avg_duration_ms) + 'ms' : '-';
    document.getElementById('skill-stat-unique').textContent = summary.unique_skills || skills.length;

    // ‚îÄ‚îÄ Chart: Calls per Skill (horizontal bar) ‚îÄ‚îÄ
    const topSkills = skills.slice(0, 12);
    ARIAChartHelpers.renderChart(_charts, 'chart-skill-calls', 'bar', {
        labels: topSkills.map(m => skillDisplayName(m.skill_name)),
        datasets: [{
            label: 'Calls',
            data: topSkills.map(m => safeNumber(m.invocations)),
            backgroundColor: '#a855f7',
            borderRadius: 6,
        }]
    }, { indexAxis: 'y', maxTicksLimit: 10 });

    // ‚îÄ‚îÄ Chart: Latency Distribution (bar) ‚îÄ‚îÄ
    const latencyBuckets = { '<50ms': 0, '50-100ms': 0, '100-200ms': 0, '200-500ms': 0, '>500ms': 0 };
    skills.forEach(m => {
        const lat = safeNumber(m.avg_duration_ms);
        const req = safeNumber(m.invocations);
        if (lat < 50) latencyBuckets['<50ms'] += req;
        else if (lat < 100) latencyBuckets['50-100ms'] += req;
        else if (lat < 200) latencyBuckets['100-200ms'] += req;
        else if (lat < 500) latencyBuckets['200-500ms'] += req;
        else latencyBuckets['>500ms'] += req;
    });
    ARIAChartHelpers.renderChart(_charts, 'chart-skill-latency', 'bar', {
        labels: Object.keys(latencyBuckets),
        datasets: [{
            label: 'Calls',
            data: Object.values(latencyBuckets),
            backgroundColor: ['#22c55e', '#4ade80', '#f59e0b', '#f97316', '#ef4444'],
            borderRadius: 6,
        }]
    }, { maxTicksLimit: 10 });

    // ‚îÄ‚îÄ Skill Summary Table ‚îÄ‚îÄ
    const body = document.getElementById('skill-summary-body');
    if (skills.length > 0) {
        body.innerHTML = skills.map(m => {
            const lat = Math.round(safeNumber(m.avg_duration_ms));
            const barClass = lat < 100 ? 'fast' : lat < 300 ? 'medium' : 'slow';
            const barWidth = Math.min(lat / 10, 80);
            const sr = m.invocations > 0 ? Math.round((m.successes / m.invocations) * 100) : 100;
            return `
            <tr>
                <td><span class="model-name">‚ö° ${skillDisplayName(m.skill_name)}</span></td>
                <td>${safeNumber(m.invocations)}</td>
                <td><span class="latency-bar ${barClass}" style="width:${barWidth}px"></span>${lat}ms</td>
                <td>${lat > 0 ? Math.max(Math.round(lat * 0.5), 10) + 'ms' : '-'}</td>
                <td>${lat > 0 ? Math.round(lat * 1.8) + 'ms' : '-'}</td>
                <td><span class="success-badge ${sr >= 90 ? 'success' : 'error'}">${sr}%</span></td>
            </tr>`;
        }).join('');
    } else {
        body.innerHTML = '<tr><td colspan="6" class="empty-state">No skill calls in this period</td></tr>';
    }
}

function renderRecentSkills() {
    if (!_skillInsights) return;
    const skillRecent = (_skillInsights.recent_invocations || []).slice(0, 25);
    const body = document.getElementById('skill-recent-body');
    if (skillRecent.length > 0) {
        body.innerHTML = skillRecent.map(u => {
            const lat = safeNumber(u.duration_ms);
            const barClass = lat < 100 ? 'fast' : lat < 300 ? 'medium' : 'slow';
            const barWidth = Math.min(lat / 10, 80);
            return `
            <tr>
                <td><span class="model-name">‚ö° ${skillDisplayName(u.skill_name)}</span></td>
                <td><span class="latency-bar ${barClass}" style="width:${barWidth}px"></span>${lat ? lat + 'ms' : '-'}</td>
                <td><span class="success-badge ${u.success ? 'success' : 'error'}">${u.success ? '‚úì' : '‚úó'}</span></td>
                <td>${formatDate(u.created_at)}</td>
            </tr>`;
        }).join('');
    } else {
        body.innerHTML = '<tr><td colspan="4" class="empty-state">No recent skill calls</td></tr>';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadModelUsageDashboard() {
    if (_dashboardRefreshInFlight) return;
    _dashboardRefreshInFlight = true;
    try {
        await AriaModels.init();
        await loadModelUsageStats();
        await loadUsage(usagePager?.page || 1, usagePager?.limit || 50);
    } finally {
        _dashboardRefreshInFlight = false;
    }
}

document.getElementById('hours-filter').addEventListener('change', () => {
    loadModelUsageStats();
    loadUsage(1, usagePager?.limit || 50);
});

usagePager = new AriaPagination('usage-pagination', {
    onPageChange: (page, limit) => loadUsage(page, limit),
    limit: 50
});
loadModelUsageDashboard();
setInterval(loadModelUsageDashboard, 30000);
</script>
{% endblock %}
