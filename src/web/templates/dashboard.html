{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .chart-card {
        background: var(--bg-secondary);
        border-radius: 16px;
        padding: 25px;
        border: 1px solid var(--border-color);
    }
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .chart-title {
        font-size: 18px;
        font-weight: 600;
    }
    .chart-container {
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
    }
    .metrics-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    .metric-card {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border-color);
        text-align: center;
    }
    .metric-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--accent-blue);
    }
    .metric-label {
        color: var(--text-secondary);
        font-size: 14px;
        margin-top: 5px;
    }
    .metric-trend {
        font-size: 12px;
        margin-top: 8px;
    }
    .metric-trend.up { color: var(--success); }
    .metric-trend.down { color: var(--danger); }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ðŸ“Š Dashboard</h1>
    <p>Real-time overview of Aria's activities and system metrics</p>
</div>

<div class="metrics-row">
    <div class="metric-card">
        <div class="metric-value" id="m-activities">-</div>
        <div class="metric-label">Total Activities</div>
        <div class="metric-trend up">âœ… Active</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="m-thoughts">-</div>
        <div class="metric-label">Total Thoughts</div>
        <div class="metric-trend up">âœ… Growing</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="m-services">-</div>
        <div class="metric-label">Services Online</div>
        <div class="metric-trend" id="m-services-trend">Checking...</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="m-uptime">-</div>
        <div class="metric-label">System Status</div>
        <div class="metric-trend up">Operational</div>
    </div>
</div>

<div class="dashboard-grid">
    <div class="chart-card">
        <div class="chart-header">
            <span class="chart-title">âš¡ Activity Timeline</span>
            <select class="chart-filter">
                <option>Last 24h</option>
                <option>Last 7d</option>
                <option>Last 30d</option>
            </select>
        </div>
        <div class="chart-container" id="activity-chart">
            <canvas id="activity-timeline-canvas"></canvas>
        </div>
    </div>
    
    <div class="chart-card">
        <div class="chart-header">
            <span class="chart-title">ðŸ’­ Thoughts by Type</span>
        </div>
        <div class="chart-container" id="thoughts-chart">
            <canvas id="thoughts-by-type-canvas"></canvas>
        </div>
    </div>
    
    <div class="chart-card">
        <div class="chart-header">
            <span class="chart-title">ðŸŸ¢ Service Health</span>
        </div>
        <div class="chart-container" id="services-chart">
            <div class="services-health-grid" id="services-health"></div>
        </div>
    </div>
    
    <div class="chart-card">
        <div class="chart-header">
            <span class="chart-title">ðŸ“„ Recent Activity</span>
            <a href="/activities" class="btn-link">View All â†’</a>
        </div>
        <div class="chart-container" id="recent-activity" style="height: auto; max-height: 300px; overflow-y: auto;">
            <p>Loading...</p>
        </div>
    </div>
</div>

<div class="embed-section">
    <h2 class="section-title">Grafana Dashboards</h2>
    <p>For detailed metrics, visit <a href="/grafana/" target="_blank">Grafana â†’</a></p>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script data-page-script>
    const API_BASE = window.ARIA_API_BASE_URL || '/api';

    let activityChart = null;
    let thoughtsChart = null;
    // Load stats
    fetch(`${API_BASE}/stats`)
        .then(r => r.json())
        .then(data => {
            document.getElementById('m-activities').textContent = data.activities_count || 0;
            document.getElementById('m-thoughts').textContent = data.thoughts_count || 0;
            document.getElementById('m-uptime').textContent = 'Online';
        })
        .catch(() => {
            document.getElementById('m-uptime').textContent = 'Error';
        });

    // Load service status
    fetch(`${API_BASE}/status`)
        .then(r => r.json())
        .then(data => {
            const online = Object.values(data).filter(s => s.status === 'up').length;
            const total = Object.keys(data).length;
            document.getElementById('m-services').textContent = `${online}/${total}`;
            document.getElementById('m-services-trend').textContent = online === total ? 'âœ… All Online' : `${total - online} Down`;
            document.getElementById('m-services-trend').className = 'metric-trend ' + (online === total ? 'up' : 'down');
            
            // Build health grid
            let html = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:100%">';
            for (const [name, info] of Object.entries(data)) {
                html += `<div style="padding:10px;background:${info.status === 'up' ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)'};border-radius:8px;text-align:center">
                    <div style="font-weight:600">${name}</div>
                    <div style="font-size:12px;color:${info.status === 'up' ? 'var(--success)' : 'var(--danger)'}">${info.status}</div>
                </div>`;
            }
            html += '</div>';
            document.getElementById('services-health').innerHTML = html;
        })
        .catch(() => {});

    // Load recent activities
    fetch(`${API_BASE}/activities`)
        .then(r => r.json())
        .then(data => {
            if (data.length === 0) {
                document.getElementById('recent-activity').innerHTML = '<p>No activities yet</p>';
                return;
            }
            let html = '<div style="width:100%">';
            data.slice(0, 10).forEach(a => {
                const d = new Date(a.created_at);
                html += `<div style="padding:10px;border-bottom:1px solid var(--border-color)">
                    <div style="font-weight:500">${a.type || 'Activity'}</div>
                    <div style="font-size:13px;color:var(--text-secondary)">${a.description || '-'}</div>
                    <div style="font-size:11px;color:var(--text-muted)">${d.toLocaleString()}</div>
                </div>`;
            });
            html += '</div>';
            document.getElementById('recent-activity').innerHTML = html;
        })
        .catch(e => {
            document.getElementById('recent-activity').innerHTML = '<p>Could not load activities</p>';
        });

    // Activity timeline chart
    fetch(`${API_BASE}/activities?limit=500`)
        .then(r => r.json())
        .then(data => {
            const now = new Date();
            const dayBuckets = {};
            for (let i = 6; i >= 0; i--) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const key = d.toISOString().split('T')[0];
                dayBuckets[key] = 0;
            }

            if (Array.isArray(data)) {
                data.forEach(a => {
                    if (!a.created_at) return;
                    const key = new Date(a.created_at).toISOString().split('T')[0];
                    if (dayBuckets[key] !== undefined) dayBuckets[key] += 1;
                });
            }

            const labels = Object.keys(dayBuckets).map(d =>
                new Date(d).toLocaleDateString('en-US', { weekday: 'short' })
            );
            const values = Object.values(dayBuckets);

            const ctx = document.getElementById('activity-timeline-canvas').getContext('2d');
            if (activityChart) activityChart.destroy();
            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Activities',
                        data: values,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#9ca3af' } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#9ca3af' } }
                    }
                }
            });
        })
        .catch(() => {
            document.getElementById('activity-chart').innerHTML = '<p>Could not load activity timeline</p>';
        });

    // Thoughts by type chart
    fetch(`${API_BASE}/thoughts?limit=500`)
        .then(r => r.json())
        .then(data => {
            const thoughts = data?.thoughts || [];
            const counts = {};
            thoughts.forEach(t => {
                const key = t.category || 'uncategorized';
                counts[key] = (counts[key] || 0) + 1;
            });

            const labels = Object.keys(counts);
            const values = Object.values(counts);

            if (labels.length === 0) {
                document.getElementById('thoughts-chart').innerHTML = '<p>No thoughts data</p>';
                return;
            }

            const ctx = document.getElementById('thoughts-by-type-canvas').getContext('2d');
            if (thoughtsChart) thoughtsChart.destroy();
            thoughtsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#8b5cf6', '#22c55e', '#f59e0b', '#3b82f6', '#ef4444', '#a855f7', '#14b8a6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#9ca3af', font: { size: 12 } } }
                    }
                }
            });
        })
        .catch(() => {
            document.getElementById('thoughts-chart').innerHTML = '<p>Could not load thoughts</p>';
        });
</script>
{% endblock %}
