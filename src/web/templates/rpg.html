{% extends "base.html" %}
{% block title %}RPG Dashboard - Aria Blue{% endblock %}

{% block extra_css %}
<style>
/* ‚îÄ‚îÄ RPG Page-specific styles ‚îÄ‚îÄ */
.rpg-toolbar {
    display: flex; align-items: center; gap: var(--space-md);
    flex-wrap: wrap; margin-bottom: var(--space-lg);
}
.rpg-toolbar label { font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); }
.rpg-toolbar select {
    padding: var(--space-sm) var(--space-md); background: var(--bg-tertiary);
    border: 1px solid var(--border-default); border-radius: var(--radius-md);
    color: var(--text-primary); font-size: 0.875rem; font-family: var(--font-sans);
    cursor: pointer; transition: all 0.2s; min-width: 220px;
}
.rpg-toolbar select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
.rpg-toolbar .toolbar-status { margin-left: auto; font-size: 0.8rem; color: var(--text-muted); }

.rpg-tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border-subtle); margin-bottom: var(--space-lg); }
.rpg-tab {
    display: flex; align-items: center; gap: var(--space-sm); background: none; border: none;
    color: var(--text-secondary); padding: var(--space-sm) var(--space-lg);
    font-size: 0.875rem; font-weight: 500; font-family: var(--font-sans);
    cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s;
}
.rpg-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
.rpg-tab.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }

.rpg-panel { display: none; }
.rpg-panel.active { display: block; }

.rpg-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-lg); margin-bottom: var(--space-xl); }
@media (max-width: 768px) { .rpg-stats { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 480px) { .rpg-stats { grid-template-columns: 1fr; } }

.rpg-card table th {
    color: var(--text-muted); font-weight: 500; text-transform: uppercase;
    font-size: 0.75rem; letter-spacing: 0.05em; padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border-subtle);
}
.rpg-card table td { padding: var(--space-sm) var(--space-md); border-bottom: 1px solid var(--border-subtle); font-size: 0.875rem; }
.rpg-card table tr:hover td { background: var(--bg-hover); }

#kg-container {
    width: 100%; height: calc(100vh - 340px); min-height: 400px;
    border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); background: var(--bg-secondary);
}
.kg-legend { display: flex; flex-wrap: wrap; gap: var(--space-md); margin-top: var(--space-md); }
.kg-legend-item { display: flex; align-items: center; gap: var(--space-xs); font-size: 0.8rem; color: var(--text-muted); }
.kg-legend-dot { width: 12px; height: 12px; border-radius: 50%; }

.msg { padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); margin-bottom: var(--space-sm); }
.msg-user { background: rgba(99, 102, 241, 0.08); border-left: 3px solid var(--accent-primary); }
.msg-assistant { background: rgba(16, 185, 129, 0.08); border-left: 3px solid var(--success); }
.msg-role { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
.msg-content { white-space: pre-wrap; line-height: 1.6; font-size: 0.9rem; color: var(--text-primary); }
.msg-time { font-size: 0.7rem; color: var(--text-dim); margin-top: 4px; }

.resume-btn {
    background: var(--accent-gradient); color: white; border: none;
    padding: var(--space-md) var(--space-xl); border-radius: var(--radius-md);
    font-size: 1rem; font-weight: 600; font-family: var(--font-sans);
    cursor: pointer; transition: all 0.15s; display: inline-flex;
    align-items: center; gap: var(--space-sm); box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
}
.resume-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4); }
.resume-btn:active { transform: scale(0.98); }
.resume-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.rpg-badge { display: inline-block; padding: 2px 10px; border-radius: var(--radius-full); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
.rpg-badge-active { background: rgba(99, 102, 241, 0.15); color: var(--accent-primary); }
.rpg-badge-type { background: var(--bg-tertiary); color: var(--text-muted); }

.rpg-loading { text-align: center; padding: 40px; color: var(--text-muted); }
.rpg-loading::after {
    content: ''; display: inline-block; width: 18px; height: 18px;
    border: 2px solid var(--border-default); border-top-color: var(--accent-primary);
    border-radius: 50%; animation: rpg-spin 0.8s linear infinite; margin-left: 8px; vertical-align: middle;
}
@keyframes rpg-spin { to { transform: rotate(360deg); } }
.rpg-error { color: var(--danger); padding: var(--space-lg); background: rgba(239, 68, 68, 0.08); border-radius: var(--radius-md); border: 1px solid rgba(239, 68, 68, 0.15); }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
.modal-overlay.visible { display: flex; }
.modal-box {
    background: var(--bg-elevated); border: 1px solid var(--border-default);
    border-radius: var(--radius-lg); padding: var(--space-xl); max-width: 520px; width: 90%;
    max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}
.modal-box h2 { margin-bottom: var(--space-md); background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.modal-close { float: right; background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; transition: color 0.15s; }
.modal-close:hover { color: var(--text-primary); }

.session-select-row { margin-bottom: var(--space-lg); }
.session-select-row select {
    padding: var(--space-sm) var(--space-md); background: var(--bg-tertiary);
    border: 1px solid var(--border-default); border-radius: var(--radius-md);
    color: var(--text-primary); font-size: 0.875rem; font-family: var(--font-sans); cursor: pointer; min-width: 280px;
}
.session-select-row select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üîÆ RPG Dashboard</h1>
    <p>Campaign management, knowledge graph visualization, and session transcripts</p>
</div>

<div class="rpg-toolbar">
    <label for="campaignSelect">Campaign</label>
    <select id="campaignSelect"><option value="">Loading campaigns...</option></select>
    <div class="toolbar-status" id="headerStatus">Connecting...</div>
</div>

<nav class="rpg-tabs">
    <button class="rpg-tab active" data-tab="overview">üìä Overview</button>
    <button class="rpg-tab" data-tab="kg">üï∏Ô∏è Knowledge Graph</button>
    <button class="rpg-tab" data-tab="transcript">üìú Transcript</button>
    <button class="rpg-tab" data-tab="resume">‚öîÔ∏è Resume</button>
</nav>

<section id="panel-overview" class="rpg-panel active">
    <div class="rpg-stats" id="campaignStats">
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-info">
                <div class="stat-value" id="statParty">&mdash;</div>
                <div class="stat-label">Party Members</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üé≠</div>
            <div class="stat-info">
                <div class="stat-value" id="statSessions">&mdash;</div>
                <div class="stat-label">Sessions</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üï∏Ô∏è</div>
            <div class="stat-info">
                <div class="stat-value" id="statEntities">&mdash;</div>
                <div class="stat-label">KG Entities</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚ö°</div>
            <div class="stat-info">
                <div class="stat-value" id="statStatus">&mdash;</div>
                <div class="stat-label">Status</div>
            </div>
        </div>
    </div>

    <div class="card rpg-card">
        <div class="card-header"><div class="card-title">Campaign Details</div></div>
        <div id="campaignInfo"><div class="rpg-loading">Select a campaign</div></div>
    </div>

    <div class="card rpg-card" style="margin-top: var(--space-lg);">
        <div class="card-header"><div class="card-title">Party Roster</div></div>
        <div id="partyRoster"><div class="rpg-loading">Select a campaign</div></div>
    </div>
</section>

<section id="panel-kg" class="rpg-panel">
    <div id="kg-container"></div>
    <div class="kg-legend" id="kgLegend"></div>
</section>

<section id="panel-transcript" class="rpg-panel">
    <div class="card rpg-card">
        <div class="card-header"><div class="card-title">Session Transcript</div></div>
        <div class="session-select-row">
            <select id="sessionSelect"><option value="">Select a session...</option></select>
        </div>
        <div id="transcriptContent"><div class="rpg-loading">Select a session to view</div></div>
    </div>
</section>

<section id="panel-resume" class="rpg-panel">
    <div class="card rpg-card" style="text-align: center; padding: var(--space-2xl);">
        <h3 style="font-size: 1.5rem; margin-bottom: var(--space-md);">‚öîÔ∏è Resume Campaign</h3>
        <p style="color: var(--text-secondary); margin-bottom: var(--space-lg); max-width: 500px; margin-left: auto; margin-right: auto;">
            Pick up where you left off. Aria will generate a recap and restore your combat state.
        </p>
        <button class="resume-btn" id="resumeBtn" onclick="resumeCampaign()">üé≤ Resume Session</button>
        <div id="resumeStatus" style="margin-top: var(--space-lg);"></div>
    </div>
    <div class="card rpg-card" id="combatStateCard" style="display:none; margin-top: var(--space-lg);">
        <div class="card-header"><div class="card-title">‚öîÔ∏è Combat State</div></div>
        <div id="combatState"></div>
    </div>
    <div class="card rpg-card" id="previouslyOnCard" style="display:none; margin-top: var(--space-lg);">
        <div class="card-header"><div class="card-title">üìú Previously On&hellip;</div></div>
        <div id="previouslyOn"></div>
    </div>
</section>

<!-- Entity Modal -->
<div class="modal-overlay" id="entityModal">
    <div class="modal-box">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <h2 id="modalTitle">Entity</h2>
        <div id="modalContent"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/vis-network@9.1.6/standalone/umd/vis-network.min.js"></script>
<script>
/* Aria RPG Dashboard ‚Äî AA+ compliant: ZERO hardcoded IPs/ports/URLs */
var API_BASE = window.location.origin + '/api';
var currentCampaign = null;
var kgNetwork = null;
var kgData = null;

function $(sel) { return document.querySelector(sel); }
function $$(sel) { return document.querySelectorAll(sel); }

async function apiFetch(path) {
    var resp = await fetch(API_BASE + path);
    if (!resp.ok) { var txt = await resp.text(); throw new Error('API ' + resp.status + ': ' + txt.slice(0, 200)); }
    return resp.json();
}

function timeAgo(ts) {
    if (!ts) return '\u2014';
    var d = new Date(ts), now = new Date(), diff = Math.floor((now - d) / 1000);
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
}

function esc(s) { if (!s) return ''; var d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; }

/* Tab Navigation */
$$('.rpg-tab').forEach(function(btn) {
    btn.addEventListener('click', function() {
        $$('.rpg-tab').forEach(function(b) { b.classList.remove('active'); });
        $$('.rpg-panel').forEach(function(p) { p.classList.remove('active'); });
        btn.classList.add('active');
        var panel = $('#panel-' + btn.dataset.tab);
        if (panel) panel.classList.add('active');
        if (btn.dataset.tab === 'kg' && currentCampaign && !kgData) loadKG(currentCampaign.id);
    });
});

/* Campaign Loading */
async function loadCampaigns() {
    try {
        var campaigns = await apiFetch('/rpg/campaigns');
        var sel = $('#campaignSelect');
        sel.innerHTML = '<option value="">\u2014 Select Campaign \u2014</option>';
        campaigns.forEach(function(c) {
            var opt = document.createElement('option');
            opt.value = c.id; opt.textContent = c.title + ' (' + c.status + ')';
            sel.appendChild(opt);
        });
        if (campaigns.length > 0) { sel.value = campaigns[0].id; await selectCampaign(campaigns[0].id); }
        $('#headerStatus').textContent = campaigns.length + ' campaign(s)';
    } catch(err) {
        $('#headerStatus').textContent = '\u26A0 API Error';
        console.error('Failed to load campaigns:', err);
    }
}

$('#campaignSelect').addEventListener('change', function(e) { if (e.target.value) selectCampaign(e.target.value); });

async function selectCampaign(campaignId) {
    try {
        var detail = await apiFetch('/rpg/campaign/' + campaignId);
        currentCampaign = detail; kgData = null;
        $('#statParty').textContent = (detail.party || []).length;
        $('#statSessions').textContent = (detail.sessions ? detail.sessions.length : 0);
        $('#statEntities').textContent = detail.kg_entity_count || '\u2014';
        $('#statStatus').textContent = detail.status;

        $('#campaignInfo').innerHTML =
            '<table>' +
            '<tr><th>Title</th><td>' + esc(detail.title) + '</td></tr>' +
            '<tr><th>Setting</th><td>' + esc(detail.setting) + '</td></tr>' +
            '<tr><th>Status</th><td><span class="rpg-badge rpg-badge-active">' + esc(detail.status) + '</span></td></tr>' +
            '<tr><th>Description</th><td>' + (esc(detail.description) || '<em style="color:var(--text-dim)">No description</em>') + '</td></tr>' +
            '</table>';

        var party = detail.party || [];
        if (party.length > 0) {
            var rows = party.map(function(p) {
                var name = typeof p === 'string' ? p : (p.name || p.character_id || JSON.stringify(p));
                var cls = typeof p === 'object' ? (p.class || p.ancestry || '') : '';
                var level = typeof p === 'object' ? (p.level || '') : '';
                return '<tr><td>' + esc(name) + '</td><td>' + esc(cls) + '</td><td>' + esc(level) + '</td></tr>';
            }).join('');
            $('#partyRoster').innerHTML = '<table><thead><tr><th>Name</th><th>Class</th><th>Level</th></tr></thead><tbody>' + rows + '</tbody></table>';
        } else {
            $('#partyRoster').innerHTML = '<div style="color:var(--text-muted);padding:var(--space-md)">No party members found</div>';
        }

        populateSessionSelector(detail);
        if ($('.rpg-tab[data-tab="kg"]').classList.contains('active')) loadKG(campaignId);
    } catch(err) {
        console.error('Campaign load error:', err);
        $('#campaignInfo').innerHTML = '<div class="rpg-error">Failed to load: ' + esc(err.message) + '</div>';
    }
}

function populateSessionSelector(detail) {
    var sel = $('#sessionSelect');
    sel.innerHTML = '<option value="">\u2014 Select Session \u2014</option>';
    (detail.sessions || []).forEach(function(s, i) {
        var opt = document.createElement('option');
        opt.value = s.session_id || s.file || ('session-' + i);
        opt.textContent = s.title || s.file || ('Session ' + (i + 1));
        sel.appendChild(opt);
    });
}

$('#sessionSelect').addEventListener('change', function(e) { if (e.target.value) loadTranscript(e.target.value); });

/* Transcript Loading */
async function loadTranscript(sessionId) {
    var container = $('#transcriptContent');
    container.innerHTML = '<div class="rpg-loading">Loading transcript\u2026</div>';
    try {
        var data = await apiFetch('/rpg/session/' + sessionId + '/transcript');
        if (!data.messages || data.messages.length === 0) {
            container.innerHTML = '<div style="color:var(--text-muted);padding:var(--space-md)">No messages in this session</div>';
            return;
        }
        container.innerHTML = data.messages.map(function(msg) {
            var rc = msg.role === 'user' ? 'msg-user' : 'msg-assistant';
            var rl = msg.role === 'user' ? 'üéÆ Player' : 'üé≤ Aria DM';
            var content = esc(msg.content).replace(/\n/g, '<br>');
            var time = msg.timestamp ? '<div class="msg-time">' + timeAgo(msg.timestamp) + '</div>' : '';
            return '<div class="msg ' + rc + '"><div class="msg-role">' + rl + '</div><div class="msg-content">' + content + '</div>' + time + '</div>';
        }).join('');
    } catch(err) {
        container.innerHTML = '<div class="rpg-error">Failed to load transcript: ' + esc(err.message) + '</div>';
    }
}

/* KG Visualization (vis-network) */
var TYPE_COLORS = {
    player_character: '#6366f1', npc: '#10b981', npc_companion: '#34d399',
    location: '#f59e0b', city: '#f97316', tavern: '#ea580c',
    dungeon_room: '#8b5cf6', monster: '#ef4444', enemy: '#dc2626',
    campaign: '#3b82f6', session: '#06b6d4', quest: '#a855f7',
    artifact: '#eab308', magical_construct: '#14b8a6', divine_event: '#fbbf24',
    concept: '#64748b', character: '#818cf8', person: '#2dd4bf'
};

async function loadKG(campaignId) {
    var container = $('#kg-container');
    container.innerHTML = '<div class="rpg-loading" style="padding-top:40vh">Loading knowledge graph\u2026</div>';
    try {
        var data = await apiFetch('/rpg/campaign/' + campaignId + '/kg');
        kgData = data;
        if (!data.nodes || data.nodes.length === 0) {
            container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-muted)">No KG data for this campaign</div>';
            return;
        }
        container.innerHTML = '';
        var nodes = new vis.DataSet(data.nodes.map(function(n) {
            return {
                id: n.id, label: n.label, group: n.group,
                color: { background: TYPE_COLORS[n.group] || n.color || '#64748b', border: 'rgba(255,255,255,0.1)', highlight: { background: '#f8fafc', border: TYPE_COLORS[n.group] || n.color || '#64748b' } },
                font: { color: '#f8fafc', size: 14, face: 'Inter' },
                title: n.title || n.label,
                shape: n.group === 'campaign' ? 'diamond' : (['location','city','tavern','dungeon_room'].indexOf(n.group) >= 0 ? 'square' : 'dot'),
                size: n.group === 'campaign' ? 30 : (['player_character','monster'].indexOf(n.group) >= 0 ? 22 : 16)
            };
        }));
        var edges = new vis.DataSet(data.edges.map(function(e, i) {
            return {
                id: 'edge-' + i, from: e.from, to: e.to, label: e.label || '', arrows: e.arrows || 'to',
                color: { color: 'rgba(255,255,255,0.15)', opacity: 0.6 },
                font: { color: '#64748b', size: 9, strokeWidth: 0, face: 'Inter' },
                smooth: { type: 'continuous' }
            };
        }));
        var options = {
            physics: { stabilization: { iterations: 150 }, barnesHut: { gravitationalConstant: -3000, springLength: 120, springConstant: 0.02 } },
            interaction: { hover: true, tooltipDelay: 200, navigationButtons: true, keyboard: true },
            layout: { improvedLayout: true },
            nodes: { borderWidth: 2, shadow: { enabled: true, color: 'rgba(0,0,0,0.3)', size: 8 } },
            edges: { width: 1.5, shadow: false }
        };
        kgNetwork = new vis.Network(container, { nodes: nodes, edges: edges }, options);
        kgNetwork.on('click', function(params) {
            if (params.nodes.length > 0) {
                var nodeId = params.nodes[0];
                var node = data.nodes.find(function(n) { return n.id === nodeId; });
                if (node) showEntityModal(node);
            }
        });
        buildKGLegend(data.nodes);
    } catch(err) {
        container.innerHTML = '<div class="rpg-error" style="margin:40px">Failed to load KG: ' + esc(err.message) + '</div>';
    }
}

function buildKGLegend(nodes) {
    var types = []; nodes.forEach(function(n) { if (types.indexOf(n.group) < 0) types.push(n.group); });
    var legend = $('#kgLegend'); legend.innerHTML = '';
    types.forEach(function(t) {
        var color = TYPE_COLORS[t] || '#64748b';
        legend.innerHTML += '<div class="kg-legend-item"><span class="kg-legend-dot" style="background:' + color + '"></span>' + t.replace(/_/g, ' ') + '</div>';
    });
}

/* Entity Modal */
function showEntityModal(node) {
    $('#modalTitle').textContent = node.label;
    var html = '<p><strong>Type:</strong> <span class="rpg-badge rpg-badge-type">' + esc(node.group) + '</span></p>';
    if (node.title) {
        html += '<pre style="margin-top:12px;padding:12px;background:var(--bg-primary);border-radius:var(--radius-md);font-size:0.85rem;white-space:pre-wrap;color:var(--text-secondary);font-family:var(--font-mono)">' + esc(node.title) + '</pre>';
    }
    if (node.properties && Object.keys(node.properties).length > 0) {
        html += '<h4 style="margin-top:12px;color:var(--accent-cyan)">Properties</h4><table>';
        for (var k in node.properties) {
            var v = node.properties[k];
            html += '<tr><th>' + esc(k) + '</th><td>' + esc(typeof v === 'object' ? JSON.stringify(v) : String(v)) + '</td></tr>';
        }
        html += '</table>';
    }
    $('#modalContent').innerHTML = html;
    $('#entityModal').classList.add('visible');
}

function closeModal() { $('#entityModal').classList.remove('visible'); }
$('#entityModal').addEventListener('click', function(e) { if (e.target === $('#entityModal')) closeModal(); });
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeModal(); });

/* Resume Campaign */
async function resumeCampaign() {
    if (!currentCampaign) { $('#resumeStatus').innerHTML = '<div class="rpg-error">Select a campaign first</div>'; return; }
    var btn = $('#resumeBtn'); btn.disabled = true; btn.textContent = '\u23F3 Loading\u2026';
    $('#resumeStatus').innerHTML = '<div class="rpg-loading">Preparing session\u2026</div>';
    try {
        var sessions = currentCampaign.sessions || [];
        if (sessions.length === 0) {
            $('#resumeStatus').innerHTML = '<div style="color:var(--warning);margin-top:var(--space-lg)">No previous sessions found. Start a new campaign session with Aria via chat!</div>';
            return;
        }
        await loadPreviouslyOn(currentCampaign.id);
        $('#resumeStatus').innerHTML = '<div style="color:var(--success);margin-top:var(--space-lg)">\u2705 Campaign ready! ' + sessions.length + ' session(s) found. Resume via chat or the API.</div>';
    } catch(err) {
        $('#resumeStatus').innerHTML = '<div class="rpg-error">Resume failed: ' + esc(err.message) + '</div>';
    } finally {
        btn.disabled = false; btn.textContent = 'üé≤ Resume Session';
    }
}

async function loadPreviouslyOn(campaignId) {
    try {
        var data = await apiFetch('/rpg/campaign/' + campaignId + '/kg?max_depth=2');
        if (!data.nodes || data.nodes.length === 0) return;
        var scenes = data.nodes.filter(function(n) { return ['session','divine_event','dungeon_room'].indexOf(n.group) >= 0; });
        if (scenes.length > 0) {
            $('#previouslyOnCard').style.display = 'block';
            $('#previouslyOn').innerHTML = scenes.map(function(s) {
                return '<div class="card" style="margin:8px 0;padding:12px"><strong style="color:var(--accent-primary)">' + esc(s.label) + '</strong> <span class="rpg-badge rpg-badge-type">' + esc(s.group) + '</span>' + (s.title ? '<p style="margin-top:6px;color:var(--text-secondary);font-size:0.85rem">' + esc(s.title) + '</p>' : '') + '</div>';
            }).join('');
        }
    } catch(err) { console.warn('Previously On failed:', err); }
}

/* Init */
document.addEventListener('DOMContentLoaded', function() { loadCampaigns(); });
</script>
{% endblock %}
