{% extends "base.html" %}
{% block title %}Memory Timeline{% endblock %}
{% block content %}
<div class="page-header">
    <h1>ðŸ“Š Memory Timeline & Heatmap</h1>
    <p class="subtitle">Temporal patterns of memory creation and TTL decay</p>
</div>

<div class="controls-bar" style="display:flex;gap:1rem;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;">
    <label style="color:var(--text-muted);font-size:0.85rem;">Lookback period:</label>
    <select id="hoursSelect" class="form-control" style="width:160px;" onchange="loadData()">
        <option value="24">Last 24 hours</option>
        <option value="168" selected>Last 7 days</option>
        <option value="336">Last 2 weeks</option>
        <option value="720">Last 30 days</option>
    </select>
    <button class="btn btn-sm btn-secondary" onclick="loadData()">â†» Refresh</button>
</div>

<div class="grid grid-2" style="gap:1.25rem;margin-bottom:1.25rem;">
    <div class="card">
        <div class="card-header"><h3>Memory Creation Over Time</h3></div>
        <div class="card-body" style="height:280px;"><canvas id="timelineChart"></canvas></div>
    </div>
    <div class="card">
        <div class="card-header"><h3>Importance Trend (Semantic)</h3></div>
        <div class="card-body" style="height:280px;"><canvas id="importanceChart"></canvas></div>
    </div>
</div>

<div class="card" style="margin-bottom:1.25rem;">
    <div class="card-header"><h3>Creation Heatmap â€” Hour of Day Ã— Day of Week</h3></div>
    <div class="card-body">
        <div id="heatmapContainer" style="overflow-x:auto;"></div>
    </div>
</div>

<div class="card">
    <div class="card-header"><h3>Working Memory TTL Countdowns</h3><span id="ttlCount" class="badge badge-secondary">0 items</span></div>
    <div class="card-body" style="height:280px;"><canvas id="ttlChart"></canvas></div>
</div>

<style>
.grid-2 { display:grid; grid-template-columns:1fr 1fr; }
@media(max-width:768px){ .grid-2 { grid-template-columns:1fr; } }
.heatmap-grid { display:grid; grid-template-columns:60px repeat(24,1fr); gap:2px; min-width:700px; font-size:0.72rem; }
.heatmap-cell { height:22px; border-radius:2px; background:var(--bg-elevated); cursor:default; transition:transform 0.1s; }
.heatmap-cell:hover { transform:scale(1.3); }
.heatmap-label { display:flex; align-items:center; color:var(--text-muted); font-size:0.72rem; }
.heatmap-hour-label { text-align:center; color:var(--text-muted); }
.ttl-bar-expired { background: #ef4444 !important; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
const API = window.API_BASE || '/api';
const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
let timelineChart, importanceChart, ttlChart;

async function loadData() {
    const hours = document.getElementById('hoursSelect').value;
    const res = await fetch(`${API}/memory-timeline?hours=${hours}`);
    const d = await res.json();
    renderTimeline(d);
    renderImportance(d);
    renderHeatmap(d.creation_heatmap);
    renderTtl(d.ttl_countdowns);
}

function tsLabels(buckets) {
    const step = buckets.length > 60 ? 4 : 1;
    return buckets.map((b, i) => {
        if (i % step !== 0) return '';
        const dt = new Date(b.t);
        return dt.toLocaleDateString('en', {month:'short',day:'numeric'}) + ' ' + dt.getHours() + 'h';
    });
}

function renderTimeline(d) {
    const semBuckets = d.semantic_timeline || [];
    const wmBuckets = d.working_memory_timeline || [];
    const thBuckets = d.thoughts_timeline || [];

    const allTimes = [...new Set([...semBuckets, ...wmBuckets, ...thBuckets].map(b => b.t))].sort();
    const labels = allTimes.map((t, i) => {
        const dt = new Date(t);
        return i % Math.max(1, Math.floor(allTimes.length / 12)) === 0
            ? dt.toLocaleDateString('en', {month:'short',day:'numeric'}) + ' ' + dt.getHours() + 'h'
            : '';
    });

    const toMap = buckets => Object.fromEntries(buckets.map(b => [b.t, b.count]));
    const semMap = toMap(semBuckets), wmMap = toMap(wmBuckets), thMap = toMap(thBuckets);

    const ctx = document.getElementById('timelineChart').getContext('2d');
    if (timelineChart) timelineChart.destroy();
    timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [
                { label: 'Semantic', data: allTimes.map(t => semMap[t] || 0), borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.15)', fill: true, tension: 0.3, pointRadius: 0 },
                { label: 'Working', data: allTimes.map(t => wmMap[t] || 0), borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.15)', fill: true, tension: 0.3, pointRadius: 0 },
                { label: 'Thoughts', data: allTimes.map(t => thMap[t] || 0), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.15)', fill: true, tension: 0.3, pointRadius: 0 },
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, interaction: { intersect: false }, plugins: { legend: { labels: { color: '#94a3b8' } } }, scales: { x: { ticks: { color: '#64748b', maxRotation: 0 } }, y: { ticks: { color: '#64748b' }, beginAtZero: true } } }
    });
}

function renderImportance(d) {
    const buckets = d.semantic_timeline || [];
    const labels = buckets.map((b, i) => {
        if (i % Math.max(1, Math.floor(buckets.length / 8)) !== 0) return '';
        const dt = new Date(b.t);
        return dt.toLocaleDateString('en', {month:'short',day:'numeric'});
    });
    const ctx2 = document.getElementById('importanceChart').getContext('2d');
    if (importanceChart) importanceChart.destroy();
    importanceChart = new Chart(ctx2, {
        type: 'line',
        data: {
            labels,
            datasets: [{ label: 'Avg Importance', data: buckets.map(b => b.avg_imp || 0), borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', fill: true, tension: 0.4, pointRadius: 2, borderWidth: 2 }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#64748b' } }, y: { min: 0, max: 1, ticks: { color: '#64748b' } } }, plugins: { legend: { labels: { color: '#94a3b8' } } } }
    });
}

function renderHeatmap(data) {
    const container = document.getElementById('heatmapContainer');
    if (!data || data.length === 0) { container.innerHTML = '<p style="color:var(--text-muted);">No data for this period.</p>'; return; }

    const maxCount = Math.max(...data.map(d => d.count), 1);
    const grid = Array.from({length: 7}, () => new Array(24).fill(0));
    data.forEach(d => { if (d.dow < 7 && d.hour < 24) grid[d.dow][d.hour] = d.count; });

    let html = '<div class="heatmap-grid">';
    html += '<div class="heatmap-label"></div>';
    for (let h = 0; h < 24; h++) html += `<div class="heatmap-hour-label">${h}</div>`;
    for (let dow = 0; dow < 7; dow++) {
        html += `<div class="heatmap-label">${DAYS[dow]}</div>`;
        for (let h = 0; h < 24; h++) {
            const cnt = grid[dow][h];
            const alpha = cnt ? (0.15 + 0.85 * cnt / maxCount).toFixed(2) : '0.05';
            html += `<div class="heatmap-cell" style="background:rgba(99,102,241,${alpha})" title="${DAYS[dow]} ${h}:00 â€” ${cnt} memories"></div>`;
        }
    }
    html += '</div>';
    container.innerHTML = html;
}

function renderTtl(items) {
    const el = document.getElementById('ttlCount');
    el.textContent = `${(items||[]).length} items`;
    const ctx = document.getElementById('ttlChart').getContext('2d');
    if (ttlChart) ttlChart.destroy();
    if (!items || items.length === 0) return;
    const labels = items.map(i => i.key.split('/').pop().substring(0, 20));
    const remaining = items.map(i => Math.max(0, i.remaining_hours));
    const total = items.map(i => i.ttl_hours || 24);
    const colors = items.map(i => {
        if (i.expired) return 'rgba(239,68,68,0.8)';
        const pct = i.remaining_hours / (i.ttl_hours || 1);
        if (pct < 0.25) return 'rgba(239,68,68,0.7)';
        if (pct < 0.5) return 'rgba(245,158,11,0.7)';
        return 'rgba(16,185,129,0.7)';
    });
    ttlChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { label: 'Remaining (h)', data: remaining, backgroundColor: colors, borderRadius: 4 },
                { label: 'Total TTL (h)', data: total, backgroundColor: 'rgba(255,255,255,0.05)', borderRadius: 4 },
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { labels: { color: '#94a3b8' } } }, scales: { x: { stacked: false, ticks: { color: '#64748b' } }, y: { ticks: { color: '#94a3b8', font: { size: 10 } } } } }
    });
}

loadData();
</script>
{% endblock %}
